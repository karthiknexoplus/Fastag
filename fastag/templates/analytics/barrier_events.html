{% extends "base.html" %}

{% block title %}Barrier Events - Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1 text-dark fw-bold">
                <i class="fas fa-door-open text-primary me-2"></i>
                Barrier Events
            </h1>
            <p class="text-muted mb-0">View and export all barrier open/close events</p>
        </div>
    </div>
    <!-- Analytics Navigation Menu -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-container">
                <div class="d-flex justify-content-center">
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('analytics.dashboard') }}" class="btn btn-outline-primary">
                            <i class="fas fa-chart-line me-2"></i>
                            Dashboard
                        </a>
                        <a href="{{ url_for('analytics.reports') }}" class="btn btn-outline-primary">
                            <i class="fas fa-file-alt me-2"></i>
                            Reports
                        </a>
                        <a href="{{ url_for('analytics.barrier_events') }}" class="btn btn-primary active">
                            <i class="fas fa-door-open me-2"></i>
                            Barrier Events
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Filters -->
    <form id="filter-form" class="row g-3 mb-3">
        <div class="col-md-2">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" name="start_date">
        </div>
        <div class="col-md-2">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" name="end_date">
        </div>
        <div class="col-md-2">
            <label class="form-label">Relay Number</label>
            <input type="number" class="form-control" name="relay_number" min="1">
        </div>
        <div class="col-md-2">
            <label class="form-label">User</label>
            <input type="text" class="form-control" name="user">
        </div>
        <div class="col-md-2">
            <label class="form-label">Action</label>
            <select class="form-select" name="action">
                <option value="">All</option>
                <option value="opened">Opened</option>
                <option value="closed">Closed</option>
            </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i>Filter</button>
        </div>
    </form>
    <div class="mb-3">
        <button id="export-btn" class="btn btn-success"><i class="fas fa-file-csv me-1"></i>Export CSV</button>
    </div>
    <!-- Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-modern table-bordered" id="barrier-events-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Relay</th>
                            <th>Action</th>
                            <th>User</th>
                            <th>Lane</th>
                            <th>Reader</th>
                            <th>Device</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <nav>
                <ul class="pagination justify-content-center" id="barrier-events-pagination"></ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let barrierEventsData = [];
let currentPage = 1;
const perPage = 50;

function renderBarrierEventsPage(page) {
    const tbody = document.querySelector('#barrier-events-table tbody');
    tbody.innerHTML = '';
    const start = (page - 1) * perPage;
    const end = start + perPage;
    const pageData = barrierEventsData.slice(start, end);
    if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data found.</td></tr>';
        return;
    }
    for (const row of pageData) {
        tbody.innerHTML += `<tr>
            <td>${row.timestamp || ''}</td>
            <td>${row.relay_number || ''}</td>
            <td>${row.action || ''}</td>
            <td>${row.user || ''}</td>
            <td>${row.lane_name || row.lane_id || ''}</td>
            <td>${row.reader_ip || row.reader_id || ''}</td>
            <td>${row.device_id || ''}</td>
            <td>${row.source || ''}</td>
        </tr>`;
    }
    renderBarrierEventsPagination();
}

function renderBarrierEventsPagination() {
    const totalPages = Math.ceil(barrierEventsData.length / perPage);
    const pagination = document.getElementById('barrier-events-pagination');
    pagination.innerHTML = '';
    if (totalPages <= 1) return;
    let prevClass = currentPage === 1 ? 'disabled' : '';
    let nextClass = currentPage === totalPages ? 'disabled' : '';
    pagination.innerHTML += `<li class="page-item ${prevClass}"><a class="page-link" href="#" onclick="gotoBarrierEventsPage(${currentPage-1});return false;">Previous</a></li>`;
    for (let i = 1; i <= totalPages; i++) {
        let active = i === currentPage ? 'active' : '';
        pagination.innerHTML += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="gotoBarrierEventsPage(${i});return false;">${i}</a></li>`;
    }
    pagination.innerHTML += `<li class="page-item ${nextClass}"><a class="page-link" href="#" onclick="gotoBarrierEventsPage(${currentPage+1});return false;">Next</a></li>`;
}

function gotoBarrierEventsPage(page) {
    const totalPages = Math.ceil(barrierEventsData.length / perPage);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderBarrierEventsPage(currentPage);
}

function fetchBarrierEvents(params = {}) {
    const url = new URL('/analytics/api/barrier-events', window.location.origin);
    Object.entries(params).forEach(([k, v]) => { if (v) url.searchParams.set(k, v); });
    fetch(url)
        .then(res => res.json())
        .then(data => {
            barrierEventsData = data;
            currentPage = 1;
            renderBarrierEventsPage(currentPage);
        });
}

document.getElementById('filter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;
    const params = Object.fromEntries(new FormData(form).entries());
    fetchBarrierEvents(params);
});

document.getElementById('export-btn').addEventListener('click', function() {
    const form = document.getElementById('filter-form');
    const params = Object.fromEntries(new FormData(form).entries());
    const url = new URL('/analytics/api/export-barrier-events', window.location.origin);
    Object.entries(params).forEach(([k, v]) => { if (v) url.searchParams.set(k, v); });
    window.open(url.toString(), '_blank');
});

document.addEventListener('DOMContentLoaded', function() {
    fetchBarrierEvents();
});
</script>
{% endblock %} 