{% extends 'base.html' %}
{% block title %}Response Pay - Banking{% endblock %}
{% block content %}
<style>
  .table-sm, .table-sm th, .table-sm td { font-size: 0.92rem; padding: 0.25rem 0.5rem; }
  .filter-bar { margin-bottom: 0.5rem; font-size: 0.98rem; }
  .action-icon-btn { background: none; border: none; padding: 0.2rem 0.4rem; font-size: 1.15rem; cursor: pointer; color: #764ba2; }
  .action-icon-btn:focus { outline: none; }
  .action-icon-btn[disabled] { color: #bbb; cursor: not-allowed; }
  #response, .table-sm { font-size: 0.95rem; }
  .table thead th { background: #f3e9ff; color: #764ba2; }
  .modal-content { font-size: 0.97rem; }
</style>
<div class="container mt-3">
  <h4 style="font-size:1.2rem; font-weight:600; margin-bottom:0.7rem; color:#764ba2;">Response Pay</h4>
  <div class="filter-bar d-flex align-items-center">
    <form method="get" class="d-flex align-items-center" style="gap:0.5rem;">
      <label for="date" class="me-2 mb-0">Show for date:</label>
      <input type="date" id="date" name="date" value="{{ selected_date }}" class="form-control form-control-sm" style="width: 160px;">
      <button type="submit" class="btn btn-outline-primary btn-sm">Filter</button>
    </form>
    <span class="ms-auto text-muted" style="font-size:0.93rem;">Powered by Onebee Technology Pvt Ltd</span>
  </div>
  <form method="post" id="statusForm">
    <table class="table table-bordered table-sm align-middle">
      <thead>
        <tr>
          <th style="width:2.5rem;">ID</th>
          <th>Msg ID</th>
          <th>Org ID</th>
          <th>Tag ID</th>
          <th>TID</th>
          <th>Vehicle No</th>
          <th>Amount</th>
          <th>Time</th>
          <th style="width:2.5rem; text-align:center;">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td>{{ log.id }}</td>
          <td>{{ log.msg_id }}</td>
          <td>{{ log.org_id }}</td>
          <td>{{ log.tag_id }}</td>
          <td>{{ log.tid }}</td>
          <td>{{ log.vehicle_reg_no }}</td>
          <td>{{ log.amount }}</td>
          <td>{{ log.request_time }}</td>
          <td style="text-align:center;">
            {% if status_map[log.id] is defined %}
              <button type="button" class="action-icon-btn" title="View Status" data-bs-toggle="modal" data-bs-target="#statusModal" data-logid="{{ log.id }}">
                <i class="fas fa-eye"></i>
              </button>
            {% else %}
              <button type="submit" name="log_id" value="{{ log.id }}" class="action-icon-btn" title="Get Status">
                <i class="fas fa-sync fa-spin-once"></i>
              </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>

  {# Status details and response block for modal extraction #}
  {% if status_list and log_id %}
    <h6 style="margin-top:1.2rem; color:#764ba2; font-weight:600;">Transaction Status Details</h6>
    <table class="table table-bordered table-sm align-middle" id="status-details-table">
      <thead>
        <tr>
          <th>Txn ID</th>
          <th>Result</th>
          <th>Err Code</th>
          <th>Txn Status</th>
          <th>Settle Date</th>
          <th>Lane ID</th>
          <th>Plaza ID</th>
        </tr>
      </thead>
      <tbody>
        {% for s in status_list %}
        <tr>
          <td>{{ s.txnId or s.get('txnId') }}</td>
          <td>{{ s.result or s.get('result') }}</td>
          <td>{{ s.errCode or s.get('errCode') }}</td>
          <td style="font-weight:600; color:{% if s.txnStatus == 'FAILURE' %}#d32f2f{% elif s.txnStatus == 'SUCCESS' %}#388e3c{% else %}#333{% endif %};">
            {{ s.txnStatus or s.get('txnStatus') }}
          </td>
          <td>{{ s.settleDate or s.get('settleDate') }}</td>
          <td>{{ s.laneId or s.get('laneId') }}</td>
          <td>{{ s.plazaId or s.get('plazaId') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
  {% if response and log_id %}
    <div id="status-response-block" style="margin-bottom:1rem;">
      {{ response|safe }}
    </div>
  {% endif %}

  <!-- Modal for status details -->
  <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background:#f3e9ff; color:#764ba2;">
          <h5 class="modal-title" id="statusModalLabel">Transaction Status Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalStatusContent">
          <div class="text-center text-muted">Loading...</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Modal status loader
    document.addEventListener('DOMContentLoaded', function() {
      var statusModal = document.getElementById('statusModal');
      statusModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var logId = button.getAttribute('data-logid');
        var modalBody = document.getElementById('modalStatusContent');
        modalBody.innerHTML = '<div class="text-center text-muted">Loading...</div>';
        fetch(`?log_id=${logId}&date={{ selected_date }}`)
          .then(resp => resp.text())
          .then(html => {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var statusTable = doc.getElementById('status-details-table');
            var responseBlock = doc.getElementById('status-response-block');
            modalBody.innerHTML = '';
            if (responseBlock) {
              modalBody.innerHTML += responseBlock.outerHTML;
            }
            if (statusTable) {
              modalBody.innerHTML += statusTable.outerHTML;
            }
            if (!statusTable && !responseBlock) {
              modalBody.innerHTML = '<div class="text-center text-muted">No status found.</div>';
            }
          });
      });
    });
  </script>
{% endblock %} 