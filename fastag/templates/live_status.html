{% extends 'base.html' %}

{% block title %}Live Status - FASTag Parking{% endblock %}

{% block head %}
<style>
    .ts-table {
        width: 100%;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 12px rgba(80,80,160,0.07);
        border-collapse: separate;
        border-spacing: 0;
        overflow: hidden;
        font-size: 0.97rem;
    }
    .ts-table th, .ts-table td {
        padding: 0.7rem 1rem;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
        background: white;
    }
    .ts-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #764ba2;
        border-bottom: 2px solid #e9ecef;
        font-size: 0.98rem;
    }
    .ts-table tr.device-row:hover {
        background: #f3e9ff;
        cursor: pointer;
    }
    .ts-table tr.expanded-row {
        background: #f8f9fa;
    }
    .ts-status-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 0.5em;
        vertical-align: middle;
    }
    .ts-status-online { background: #28a745; }
    .ts-status-offline { background: #dc3545; }
    .ts-status-warning { background: #ffc107; }
    .ts-os-icon {
        font-size: 1.2em;
        margin-right: 0.3em;
        vertical-align: middle;
    }
    .ts-badge {
        display: inline-block;
        padding: 0.2em 0.7em;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
        margin-right: 0.3em;
        background: #e9ecef;
        color: #764ba2;
    }
    .ts-badge-ssh { background: #e0f7fa; color: #00796b; }
    .ts-badge-funnel { background: #f3e9ff; color: #764ba2; }
    .ts-ip-pop {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(80,80,160,0.10);
        padding: 1rem;
        position: absolute;
        z-index: 1000;
        min-width: 260px;
        font-size: 0.95em;
        display: none;
    }
    .ts-ip-link {
        color: #764ba2;
        text-decoration: underline dotted;
        cursor: pointer;
        font-family: 'Courier New', monospace;
        font-size: 0.97em;
        margin-right: 0.3em;
    }
    .ts-chevron {
        font-size: 1.1em;
        color: #888;
        margin-left: 0.5em;
        transition: transform 0.2s;
    }
    .ts-chevron.expanded {
        transform: rotate(90deg);
    }
    @media (max-width: 900px) {
        .ts-table th, .ts-table td { padding: 0.5rem 0.5rem; }
        .ts-table { font-size: 0.93rem; }
    }
    @media (max-width: 600px) {
        .ts-table, .ts-table thead, .ts-table tbody, .ts-table th, .ts-table td, .ts-table tr {
            display: block;
        }
        .ts-table th { display: none; }
        .ts-table td { border: none; border-bottom: 1px solid #f0f0f0; }
        .ts-table tr.device-row { margin-bottom: 1.2em; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1 text-dark fw-bold">
                <i class="fas fa-wifi text-primary me-2"></i>
                Live Status
            </h1>
            <p class="text-muted mb-0">Tailscale network device status (table view)</p>
        </div>
        <button class="btn refresh-btn" onclick="refreshStatus()" id="refreshBtn">
            <i class="fas fa-sync-alt me-2"></i>
            <span class="refresh-text">Refresh Status</span>
            <span class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
            </span>
        </button>
    </div>

    <div class="table-responsive">
        <table class="ts-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>IP(s)</th>
                    <th>Version</th>
                    <th>OS</th>
                    <th>Status</th>
                    <th>Last Seen</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <!-- Self Device -->
                {% if status_data.Self %}
                <tr class="device-row" onclick="toggleRow('self')">
                    <td>
                        <span class="ts-os-icon {{ get_os_icon(status_data.Self.OS) }}"></span>
                        <b>{{ status_data.Self.HostName }}</b>
                        <div class="text-muted small">{{ status_data.Self.DNSName }}</div>
                    </td>
                    <td>
                        {% for ip in status_data.Self.TailscaleIPs %}
                        <span class="ts-ip-link" onclick="showIpPop(event, '{{ ip }}', 'self')">{{ ip }}</span>
                        {% endfor %}
                    </td>
                    <td>{{ status_data.Version }}</td>
                    <td>{{ status_data.Self.OS|title }}</td>
                    <td>
                        <span class="ts-status-dot ts-status-online"></span>Online
                    </td>
                    <td>Now</td>
                    <td><i class="fas fa-chevron-right ts-chevron" id="chevron-self"></i></td>
                </tr>
                <tr class="expanded-row" id="row-self" style="display:none;">
                    <td colspan="7">
                        <div class="row">
                            <div class="col-md-6">
                                <b>Device ID:</b> {{ status_data.Self.ID }}<br>
                                <b>Created:</b> {{ format_timestamp(status_data.Self.Created) }}<br>
                                <b>Key Expiry:</b> {{ format_timestamp(status_data.Self.KeyExpiry) }}<br>
                                <b>Received:</b> {{ format_bytes(status_data.Self.RxBytes) }}<br>
                                <b>Sent:</b> {{ format_bytes(status_data.Self.TxBytes) }}<br>
                                <b>Capabilities:</b>
                                {% for cap in status_data.Self.Capabilities %}
                                    <span class="ts-badge">{{ cap.split('/')[-1] }}</span>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <b>Allowed IPs:</b><br>
                                {% for aip in status_data.Self.AllowedIPs %}
                                    <span class="ts-badge">{{ aip }}</span>
                                {% endfor %}
                                <br><b>Peer API URLs:</b><br>
                                {% for url in status_data.Self.PeerAPIURL %}
                                    <span class="ts-badge">{{ url }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endif %}
                <!-- Peer Devices -->
                {% for peer_key, peer in status_data.Peer.items() %}
                <tr class="device-row" onclick="toggleRow('{{ peer.ID }}')">
                    <td>
                        <span class="ts-os-icon {{ get_os_icon(peer.OS) }}"></span>
                        <b>{{ peer.HostName }}</b>
                        <div class="text-muted small">{{ peer.DNSName }}</div>
                    </td>
                    <td>
                        {% for ip in peer.TailscaleIPs %}
                        <span class="ts-ip-link" onclick="showIpPop(event, '{{ ip }}', '{{ peer.ID }}')">{{ ip }}</span>
                        {% endfor %}
                    </td>
                    <td>{{ status_data.Version }}</td>
                    <td>{{ peer.OS|title }}</td>
                    <td>
                        <span class="ts-status-dot ts-status-{{ get_status_color(peer.Online, peer.Active) }}"></span>
                        {% if peer.Online and peer.Active %}Online{% elif peer.Online %}Connected{% else %}Offline{% endif %}
                        {% if peer.Expired %}<span class="ts-badge ts-badge-warning">Expired</span>{% endif %}
                        {% if peer.SSH %}<span class="ts-badge ts-badge-ssh">SSH</span>{% endif %}
                        {% if peer.Funnel %}<span class="ts-badge ts-badge-funnel">Funnel</span>{% endif %}
                    </td>
                    <td>{{ format_timestamp(peer.LastSeen) }}</td>
                    <td><i class="fas fa-chevron-right ts-chevron" id="chevron-{{ peer.ID }}"></i></td>
                </tr>
                <tr class="expanded-row" id="row-{{ peer.ID }}" style="display:none;">
                    <td colspan="7">
                        <div class="row">
                            <div class="col-md-6">
                                <b>Device ID:</b> {{ peer.ID }}<br>
                                <b>Created:</b> {{ format_timestamp(peer.Created) }}<br>
                                <b>Key Expiry:</b> {{ format_timestamp(peer.KeyExpiry) }}<br>
                                <b>Received:</b> {{ format_bytes(peer.RxBytes) }}<br>
                                <b>Sent:</b> {{ format_bytes(peer.TxBytes) }}<br>
                                <b>Capabilities:</b>
                                {% for cap in peer.Capabilities %}
                                    <span class="ts-badge">{{ cap.split('/')[-1] }}</span>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <b>Allowed IPs:</b><br>
                                {% for aip in peer.AllowedIPs %}
                                    <span class="ts-badge">{{ aip }}</span>
                                {% endfor %}
                                <br><b>Peer API URLs:</b><br>
                                {% for url in peer.PeerAPIURL %}
                                    <span class="ts-badge">{{ url }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div id="ip-popover" class="ts-ip-pop"></div>
</div>

<script>
function refreshStatus() {
    const btn = document.getElementById('refreshBtn');
    btn.classList.add('loading');
    fetch('/api/live_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to refresh status: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error refreshing status:', error);
            alert('Failed to refresh status. Please try again.');
        })
        .finally(() => {
            btn.classList.remove('loading');
        });
}

function toggleRow(id) {
    const row = document.getElementById('row-' + id);
    const chevron = document.getElementById('chevron-' + id);
    if (row.style.display === 'none' || row.style.display === '') {
        row.style.display = '';
        chevron.classList.add('expanded');
    } else {
        row.style.display = 'none';
        chevron.classList.remove('expanded');
    }
}

function showIpPop(event, ip, id) {
    event.stopPropagation();
    const pop = document.getElementById('ip-popover');
    pop.innerHTML = `<b>IP:</b> ${ip}<br><button class='btn btn-sm btn-outline-secondary mt-2' onclick='copyIp("${ip}")'>Copy</button>`;
    pop.style.display = 'block';
    pop.style.left = (event.pageX + 10) + 'px';
    pop.style.top = (event.pageY - 10) + 'px';
    document.addEventListener('click', hideIpPop, { once: true });
}
function hideIpPop() {
    document.getElementById('ip-popover').style.display = 'none';
}
function copyIp(ip) {
    navigator.clipboard.writeText(ip);
    alert('Copied: ' + ip);
    hideIpPop();
}
// Auto-refresh every 30 seconds
setInterval(() => {
    fetch('/api/live_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update timestamp or trigger reload if needed
                console.log('Status updated:', data.timestamp);
            }
        })
        .catch(error => {
            console.error('Auto-refresh error:', error);
        });
}, 30000);
</script>
{% endblock %} 