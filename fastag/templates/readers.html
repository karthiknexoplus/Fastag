{% extends 'base.html' %}
{% block title %}Readers - FASTag Parking{% endblock %}
{% block content %}
<div class="container-fluid" style="max-width: 700px;">
    <h2 class="mb-4 fs-4">
        <i class="fas fa-microchip fastag-menu-icon"></i><span class="fastag-menu-label">Readers for Lane: <span style="color: #764ba2;">{{ lane['lane_name'] }}</span></span>
    </h2>
    {% if readers|length < 2 %}
    <form method="POST" class="card p-3 mb-4 shadow-sm border-0 needs-validation" novalidate>
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <label class="form-label fastag-form-label">
                    <i class="fas fa-microchip fastag-form-icon"></i>MAC Address
                </label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-microchip"></i></span>
                    <input type="text" name="mac_address" id="mac_address" class="form-control fs-6" required placeholder="e.g. 001A2B3C4D5E" maxlength="17" oninput="formatMAC(this)">
                    <div class="invalid-feedback">Please enter a MAC address.</div>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label fastag-form-label">
                    <i class="fas fa-sign-in-alt fastag-form-icon"></i>Type
                </label>
                <select name="type" class="form-select fs-6" required>
                    {% set has_entry = false %}
                    {% set has_exit = false %}
                    {% for r in readers %}
                        {% if r['type'] == 'entry' %}{% set has_entry = true %}{% endif %}
                        {% if r['type'] == 'exit' %}{% set has_exit = true %}{% endif %}
                    {% endfor %}
                    {% if not has_entry %}<option value="entry">Entry</option>{% endif %}
                    {% if not has_exit %}<option value="exit">Exit</option>{% endif %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fastag-form-label">
                    <i class="fas fa-wifi fastag-form-icon"></i>Reader IP
                </label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-wifi"></i></span>
                    <input type="text" name="reader_ip" id="reader_ip" class="form-control fs-6" required placeholder="e.g. 192168001" maxlength="15" oninput="formatIP(this)">
                    <div class="invalid-feedback">Please enter a reader IP.</div>
                </div>
            </div>
            <div class="col-md-1 text-end align-self-end">
                <button type="submit" class="btn rounded-pill fs-6" style="background: #764ba2; color: white; border: none;">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </form>
    {% endif %}
    <div class="card p-3 shadow-sm border-0">
        <h5 class="mb-3 fs-5">
            <i class="fas fa-list fastag-menu-icon"></i><span class="fastag-menu-label">Readers</span>
        </h5>
        <div class="table-responsive">
            <table class="table table-bordered align-middle fs-6">
                <thead class="table-light">
                    <tr>
                        <th><i class="fas fa-sign-in-alt"></i> Type</th>
                        <th><i class="fas fa-microchip"></i> MAC Address</th>
                        <th><i class="fas fa-wifi"></i> Reader IP</th>
                        <th style="width:70px;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in readers %}
                    <tr>
                        <td>{{ r['type']|capitalize }}</td>
                        <td><span class="badge fs-6" style="background: #764ba2; color: white; font-size:0.95em;">{{ r['mac_address'] }}</span></td>
                        <td>{{ r['reader_ip'] }}</td>
                        <td class="text-center">
                            <a href="{{ url_for('readers.edit_reader', id=r['id']) }}" class="me-2" title="Edit" style="color: #764ba2;">
                                <i class="fas fa-pen-to-square" style="font-size:1.05rem;"></i>
                            </a>
                            <form method="POST" action="{{ url_for('readers.delete_reader', id=r['id']) }}" style="display:inline;">
                                <button type="submit" class="btn btn-link p-0 m-0 align-baseline" title="Delete" onclick="return confirm('Delete this reader?');" style="color: #dc3545;">
                                    <i class="fas fa-trash-alt" style="font-size:1.05rem;"></i>
                                </button>
                            </form>
                            <button type="button" class="btn btn-link p-0 m-0 align-baseline open-barrier-btn" data-reader-id="{{ r['id'] }}" title="Open Barrier" style="color: #28a745;">
                                <i class="fas fa-door-open" style="font-size:1.05rem;"></i>
                            </button>
                            <button type="button" class="btn btn-link p-0 m-0 align-baseline rfpower-btn" data-reader-id="{{ r['id'] }}" data-reader-ip="{{ r['reader_ip'] }}" title="RF Power" style="color: #17a2b8;">
                                <i class="fas fa-broadcast-tower" style="font-size:1.05rem;"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="text-center text-muted">No readers for this lane.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- RF Power Modal -->
    <div class="modal fade" id="rfpowerModal" tabindex="-1" aria-labelledby="rfpowerModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header" style="background: #764ba2; color: white;">
            <h5 class="modal-title" id="rfpowerModalLabel"><i class="fas fa-broadcast-tower me-2"></i>RF Power Control</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="rfpower-modal-form">
              <input type="hidden" id="modal-reader-id">
              <div class="mb-3">
                <label class="form-label fastag-form-label">
                    <i class="fas fa-wifi fastag-form-icon"></i>Reader IP
                </label>
                <input type="text" class="form-control" id="modal-reader-ip" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label fastag-form-label">
                    <i class="fas fa-broadcast-tower fastag-form-icon"></i>Current RF Power
                </label>
                <input type="text" class="form-control" id="modal-current-rf" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label fastag-form-label">
                    <i class="fas fa-sliders-h fastag-form-icon"></i>Set New RF Power (1-30)
                </label>
                <input type="number" class="form-control" id="modal-new-rf" min="1" max="30" required>
              </div>
              <div id="modal-rfpower-feedback" class="mb-2"></div>
              <button type="submit" class="btn" style="background: #764ba2; color: white; border: none;">
                  <i class="fas fa-save me-1"></i>Set RF Power
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-3">
        <a href="{{ url_for('lanes.lanes', location_id=lane['location_id']) }}" class="btn fs-6" style="background: #4b2e83; color: white; border: none;">
            <i class="fas fa-arrow-left me-1"></i> Back to Lanes
        </a>
    </div>
</div>

<style>
.card {
    border-radius: 15px;
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-2px);
}
.badge {
    border-radius: 20px;
    padding: 8px 16px;
}
.form-control:focus {
    border-color: #764ba2;
    box-shadow: 0 0 0 0.2rem rgba(118, 75, 162, 0.25);
}
.btn:hover {
    background: #4b2e83 !important;
    color: white !important;
}
.btn[style*="background: #4b2e83"]:hover {
    background: #3a1f6b !important;
    color: white !important;
}
</style>

<script>
function formatMAC(input) {
    let value = input.value.replace(/[^0-9A-Fa-f]/g, '');
    value = value.substring(0, 12);
    let formatted = '';
    for (let i = 0; i < value.length; i++) {
        if (i > 0 && i % 2 === 0) {
            formatted += ':';
        }
        formatted += value[i];
    }
    input.value = formatted.toUpperCase();
}
function formatIP(input) {
    let value = input.value.replace(/[^0-9]/g, '');
    value = value.substring(0, 12);
    let formatted = '';
    for (let i = 0; i < value.length; i++) {
        if (i > 0 && i % 3 === 0) {
            formatted += '.';
        }
        formatted += value[i];
    }
    input.value = formatted;
}
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.open-barrier-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const readerId = btn.getAttribute('data-reader-id');
      console.log('Open Barrier clicked, readerId:', readerId); // Debug log
      fetch(`/readers/${readerId}/open-barrier`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Barrier opened for Reader ' + readerId);
        } else {
          alert('Failed to open barrier: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(err => {
        alert('Error: ' + err);
      });
    });
  });
  // RF Power Modal logic
  const rfpowerModal = new bootstrap.Modal(document.getElementById('rfpowerModal'));
  document.querySelectorAll('.rfpower-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const readerId = btn.getAttribute('data-reader-id');
      const readerIp = btn.getAttribute('data-reader-ip');
      document.getElementById('modal-reader-id').value = readerId;
      document.getElementById('modal-reader-ip').value = readerIp;
      document.getElementById('modal-new-rf').value = '';
      document.getElementById('modal-rfpower-feedback').innerHTML = '';
      // Fetch current RF power
      fetch(`/api/rfid/rfpower?reader=${readerId}`)
        .then(res => res.json())
        .then(data => {
          if (data.rf_power !== undefined) {
            document.getElementById('modal-current-rf').value = data.rf_power;
          } else {
            document.getElementById('modal-current-rf').value = '';
            document.getElementById('modal-rfpower-feedback').innerHTML = `<div class='alert alert-danger'>Unable to fetch RF Power: ${data.error || 'Unknown error'}</div>`;
          }
        })
        .catch(() => {
          document.getElementById('modal-current-rf').value = '';
          document.getElementById('modal-rfpower-feedback').innerHTML = `<div class='alert alert-danger'>Network failure: Unable to fetch RF Power.</div>`;
        });
      rfpowerModal.show();
    });
  });
  document.getElementById('rfpower-modal-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const readerId = parseInt(document.getElementById('modal-reader-id').value);
    const new_rf = parseInt(document.getElementById('modal-new-rf').value);
    const feedback = document.getElementById('modal-rfpower-feedback');
    feedback.innerHTML = '';
    fetch('/api/rfid/rfpower', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reader_id: readerId, rf_power: new_rf })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        // Use readerIdToType to get the type string
        const typeStr = readerIdToType[readerId] || 'Unknown';
        feedback.innerHTML = `<div class='alert alert-success'>RF Power set to ${data.rf_power} for ${typeStr} Reader.</div>`;
        document.getElementById('modal-current-rf').value = data.rf_power;
      } else {
        feedback.innerHTML = `<div class='alert alert-danger'>${data.error || 'Failed to set RF Power.'}</div>`;
      }
    })
    .catch(() => {
      feedback.innerHTML = `<div class='alert alert-danger'>Network error. Please try again.</div>`;
    });
  });
});
</script>
{% endblock %} 