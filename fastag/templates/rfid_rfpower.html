{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0"><i class="fas fa-broadcast-tower me-2"></i>RFID Reader RF Power Control</h3>
        </div>
        <div class="card-body">
            <form id="rfpower-form" class="row g-3">
                <div class="col-md-4">
                    <label for="reader" class="form-label">Select Reader</label>
                    <select class="form-select" id="reader" name="reader" required>
                        <option value="1">Reader 1</option>
                        <option value="2">Reader 2</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="current-rf" class="form-label">Current RF Power</label>
                    <input type="text" class="form-control" id="current-rf" readonly>
                </div>
                <div class="col-md-4">
                    <label for="new-rf" class="form-label">push  New RF Power (1-30)</label>
                    <input type="number" class="form-control" id="new-rf" name="new_rf" min="1" max="30" placeholder="Enter value" required>
                </div>
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="fas fa-save me-1"></i>Set RF Power</button>
                </div>
            </form>
            <div id="rfpower-feedback" class="mt-3"></div>
        </div>
    </div>
</div>
<script>
function fetchCurrentRF() {
    const reader_id = document.getElementById('reader').value;
    fetch(`/api/rfid/rfpower?reader=${reader_id}`)
        .then(res => res.json())
        .then(data => {
            if (data.rf_power !== undefined) {
                document.getElementById('current-rf').value = data.rf_power;
            } else {
                document.getElementById('current-rf').value = 'Error';
            }
        });
}

document.getElementById('reader').addEventListener('change', fetchCurrentRF);
document.addEventListener('DOMContentLoaded', fetchCurrentRF);

document.getElementById('rfpower-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const reader_id = Number(document.getElementById('reader').value);
    const new_rf = Number(document.getElementById('new-rf').value);
    const feedback = document.getElementById('rfpower-feedback');
    feedback.innerHTML = '';
    if (!Number.isInteger(reader_id) || !Number.isInteger(new_rf) || new_rf < 1 || new_rf > 30) {
        feedback.innerHTML = "<div class='alert alert-danger'>Please select a reader and enter a valid RF Power (1-30).</div>";
        return;
    }
    fetch('/api/rfid/rfpower', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reader_id, rf_power: new_rf })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            feedback.innerHTML = `<div class='alert alert-success'>RF Power set to ${data.rf_power} for Reader ${data.reader_id}.`;
            fetchCurrentRF();
        } else {
            feedback.innerHTML = `<div class='alert alert-danger'>${data.error || 'Failed to set RF Power.'}</div>`;
        }
    })
    .catch(() => {
        feedback.innerHTML = `<div class='alert alert-danger'>Network error. Please try again.</div>`;
    });
});
</script>
{% endblock %} 