<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Dashboard</title>
    <meta name="theme-color" content="#f7f7fa">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            background: #f7f7fa;
            position: relative;
            overflow-x: hidden;
        }
        .dashboard-container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding-top: 2.2rem;
            padding-bottom: 6.2rem;
            position: relative;
            z-index: 1;
        }
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 2px 12px rgba(80,80,160,0.10);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 0.7rem;
        }
        .avatar img {
            width: 60px;
            height: 60px;
            object-fit: cover;
        }
        .greeting-row {
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }
        .greeting {
            font-size: 1.35rem;
            font-weight: 700;
            color: #222;
            text-align: center;
        }


        .vehicle-info {
            font-size: 1.13rem;
            font-weight: 700;
            color: #764ba2;
            text-align: center;
            margin-top: 0.1rem;
            margin-bottom: 0.2rem;
            letter-spacing: 0.01em;
        }

        .feature-desc {
            width: 100%;
            text-align: center;
            font-size: 1.13rem;
            font-weight: 700;
            margin-bottom: 0.7rem;
            background: linear-gradient(90deg, #764ba2 0%, #ffe082 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .feature-scroll {
            display: flex;
            gap: 1.1rem;
            overflow-x: auto;
            padding: 0.7rem 0 1.2rem 0.2rem;
            margin-bottom: 1.2rem;
            scrollbar-width: none;
        }
        .feature-scroll::-webkit-scrollbar {
            display: none;
        }
        .feature-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 74px;
            min-height: 74px;
            max-width: 74px;
            max-height: 74px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff 60%, #f3e9ff 100%);
            box-shadow: 0 2px 8px rgba(80,80,160,0.08);
            border: none;
            outline: none;
            transition: all 0.2s ease;
            cursor: pointer;
            margin-bottom: 0.1rem;
            transform: scale(1);
        }
        .feature-btn:hover {
            box-shadow: 0 6px 16px rgba(118,75,162,0.15);
            background: linear-gradient(135deg, #f3e9ff 60%, #fff 100%);
            transform: scale(1.1);
        }
        .feature-btn:active, .feature-btn:focus {
            box-shadow: 0 4px 12px rgba(118,75,162,0.10);
            background: linear-gradient(135deg, #f3e9ff 60%, #fff 100%);
            transform: translateY(2px) scale(0.95);
        }
        .feature-btn .icon {
            font-size: 1.45rem;
            background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: #764ba2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .feature-btn .label {
            font-size: 0.93rem;
            font-weight: 600;
            color: #222;
            letter-spacing: 0.01em;
            text-align: center;
            white-space: normal;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .feature-slider {
            width: 100%;
            margin-bottom: 1.5rem;
        }
        .feature-slider .carousel-inner {
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 2px 12px rgba(80,80,160,0.10);
        }
        .feature-slider .carousel-item {
            display: none;
            align-items: center;
            justify-content: flex-start;
            gap: 1.1rem;
            min-height: 56px;
            padding: 1.1rem 1.5rem;
            width: 100%;
            flex-wrap: wrap;
        }
        .feature-slider .carousel-item.active,
        .feature-slider .carousel-item-next,
        .feature-slider .carousel-item-prev {
            display: flex;
        }
        .feature-slider .icon {
            font-size: 1.3rem;
            color: #764ba2;
        }
        .feature-slider .desc {
            font-size: 1.13rem;
            color: #333;
            font-weight: 600;
            white-space: normal;
            word-break: break-word;
        }
        .feature-slider .carousel-indicators {
            position: static;
            margin-top: 0.5rem;
            margin-bottom: 0;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }
        .feature-slider .carousel-indicators [data-bs-target] {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e0d7f7;
            border: none;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 8px rgba(118,75,162,0.10);
        }
        .feature-slider .carousel-indicators .active {
            background: linear-gradient(90deg, #764ba2 0%, #ffe082 100%);
            box-shadow: 0 4px 12px rgba(118,75,162,0.18);
        }
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.1rem;
            width: 100%;
            margin-bottom: 2.2rem;
            margin-top: 1.5rem;
        }
        .analytics-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(80,80,160,0.10);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            padding: 1.1rem 1.1rem 0.9rem 1.1rem;
            min-height: 70px;
            text-align: left;
            transition: box-shadow 0.18s, transform 0.12s, background 0.18s;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .analytics-card:active, .analytics-card:focus {
            box-shadow: 0 6px 18px rgba(118,75,162,0.13);
            background: #f3e9ff;
            transform: translateY(2px) scale(0.98);
        }
        .analytics-card .icon {
            font-size: 1.15rem;
            color: #764ba2;
            margin-bottom: 0.3rem;
            background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: #764ba2; /* Fallback for non-webkit browsers */
        }
        .analytics-card .icon i {
            font-size: 1.45rem;
            background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: #764ba2;
            display: inline-block;
        }
        .analytics-card.recent-entries .icon i {
            background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
            color: #42e695;
        }
        .analytics-card.recent-exits .icon i {
            background: linear-gradient(135deg, #ff512f 0%, #dd2476 100%);
            color: #ff512f;
        }
        .analytics-card.denied-fastag .icon i {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            color: #f7971e;
        }
        .analytics-card.most-denied .icon i {
            background: linear-gradient(135deg, #c471f5 0%, #fa71cd 100%);
            color: #c471f5;
        }
        .analytics-card .label {
            font-size: 0.93rem;
            font-weight: 600;
            color: #222;
            margin-bottom: 0.1rem;
        }
        .analytics-card .value {
            font-size: 1.13rem;
            font-weight: 700;
            color: #764ba2;
            display: inline-block;
        }
        .analytics-card.loading .value {
            color: #ccc;
        }
        .analytics-card.loading .icon {
            opacity: 0.5;
        }
        .fab-center {
            position: fixed;
            left: 50%;
            bottom: 2.1rem;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #764ba2 0%, #ffe082 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 58px;
            height: 58px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.1rem;
            box-shadow: 0 6px 18px rgba(118,75,162,0.13);
            z-index: 1003;
            transition: background 0.18s, color 0.18s, transform 0.12s;
        }
        .fab-center:active, .fab-center:focus {
            background: linear-gradient(90deg, #ffe082 0%, #764ba2 100%);
            color: #764ba2;
            transform: translateX(-50%) translateY(2px) scale(0.98);
        }
        .logout-btn-gradient {
            position: fixed;
            left: 1.5rem;
            top: 1.5rem;
            background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 0 4px 12px rgba(118,75,162,0.25);
            z-index: 1003;
            transition: all 0.18s;
            cursor: pointer;
        }
        .logout-btn-gradient:hover {
            background: linear-gradient(135deg, #ffe082 0%, #764ba2 100%);
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(118,75,162,0.35);
        }
        .logout-btn-gradient:active {
            transform: scale(0.95);
        }
        .action-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .action-card:active {
            transform: scale(0.98);
        }
        /* KYC Users Modal Text Wrapping */
        .kyc-address-cell {
            max-width: 200px;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            overflow-wrap: break-word;
        }
        #kycUsersListRecords table {
            table-layout: fixed;
            width: 100%;
        }
        #kycUsersListRecords table th,
        #kycUsersListRecords table td {
            padding: 0.5rem;
            vertical-align: top;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            overflow-wrap: break-word;
        }
        #kycUsersListRecords table th:nth-child(1) { width: 15%; } /* Name */
        #kycUsersListRecords table th:nth-child(2) { width: 15%; } /* FASTag ID */
        #kycUsersListRecords table th:nth-child(3) { width: 15%; } /* Vehicle Number */
        #kycUsersListRecords table th:nth-child(4) { width: 12%; } /* Contact */
        #kycUsersListRecords table th:nth-child(5) { width: 28%; } /* Address */
        #kycUsersListRecords table th:nth-child(6) { width: 7%; }  /* Edit */
        #kycUsersListRecords table th:nth-child(7) { width: 8%; }  /* Delete */
        .bottom-nav {
            position: fixed;
            left: 0; right: 0; bottom: 0;
            width: 100vw;
            background: #fff;
            box-shadow: 0 -2px 16px rgba(80,80,160,0.08);
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            padding: 0.5rem 0 0.3rem 0;
            z-index: 1002;
        }
        .bottom-nav-btn {
            background: none;
            border: none;
            outline: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #764ba2;
            font-size: 1.25rem;
            font-weight: 700;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 0;
            padding: 0.3rem 0.2rem;
            transform: scale(1);
            cursor: pointer;
        }
        .bottom-nav-btn:hover {
            color: #ffe082;
            transform: scale(1.1);
        }
        .bottom-nav-btn:active {
            transform: scale(0.95);
        }
        .bottom-nav-btn.active, .bottom-nav-btn:focus {
            color: #ffe082;
        }
        .bottom-nav-btn span {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.2rem;
            text-align: center;
            line-height: 1.1;
            white-space: nowrap;
        }
        .barrier-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(80,80,160,0.10);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            padding: 1.1rem 1.1rem 0.9rem 1.1rem;
            min-height: 70px;
            text-align: left;
            transition: box-shadow 0.18s, transform 0.12s, background 0.18s;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .barrier-card:active, .barrier-card:focus {
            box-shadow: 0 6px 18px rgba(118,75,162,0.13);
            background: #f3e9ff;
            transform: translateY(2px) scale(0.98);
        }
        .barrier-relay-group {
            display: flex;
            gap: 1.2rem;
            justify-content: center;
            margin: 1.1rem 0 0.7rem 0;
        }
        .barrier-relay-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
        }
        .barrier-relay-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            margin-bottom: 0.2rem;
            border: 2px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: background 0.18s, border 0.18s;
        }
        .barrier-relay-dot.on {
            background: #28a745;
            color: #fff;
            border: 2px solid #28a745;
        }
        .barrier-relay-dot.off {
            background: #dc3545;
            color: #fff;
            border: 2px solid #dc3545;
        }
        .barrier-relay-dot.unknown {
            background: #bdbdbd;
            color: #fff;
            border: 2px solid #bdbdbd;
        }
        .barrier-relay-label {
            font-size: 0.85rem;
            color: #764ba2;
            font-weight: 600;
        }
        .barrier-relay-toggle {
            background: linear-gradient(90deg, #764ba2 0%, #ffe082 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 0.3rem 1.1rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.2rem;
            transition: background 0.18s, color 0.18s;
        }
        .barrier-relay-toggle:active {
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Dashboard</title>
    <meta name="theme-color" content="#f7f7fa">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            background: #f7f7fa;
            position: relative;
            overflow-x: hidden;
        }
        .dashboard-container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding-top: 2.2rem;
            padding-bottom: 6.2rem;
            position: relative;
            z-index: 1;
        }
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 2px 12px rgba(80,80,160,0.10);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 0.7rem;
        }
        .avatar img {
            width: 60px;
            height: 60px;
            object-fit: cover;
        }
        .greeting-row {
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }
        .greeting {
            font-size: 1.35rem;
            font-weight: 700;
            color: #222;
            text-align: center;
        }


        .vehicle-info {
            font-size: 1.13rem;
            font-weight: 700;
            color: #764ba2;
            text-align: center;
            margin-top: 0.1rem;
            margin-bottom: 0.2rem;
            letter-spacing: 0.01em;
        }

        .feature-desc {
            width: 100%;
            text-align: center;
            font-size: 1.13rem;
            font-weight: 700;
            margin-bottom: 0.7rem;
            background: linear-gradient(90deg, #764ba2 0%, #ffe082 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .feature-scroll {
            display: flex;
            gap: 1.1rem;
            overflow-x: auto;
            padding: 0.7rem 0 1.2rem 0.2rem;
            margin-bottom: 1.2rem;
            scrollbar-width: none;
        }
        .feature-scroll::-webkit-scrollbar {
            display: none;
        }
        .feature-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 74px;
            min-height: 74px;
            max-width: 74px;
            max-height: 74px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff 60%, #f3e9ff 100%);
            box-shadow: 0 2px 8px rgba(80,80,160,0.08);
            border: none;
            outline: none;
            transition: all 0.2s ease;
            cursor: pointer;
            margin-bottom: 0.1rem;
            transform: scale(1);
        }
        .feature-btn:hover {
            box-shadow: 0 6px 16px rgba(118,75,162,0.15);
            background: linear-gradient(135deg, #f3e9ff 60%, #fff 100%);
            transform: scale(1.1);
        }
        .feature-btn:active, .feature-btn:focus {
            box-shadow: 0 4px 12px rgba(118,75,162,0.10);
            background: linear-gradient(135deg, #f3e9ff 60%, #fff 100%);
            transform: translateY(2px) scale(0.95);
        }
        .feature-btn .icon {
            font-size: 1.45rem;
            background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: #764ba2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .feature-btn .label {
            font-size: 0.93rem;
            font-weight: 600;
            color: #222;
            letter-spacing: 0.01em;
            text-align: center;
            white-space: normal;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .feature-slider {
            width: 100%;
            margin-bottom: 1.5rem;
        }
        .feature-slider .carousel-inner {
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 2px 12px rgba(80,80,160,0.10);
        }
        .feature-slider .carousel-item {
            display: none;
            align-items: center;
            justify-content: flex-start;
            gap: 1.1rem;
            min-height: 56px;
            padding: 1.1rem 1.5rem;
            width: 100%;
            flex-wrap: wrap;
        }
        .feature-slider .carousel-item.active,
        .feature-slider .carousel-item-next,
        .feature-slider .carousel-item-prev {
            display: flex;
        }
        .feature-slider .icon {
            font-size: 1.3rem;
            color: #764ba2;
        }
        .feature-slider .desc {
            font-size: 1.13rem;
            color: #333;
            font-weight: 600;
            white-space: normal;
            word-break: break-word;
        }
        .feature-slider .carousel-indicators {
            position: static;
            margin-top: 0.5rem;
            margin-bottom: 0;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }
        .feature-slider .carousel-indicators [data-bs-target] {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e0d7f7;
            border: none;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 8px rgba(118,75,162,0.10);
        }
        .feature-slider .carousel-indicators .active {
            background: linear-gradient(90deg, #764ba2 0%, #ffe082 100%);
            box-shadow: 0 4px 12px rgba(118,75,162,0.18);
        }
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.1rem;
            width: 100%;
            margin-bottom: 2.2rem;
            margin-top: 1.5rem;
        }
        .analytics-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(80,80,160,0.10);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            padding: 1.1rem 1.1rem 0.9rem 1.1rem;
            min-height: 70px;
            text-align: left;
            transition: box-shadow 0.18s, transform 0.12s, background 0.18s;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .analytics-card:active, .analytics-card:focus {
            box-shadow: 0 6px 18px rgba(118,75,162,0.13);
            background: #f3e9ff;
            transform: translateY(2px) scale(0.98);
        }
        .analytics-card .icon {
            font-size: 1.15rem;
            color: #764ba2;
            margin-bottom: 0.3rem;
            background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: #764ba2; /* Fallback for non-webkit browsers */
        }
        .analytics-card .icon i {
            font-size: 1.45rem;
            background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: #764ba2;
            display: inline-block;
        }
        .analytics-card.recent-entries .icon i {
            background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
            color: #42e695;
        }
        .analytics-card.recent-exits .icon i {
            background: linear-gradient(135deg, #ff512f 0%, #dd2476 100%);
            color: #ff512f;
        }
        .analytics-card.denied-fastag .icon i {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            color: #f7971e;
        }
        .analytics-card.most-denied .icon i {
            background: linear-gradient(135deg, #c471f5 0%, #fa71cd 100%);
            color: #c471f5;
        }
        .analytics-card .label {
            font-size: 0.93rem;
            font-weight: 600;
            color: #222;
            margin-bottom: 0.1rem;
        }
        .analytics-card .value {
            font-size: 1.13rem;
            font-weight: 700;
            color: #764ba2;
            display: inline-block;
        }
        .analytics-card.loading .value {
            color: #ccc;
        }
        .analytics-card.loading .icon {
            opacity: 0.5;
        }
        .fab-center {
            position: fixed;
            left: 50%;
            bottom: 2.1rem;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #764ba2 0%, #ffe082 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 58px;
            height: 58px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.1rem;
            box-shadow: 0 6px 18px rgba(118,75,162,0.13);
            z-index: 1003;
            transition: background 0.18s, color 0.18s, transform 0.12s;
        }
        .fab-center:active, .fab-center:focus {
            background: linear-gradient(90deg, #ffe082 0%, #764ba2 100%);
            color: #764ba2;
            transform: translateX(-50%) translateY(2px) scale(0.98);
        }
        .logout-btn-gradient {
            position: fixed;
            left: 1.5rem;
            top: 1.5rem;
            background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 0 4px 12px rgba(118,75,162,0.25);
            z-index: 1003;
            transition: all 0.18s;
            cursor: pointer;
        }
        .logout-btn-gradient:hover {
            background: linear-gradient(135deg, #ffe082 0%, #764ba2 100%);
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(118,75,162,0.35);
        }
        .logout-btn-gradient:active {
            transform: scale(0.95);
        }
        .action-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .action-card:active {
            transform: scale(0.98);
        }
        /* KYC Users Modal Text Wrapping */
        .kyc-address-cell {
            max-width: 200px;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            overflow-wrap: break-word;
        }
        #kycUsersListRecords table {
            table-layout: fixed;
            width: 100%;
        }
        #kycUsersListRecords table th,
        #kycUsersListRecords table td {
            padding: 0.5rem;
            vertical-align: top;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            overflow-wrap: break-word;
        }
        #kycUsersListRecords table th:nth-child(1) { width: 15%; } /* Name */
        #kycUsersListRecords table th:nth-child(2) { width: 15%; } /* FASTag ID */
        #kycUsersListRecords table th:nth-child(3) { width: 15%; } /* Vehicle Number */
        #kycUsersListRecords table th:nth-child(4) { width: 12%; } /* Contact */
        #kycUsersListRecords table th:nth-child(5) { width: 28%; } /* Address */
        #kycUsersListRecords table th:nth-child(6) { width: 7%; }  /* Edit */
        #kycUsersListRecords table th:nth-child(7) { width: 8%; }  /* Delete */
        .bottom-nav {
            position: fixed;
            left: 0; right: 0; bottom: 0;
            width: 100vw;
            background: #fff;
            box-shadow: 0 -2px 16px rgba(80,80,160,0.08);
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            padding: 0.5rem 0 0.3rem 0;
            z-index: 1002;
        }
        .bottom-nav-btn {
            background: none;
            border: none;
            outline: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #764ba2;
            font-size: 1.25rem;
            font-weight: 700;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 0;
            padding: 0.3rem 0.2rem;
            transform: scale(1);
            cursor: pointer;
        }
        .bottom-nav-btn:hover {
            color: #ffe082;
            transform: scale(1.1);
        }
        .bottom-nav-btn:active {
            transform: scale(0.95);
        }
        .bottom-nav-btn.active, .bottom-nav-btn:focus {
            color: #ffe082;
        }
        .bottom-nav-btn span {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.2rem;
            text-align: center;
            line-height: 1.1;
            white-space: nowrap;
        }
        .barrier-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(80,80,160,0.10);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            padding: 1.1rem 1.1rem 0.9rem 1.1rem;
            min-height: 70px;
            text-align: left;
            transition: box-shadow 0.18s, transform 0.12s, background 0.18s;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .barrier-card:active, .barrier-card:focus {
            box-shadow: 0 6px 18px rgba(118,75,162,0.13);
            background: #f3e9ff;
            transform: translateY(2px) scale(0.98);
        }
        .barrier-relay-group {
            display: flex;
            gap: 1.2rem;
            justify-content: center;
            margin: 1.1rem 0 0.7rem 0;
        }
        .barrier-relay-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
        }
        .barrier-relay-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            margin-bottom: 0.2rem;
            border: 2px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: background 0.18s, border 0.18s;
        }
        .barrier-relay-dot.on {
            background: #28a745;
            color: #fff;
            border: 2px solid #28a745;
        }
        .barrier-relay-dot.off {
            background: #dc3545;
            color: #fff;
            border: 2px solid #dc3545;
        }
        .barrier-relay-dot.unknown {
            background: #bdbdbd;
            color: #fff;
            border: 2px solid #bdbdbd;
        }
        .barrier-relay-label {
            font-size: 0.85rem;
            color: #764ba2;
            font-weight: 600;
        }
        .barrier-relay-toggle {
            background: linear-gradient(90deg, #764ba2 0%, #ffe082 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 0.3rem 1.1rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.2rem;
            transition: background 0.18s, color 0.18s;
        }
        .barrier-relay-toggle:active {
            background: linear-gradient(90deg, #ffe082 0%, #764ba2 100%);
            color: #764ba2;
        }
        .analytics-card.recent-entries .icon {
            background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
        }
        .analytics-card.recent-exits .icon {
            background: linear-gradient(135deg, #ff512f 0%, #dd2476 100%);
        }
        .analytics-card.denied-fastag .icon {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        }
        .analytics-card.most-denied .icon {
            background: linear-gradient(135deg, #c471f5 0%, #fa71cd 100%);
        }
        .analytics-card .value {
            font-size: 0.98rem;
            font-weight: 600;
            margin-top: 0.2rem;
            display: inline-block;
        }
        .analytics-card.recent-entries .value {
            color: #42e695;
        }
        .analytics-card.recent-exits .value {
            color: #ff512f;
        }
        .analytics-card.denied-fastag .value {
            color: #f7971e;
        }
        .analytics-card.most-denied .value {
            color: #c471f5;
        }
        .analytics-card .icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.2rem;
            height: 2.2rem;
        }
        .analytics-card.recent-entries .icon i {
            color: #42e695;
        }
        .analytics-card.recent-exits .icon i {
            color: #ff512f;
        }
        .analytics-card.denied-fastag .icon i {
            color: #f7971e;
        }
        .analytics-card.most-denied .icon i {
            color: #c471f5;
        }
        .analytics-card .icon-gradient {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.2rem;
            height: 2.2rem;
            border-radius: 50%;
        }
        .analytics-card.recent-entries .icon-gradient {
            background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
        }
        .analytics-card.recent-exits .icon-gradient {
            background: linear-gradient(135deg, #ff512f 0%, #dd2476 100%);
        }
        .analytics-card.denied-fastag .icon-gradient {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        }
        .analytics-card.most-denied .icon-gradient {
            background: linear-gradient(135deg, #c471f5 0%, #fa71cd 100%);
        }
        .analytics-card .icon-gradient i {
            color: #fff;
            font-size: 1.45rem;
            display: inline-block;
        }
        .analytics-card.controller-status .icon i {
            color: #764ba2;
        }
        .analytics-card.controller-status .value {
            color: #764ba2;
        }
        .barrier-card .label {
            font-size: 0.93rem;
            font-weight: 700;
            color: #222;
            margin-bottom: 0.1rem;
        }
        .barrier-card .value {
            font-size: 0.98rem;
            font-weight: 600;
            color: #764ba2;
            margin-top: 0.2rem;
            display: inline-block;
        }
        @media (max-width: 600px) {
            .dashboard-container { padding-top: 1.1rem; max-width: 98vw; padding-bottom: 3.2rem; }
            .feature-scroll { gap: 0.7rem; padding-left: 0.1rem; }
            .analytics-grid { gap: 0.7rem; }
            .fab-center { width: 48px; height: 48px; font-size: 1.5rem; bottom: 1.2rem; }
            .logout-btn-gradient { width: 42px; height: 42px; font-size: 1.2rem; left: 1rem; top: 1rem; }
            .action-grid { grid-template-columns: 1fr; gap: 0.6rem; }
            #actionModal .modal-content-custom { max-width: 95vw; margin: 1rem; max-height: 90vh; }
            .action-card { padding: 0.6rem !important; }
            .action-card i { font-size: 1.3rem !important; }
            .action-card div { font-size: 0.85rem !important; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="avatar"><img src="https://cdn-icons-png.flaticon.com/512/147/147144.png" alt="Avatar"></div>
            <div class="greeting-row">
                <div class="greeting">Hi, {{ name }}!</div>
            </div>
            {% if vehicle %}
            <div class="vehicle-info">{{ vehicle }}</div>
            {% endif %}
        </div>
        <div class="feature-desc">All your FASTag Parking features at a glance</div>
        <div class="feature-scroll">
            <button class="feature-btn" onclick="openLocationsModal()"><span class="icon"><i class="fas fa-map-marker-alt"></i></span></button>
            <button class="feature-btn" onclick="openLanesModal()"><span class="icon"><i class="fas fa-road"></i></span></button>
            <button class="feature-btn" onclick="openKycUsersListModal()"><span class="icon"><i class="fas fa-id-card"></i></span></button>
            <button class="feature-btn" onclick="openPushNotificationUsersModal()"><span class="icon"><i class="fas fa-bell"></i></span></button>
            <button class="feature-btn" onclick="openWatchlistFromIcon()"><span class="icon"><i class="fas fa-eye"></i></span></button>
                            <button class="feature-btn" onclick="showAnalyticsModal()" title="Analytics Dashboard"><span class="icon"><i class="fas fa-chart-line"></i></span></button>
            <button class="feature-btn" onclick="showVehicleFinderModal()"><span class="icon"><i class="fas fa-car"></i></span></button>
            <button class="feature-btn" onclick="showBankFinderModal()"><span class="icon"><i class="fas fa-university"></i></span></button>
            <button class="feature-btn" onclick="showFastagBalanceModal()"><span class="icon"><i class="fas fa-wallet"></i></span></button>
            <button class="feature-btn" style="opacity: 0.5; cursor: not-allowed;" title="Coming Soon"><span class="icon"><i class="fas fa-receipt"></i></span></button>
            <button class="feature-btn" onclick="showFuelPriceModal()"><span class="icon"><i class="fas fa-gas-pump"></i></span></button>
            <button class="feature-btn" onclick="showReaderSettingsModal()"><span class="icon"><i class="fas fa-sliders-h"></i></span></button>
            <button class="feature-btn" onclick="showBarrierModal()"><span class="icon"><i class="fas fa-unlock-alt"></i></span></button>
            <button class="feature-btn" onclick="showVehicleDemographicsModal()"><span class="icon"><i class="fas fa-chart-pie"></i></span></button>
        </div>
        <div class="feature-slider carousel slide" id="featureSlider" data-bs-ride="carousel" data-bs-interval="3500">
            <div class="carousel-inner">
                <div class="carousel-item active"><span class="icon"><i class="fas fa-bolt"></i></span><span class="desc">Lightning Fast & Secure</span></div>
                <div class="carousel-item"><span class="icon"><i class="fas fa-sliders-h"></i></span><span class="desc">Adjust Reader Settings</span></div>
                <div class="carousel-item"><span class="icon"><i class="fas fa-unlock-alt"></i></span><span class="desc">Open Barrier Remotely</span></div>
                <div class="carousel-item"><span class="icon"><i class="fas fa-chart-pie"></i></span><span class="desc">Know Vehicle Demographics</span></div>
                <div class="carousel-item"><span class="icon"><i class="fas fa-map-marked-alt"></i></span><span class="desc">All Locations, One App</span></div>
            </div>
        </div>
        <div class="analytics-grid">
            <div class="analytics-card" onclick="showAnalyticsDetails('occupancy')">
                <span class="icon"><i class="fas fa-users"></i></span>
                <span class="label">Current Occupancy</span>
                <span class="value" id="card-occupancy">--</span>
            </div>
            <div class="analytics-card" onclick="showAnalyticsDetails('granted')">
                <span class="icon"><i class="fas fa-check-circle"></i></span>
                <span class="label">Today's Granted</span>
                <span class="value" id="card-granted">--</span>
            </div>
            <div class="analytics-card" onclick="showAnalyticsDetails('denied')">
                <span class="icon"><i class="fas fa-times-circle"></i></span>
                <span class="label">Denied Today</span>
                <span class="value" id="card-denied">--</span>
            </div>
            <div class="analytics-card" onclick="showAnalyticsDetails('trend')">
                <span class="icon"><i class="fas fa-chart-line"></i></span>
                <span class="label">Activity Trend</span>
                <span class="value" id="card-trend">--</span>
            </div>
            <div class="analytics-card" onclick="showAnalyticsDetails('unique')">
                <span class="icon"><i class="fas fa-car"></i></span>
                <span class="label">Unique Vehicles</span>
                <span class="value" id="card-unique">--</span>
            </div>
            <div class="analytics-card" onclick="showAnalyticsDetails('fuel')">
                <span class="icon"><i class="fas fa-gas-pump"></i></span>
                <span class="label">Top Fuel</span>
                <span class="value" id="card-fuel">--</span>
            </div>
            <div class="barrier-card" onclick="showBarrierModal()">
                <span class="icon" style="background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; color: #764ba2; display: flex; align-items: center; justify-content: center;"><i class="fas fa-door-open"></i></span>
                <span class="label">Barrier Control</span>
                <span class="value" style="color: #764ba2;">Tap to Control</span>
            </div>
            <div class="analytics-card controller-status" onclick="showControllerStatusModal()">
                <span class="icon"><i class="fas fa-microchip"></i></span>
                <span class="label">Controller Status</span>
                <span class="value">Tap to View</span>
            </div>
        </div>
    </div>
    <!-- Vehicle Finder Modal -->
    <div id="vehicleFinderModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 450px;">
            <span class="close-modal" onclick="closeVehicleFinderModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-car"></i></span>
                <span class="modal-title">Vehicle Finder</span>
            </div>
            <div class="modal-desc">Find vehicle information by registration number</div>
            <form id="vehicleSearchForm" onsubmit="searchVehicle(event)">
                <div class="mb-3">
                    <label class="form-label">Vehicle Registration Number</label>
                    <input type="text" class="form-control" id="vehicleRegNo" placeholder="e.g., KA03KD1578" required>
                    <div class="form-text">Format: KA03KD1578</div>
                </div>
                <div id="vehicleSearchError" style="color:#dc3545;font-size:0.9em;margin-bottom:0.5em;display:none;"></div>
                <div class="modal-footer-custom" style="justify-content: flex-end;">
                    <button class="modal-close-btn" type="submit" style="background:linear-gradient(90deg,#764ba2 0%,#ffe082 100%);color:#fff;">Search</button>
                </div>
            </form>
            <div id="vehicleResults" style="margin-top:1rem;display:none;">
                <div class="modal-records" id="vehicleResultsContent"></div>
            </div>
        </div>
    </div>
    <!-- Bank Finder Modal -->
    <div id="bankFinderModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 500px;">
            <span class="close-modal" onclick="closeBankFinderModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-university"></i></span>
                <span class="modal-title">Bank Finder</span>
            </div>
            <div class="modal-desc">Find bank information by vehicle number or tag ID</div>
            <form id="bankSearchForm" onsubmit="searchBank(event)">
                <div class="mb-3">
                    <label class="form-label">Search Type</label>
                    <select class="form-control" id="bankSearchType" onchange="updateBankHelpText()">
                        <option value="VRN">Vehicle Number</option>
                        <option value="TagID">Tag ID</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Search Value</label>
                    <input type="text" class="form-control" id="bankSearchValue" placeholder="Enter VRN or TagID" required>
                    <div class="form-text" id="bankHelpText">Format: TN66AT2938 (VRN) or 24-character TagID</div>
                </div>
                <div id="bankSearchError" style="color:#dc3545;font-size:0.9em;margin-bottom:0.5em;display:none;"></div>
                <div class="modal-footer-custom" style="justify-content: flex-end;">
                    <button class="modal-close-btn" type="submit" style="background:linear-gradient(90deg,#764ba2 0%,#ffe082 100%);color:#fff;">Search</button>
                </div>
            </form>
            <div id="bankResults" style="margin-top:1rem;display:none;">
                <div class="modal-records" id="bankResultsContent"></div>
            </div>
        </div>
    </div>
    <!-- FASTag Balance Modal -->
    <div id="fastagBalanceModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 500px;">
            <span class="close-modal" onclick="closeFastagBalanceModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-wallet"></i></span>
                <span class="modal-title">FASTag Balance</span>
            </div>
            <div class="modal-desc">Check FASTag balance by vehicle number and bank</div>
            <form id="fastagBalanceForm" onsubmit="checkFastagBalance(event)">
                <div class="mb-3">
                    <label class="form-label">Vehicle Registration Number</label>
                    <input type="text" class="form-control" id="fastagRegNo" placeholder="e.g., KA04MJ6369" required>
                    <div class="form-text">Format: KA04MJ6369</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Select Bank</label>
                    <select class="form-control" id="fastagBankSelect" required>
                        <option value="">Choose a bank...</option>
                        <option value="Airtel Payments Bank">Airtel Payments Bank</option>
                        <option value="Axis Bank">Axis Bank</option>
                        <option value="HDFC Bank">HDFC Bank</option>
                        <option value="ICICI Bank">ICICI Bank</option>
                        <option value="IDFC FIRST Bank">IDFC FIRST Bank</option>
                        <option value="SBI">SBI</option>
                        <option value="AU Small Finance Bank">AU Small Finance Bank</option>
                        <option value="Bandhan Bank">Bandhan Bank</option>
                        <option value="Bank of Baroda">Bank of Baroda</option>
                        <option value="Bank of Maharashtra">Bank of Maharashtra</option>
                        <option value="Canara Bank">Canara Bank</option>
                        <option value="Equitas Small Finance Bank">Equitas Small Finance Bank</option>
                        <option value="Federal Bank">Federal Bank</option>
                        <option value="IDBI Bank">IDBI Bank</option>
                        <option value="Indian Bank">Indian Bank</option>
                        <option value="IndusInd Bank">IndusInd Bank</option>
                        <option value="IOB">IOB</option>
                        <option value="Jammu and Kashmir Bank">Jammu and Kashmir Bank</option>
                        <option value="Karnataka Bank">Karnataka Bank</option>
                        <option value="Kotak Mahindra Bank">Kotak Mahindra Bank</option>
                        <option value="Livquick Technology">Livquick Technology</option>
                        <option value="South Indian Bank">South Indian Bank</option>
                        <option value="UCO Bank">UCO Bank</option>
                        <option value="Union Bank of India">Union Bank of India</option>
                    </select>
                </div>
                <div id="fastagBalanceError" style="color:#dc3545;font-size:0.9em;margin-bottom:0.5em;display:none;"></div>
                <div class="modal-footer-custom" style="justify-content: flex-end;">
                    <button class="modal-close-btn" type="submit" style="background:linear-gradient(90deg,#764ba2 0%,#ffe082 100%);color:#fff;">Check Balance</button>
                </div>
            </form>
            <div id="fastagBalanceResults" style="margin-top:1rem;display:none;">
                <div class="modal-records" id="fastagBalanceResultsContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Access Control Modal -->
    <div id="accessControlModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 400px;">
            <span class="close-modal" onclick="closeAccessModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-lock"></i></span>
                <span class="modal-title">Access Restricted</span>
            </div>
            <div class="modal-desc">This feature requires elevated access permissions.</div>
            <div class="access-content">
                <div class="access-info">
                    <i class="fas fa-shield-alt" style="font-size: 3rem; color: #764ba2; margin-bottom: 1rem;"></i>
                    <h4>Contact Onebee for Access</h4>
                    <p>To enable this feature, please contact Onebee support.</p>
                </div>
                <div class="contact-list">
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span>+91 95008 50000</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span>support@onebee.com</span>
                    </div>
                    <div class="contact-item">
                        <i class="fab fa-whatsapp"></i>
                        <span>WhatsApp: +91 95008 50000</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer-custom">
                <button class="modal-close-btn" onclick="closeAccessModal()">Close</button>
            </div>
        </div>
    </div>
    
    <button class="fab-center" onclick="openAddKycUserModal()" title="Scan QR"><i class="fas fa-qrcode"></i></button>
    <button class="logout-btn-gradient" onclick="showLogoutModal()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
    <nav class="bottom-nav">
        <button class="bottom-nav-btn active"><i class="fas fa-home"></i><span>Home</span></button>
        <button class="bottom-nav-btn" onclick="showAnalyticsModal()"><i class="fas fa-chart-line"></i><span>Analytics</span></button>
        <button class="bottom-nav-btn" onclick="showReportsModal()"><i class="fas fa-file-alt"></i><span>Reports</span></button>
        <button class="bottom-nav-btn" onclick="showActionModal()"><i class="fas fa-bolt"></i><span>Action</span></button>
    </nav>

    <div id="logoutModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 350px;">
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-sign-out-alt"></i></span>
                <span class="modal-title">Logout</span>
            </div>
            <div class="modal-desc">Are you sure you want to logout from the PWA?</div>
            <div class="modal-footer-custom" style="justify-content: space-between; gap: 0.5rem;">
                <button class="modal-cancel-btn" onclick="closeLogoutModal()">Cancel</button>
                <button class="modal-logout-btn" onclick="confirmLogout()">Logout</button>
            </div>
        </div>
    </div>
    <!-- Action Modal -->
    <div id="actionModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 600px; max-height: 85vh;">
            <span class="close-modal" onclick="closeActionModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-bolt"></i></span>
                <span class="modal-title">Recent Activity & Analytics</span>
            </div>
            <div class="modal-desc">View recent activities and analytics data from the dashboard.</div>
            <div class="action-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; margin: 1rem 0;">
                <div class="action-card" onclick="showRecentActivity()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.8rem; border-radius: 10px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-list-alt" style="font-size: 1.5rem; margin-bottom: 0.4rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Recent Activity</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">All Events</div>
                </div>
                <div class="action-card" onclick="showRecentEntries()" style="background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%); color: white; padding: 0.8rem; border-radius: 10px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-sign-in-alt" style="font-size: 1.5rem; margin-bottom: 0.4rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Recent Entries</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Entry events</div>
                </div>
                <div class="action-card" onclick="showRecentExits()" style="background: linear-gradient(135deg, #ff512f 0%, #dd2476 100%); color: white; padding: 0.8rem; border-radius: 10px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-sign-out-alt" style="font-size: 1.5rem; margin-bottom: 0.4rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Recent Exits</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Exit events</div>
                </div>
                <div class="action-card" onclick="showRecentGrantedTags()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 0.8rem; border-radius: 10px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-check-circle" style="font-size: 1.5rem; margin-bottom: 0.4rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Recent Granted Tags</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Granted access</div>
                </div>
                <div class="action-card" onclick="showTopGrantedTags()" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white; padding: 0.8rem; border-radius: 10px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-trophy" style="font-size: 1.5rem; margin-bottom: 0.4rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Top Granted Tags</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Most active tags</div>
                </div>
                <div class="action-card" onclick="showMostDeniedTags()" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); color: white; padding: 0.8rem; border-radius: 10px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-ban" style="font-size: 1.5rem; margin-bottom: 0.4rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Most Denied Tags</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Denied access</div>
                </div>
                <div class="action-card" onclick="showDeniedFastagActivity()" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); color: white; padding: 0.8rem; border-radius: 10px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 0.4rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Denied FASTag Activity</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">FASTag denials</div>
                </div>
            </div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeActionModal()">Close</button>
            </div>
        </div>
    </div>
    <div id="barrierModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 350px;">
            <span class="close-modal" onclick="closeBarrierModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-door-open"></i></span>
                <span class="modal-title">Barrier Control</span>
            </div>
            <div class="modal-desc">Control all 3 barrier relays below. Tap to toggle ON (auto-OFF after a few seconds).</div>
            <div class="barrier-control-actions" style="margin-bottom: 1rem; display: flex; gap: 0.5rem; justify-content: center;">
                <button class="barrier-action-btn" onclick="openAllBarriers()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;">
                    <i class="fas fa-unlock-alt"></i> Open All Barriers
                </button>
            </div>
            <div class="barrier-relay-group">
                <div class="barrier-relay-item">
                    <span id="relay1-dot" class="barrier-relay-dot unknown" title="Unknown"></span>
                    <span class="barrier-relay-label">Relay 1</span>
                    <button class="barrier-relay-toggle" onclick="toggleRelayPWA(1)">Toggle</button>
                </div>
                <div class="barrier-relay-item">
                    <span id="relay2-dot" class="barrier-relay-dot unknown" title="Unknown"></span>
                    <span class="barrier-relay-label">Relay 2</span>
                    <button class="barrier-relay-toggle" onclick="toggleRelayPWA(2)">Toggle</button>
                </div>
                <div class="barrier-relay-item">
                    <span id="relay3-dot" class="barrier-relay-dot unknown" title="Unknown"></span>
                    <span class="barrier-relay-label">Relay 3</span>
                    <button class="barrier-relay-toggle" onclick="toggleRelayPWA(3)">Toggle</button>
                </div>
            </div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeBarrierModal()">Close</button>
            </div>
        </div>
    </div>
    <div id="controllerStatusModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 500px;">
            <span class="close-modal" onclick="closeControllerStatusModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-microchip"></i></span>
                <span class="modal-title">Controller Status</span>
            </div>
            <div class="modal-desc">System monitoring and management options.</div>
            
            <!-- Controller Status Options -->
            <div class="controller-options" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0;">
                <div class="controller-option" onclick="showControllerHealth()" style="background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-heartbeat" style="font-size: 1.8rem; margin-bottom: 0.5rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">System Health</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">CPU, Memory, Disk</div>
                </div>
                <div class="controller-option" onclick="showControllerIPInfo()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-network-wired" style="font-size: 1.8rem; margin-bottom: 0.5rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Network Info</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">IP, MAC, Interfaces</div>
                </div>
                <div class="controller-option" onclick="showControllerBackup()" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-database" style="font-size: 1.8rem; margin-bottom: 0.5rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Database Backup</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Download & Backup</div>
                </div>
                <div class="controller-option" onclick="restartController()" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-power-off" style="font-size: 1.8rem; margin-bottom: 0.5rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Restart Controller</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Reboot System</div>
                </div>
                <div class="controller-option" onclick="restartApplication()" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-sync-alt" style="font-size: 1.8rem; margin-bottom: 0.5rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Restart App</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Restart Fastag Service</div>
                </div>
                <div class="controller-option" onclick="restartReaders()" style="background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                    <i class="fas fa-wifi" style="font-size: 1.8rem; margin-bottom: 0.5rem;"></i>
                    <div style="font-weight: 600; font-size: 0.9rem;">Restart Readers</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Restart RFID Service</div>
                </div>

            </div>
            
            <div class="modal-records" id="controllerStatusRecords"></div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeControllerStatusModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- System Health Modal -->
    <div id="systemHealthModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 600px;">
            <span class="close-modal" onclick="closeSystemHealthModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-heartbeat" style="background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i></span>
                <span class="modal-title">System Health</span>
            </div>
            <div class="modal-desc">Real-time system monitoring and health status.</div>
            <div id="systemHealthContent" class="modal-records"></div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeSystemHealthModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Network Info Modal -->
    <div id="networkInfoModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 600px;">
            <span class="close-modal" onclick="closeNetworkInfoModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-network-wired" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i></span>
                <span class="modal-title">Network Information</span>
            </div>
            <div class="modal-desc">Network interfaces, IP addresses, and connection status.</div>
            <div id="networkInfoContent" class="modal-records"></div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeNetworkInfoModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Database Backup Modal -->
    <div id="databaseBackupModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 600px;">
            <span class="close-modal" onclick="closeDatabaseBackupModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-database" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i></span>
                <span class="modal-title">Database Backup</span>
            </div>
            <div class="modal-desc">Database information and backup management.</div>
            <div id="databaseBackupContent" class="modal-records"></div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeDatabaseBackupModal()">Close</button>
            </div>
        </div>
    </div>



    <!-- Restart Confirmation Modal -->
    <div id="restartConfirmModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 400px;">
            <div class="modal-header-custom">
                <span class="modal-icon" id="restartConfirmIcon"><i class="fas fa-exclamation-triangle"></i></span>
                <span class="modal-title" id="restartConfirmTitle">Confirm Restart</span>
            </div>
            <div class="modal-desc" id="restartConfirmDesc">Are you sure you want to perform this action?</div>
            <div class="modal-footer-custom" style="justify-content: space-between; gap: 0.5rem;">
                <button class="modal-cancel-btn" onclick="closeRestartConfirmModal()">Cancel</button>
                <button class="modal-logout-btn" id="restartConfirmBtn" onclick="executeRestartAction()">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- QR Code Add KYC User Modal -->
    <div id="addKycUserModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 420px;">
            <span class="close-modal" onclick="closeAddKycUserModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-user-plus"></i></span>
                <span class="modal-title">Add KYC User</span>
            </div>
            <div class="modal-desc">Enter user details or scan QR to autofill.</div>
            
            <!-- QR Scanner Section -->
            <div class="qr-scanner-section">
                <button type="button" class="qr-scan-btn" onclick="openQRScanner()">
                    <i class="fas fa-qrcode"></i>
                    <span>Scan QR Code</span>
                </button>
            </div>
            
            <form id="addKycUserForm" onsubmit="submitAddKycUser(event)">
                <div class="mb-2">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" id="kycName" name="name" required autocomplete="off">
                </div>
                <div class="mb-2" style="position:relative;">
                    <label class="form-label">FASTag ID</label>
                    <input type="text" class="form-control" id="kycFastagId" name="fastag_id" required autocomplete="off" style="padding-right:2.2rem;">
                    <span class="input-icon-btn" style="position:absolute;top:2.1rem;right:0.7rem;cursor:pointer;color:#764ba2;" onclick="lookupVehicleByFastag()" title="Get Vehicle Number from FASTag ID"><i class="fas fa-search"></i></span>
                </div>
                <div class="mb-2" style="position:relative;">
                    <label class="form-label">Vehicle Number</label>
                    <input type="text" class="form-control" id="kycVehicleNumber" name="vehicle_number" required autocomplete="off" style="padding-right:2.2rem;">
                    <span class="input-icon-btn" style="position:absolute;top:2.1rem;right:0.7rem;cursor:pointer;color:#764ba2;" onclick="lookupFastagByVehicle()" title="Get FASTag ID from Vehicle Number"><i class="fas fa-search"></i></span>
                </div>
                <div class="mb-2">
                    <label class="form-label">Contact Number</label>
                    <input type="text" class="form-control" id="kycContactNumber" name="contact_number" required autocomplete="off">
                </div>
                <div class="mb-2">
                    <label class="form-label">Address</label>
                    <textarea class="form-control" id="kycAddress" name="address" rows="2" required></textarea>
                </div>
                <div id="kycUserError" style="color:#dc3545;font-size:0.97em;margin-bottom:0.5em;display:none;"></div>
                <div class="modal-footer-custom" style="justify-content: flex-end;">
                    <button class="modal-close-btn" type="submit" style="background:linear-gradient(90deg,#764ba2 0%,#ffe082 100%);color:#fff;">Add User</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Push Notification Users Modal -->
    <div id="pushNotificationUsersModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
            <span class="close-modal" onclick="closePushNotificationUsersModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-bell"></i></span>
                <span class="modal-title">Push Notification Users</span>
            </div>
            <div class="modal-desc" id="pushNotificationUsersTotal">All users registered for push notifications.</div>
            <div class="modal-records" id="pushNotificationUsersRecords" style="overflow-x:auto;max-height:45vh;overflow-y:auto;"></div>
            <div style="display:flex;justify-content:flex-end;align-items:center;margin-top:0.5em;">
                <button class="input-icon-btn" style="font-size:1.3rem;color:#764ba2;background:none;border:none;outline:none;cursor:pointer;" onclick="togglePushNotificationUsersSearch()" title="Search"><i class="fas fa-search"></i></button>
            </div>
            <div id="pushNotificationUsersSearchBox" style="display:none;margin-bottom:0.5em;">
                <input type="text" id="pushNotificationUsersSearchInput" class="form-control" placeholder="Search by name, contact, or FCM token..." oninput="filterPushNotificationUsers()">
            </div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closePushNotificationUsersModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom qr-scanner-modal" style="max-width: 500px;">
            <span class="close-modal" onclick="closeQRScanner()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-qrcode"></i></span>
                <span class="modal-title">QR Code Scanner</span>
            </div>
            <div class="modal-desc">Point camera at QR code to scan FASTag ID</div>
            
            <!-- Camera Controls -->
            <div class="camera-controls">
                <button type="button" class="flash-btn" onclick="toggleFlash()" id="flashBtn">
                    <i class="fas fa-lightbulb"></i>
                    <span>Flash Off</span>
                </button>
            </div>
            
            <!-- Camera View -->
            <div class="camera-container">
                <video id="qrVideo" autoplay playsinline style="width: 100%; height: 300px; background: #000;"></video>
                <div class="scan-overlay">
                    <div class="scan-frame"></div>
                </div>
            </div>
            
            <!-- Scan Result -->
            <div id="scanResult" class="scan-result" style="display: none;">
                <div class="result-content">
                    <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.5rem;"></i>
                    <span>QR Code Scanned Successfully!</span>
                </div>
            </div>
            
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeQRScanner()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- KYC Users List Modal -->
    <div id="kycUsersListModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
            <span class="close-modal" onclick="closeKycUsersListModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-users"></i></span>
                <span class="modal-title">KYC Users</span>
            </div>
            <div class="modal-desc" id="kycUsersListTotal">All registered KYC users.</div>
            <div class="modal-records" id="kycUsersListRecords" style="overflow-x:auto;max-height:45vh;overflow-y:auto;"></div>
            <div style="display:flex;justify-content:flex-end;align-items:center;margin-top:0.5em;">
                <button class="input-icon-btn" style="font-size:1.3rem;color:#764ba2;background:none;border:none;outline:none;cursor:pointer;" onclick="toggleKycUserSearch()" title="Search"><i class="fas fa-search"></i></button>
            </div>
            <div id="kycUserSearchBox" style="display:none;margin-bottom:0.5em;">
                <input type="text" id="kycUserSearchInput" class="form-control" placeholder="Search by name or vehicle number..." oninput="filterKycUsersList()">
            </div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeKycUsersListModal()">Close</button>
            </div>
        </div>
    </div>
    <!-- Locations Modal -->
    <div id="locationsModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
            <span class="close-modal" onclick="closeLocationsModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-map-marker-alt"></i></span>
                <span class="modal-title">Locations</span>
            </div>
            <div class="modal-desc" id="locationsTotal">All locations.</div>
            <div class="modal-records" id="locationsRecords" style="overflow-x:auto;max-height:45vh;overflow-y:auto;"></div>
            <div style="display:flex;justify-content:flex-end;align-items:center;margin-top:0.5em;">
                <button class="input-icon-btn" style="font-size:1.3rem;color:#764ba2;background:none;border:none;outline:none;cursor:pointer;" onclick="toggleLocationsSearch()" title="Search"><i class="fas fa-search"></i></button>
                <button class="input-icon-btn" style="font-size:1.3rem;color:#28a745;background:none;border:none;outline:none;cursor:pointer;margin-left:0.7em;" onclick="showAddLocationForm()" title="Add Location"><i class="fas fa-plus"></i></button>
            </div>
            <div id="locationsSearchBox" style="display:none;margin-bottom:0.5em;">
                <input type="text" id="locationsSearchInput" class="form-control" placeholder="Search by name or address..." oninput="filterLocationsList()">
            </div>
            <div id="addLocationFormBox" style="display:none;margin-bottom:0.5em;">
                <form id="addLocationForm" onsubmit="submitAddLocation(event)">
                    <input type="text" class="form-control mb-1" id="locationName" placeholder="Location Name" required>
                    <input type="text" class="form-control mb-1" id="locationAddress" placeholder="Address" required>
                    <div style="display:flex;justify-content:flex-end;gap:0.5em;">
                        <button class="modal-close-btn" type="button" onclick="hideAddLocationForm()">Cancel</button>
                        <button class="modal-close-btn" type="submit" style="background:linear-gradient(90deg,#764ba2 0%,#ffe082 100%);color:#fff;">Add</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeLocationsModal()">Close</button>
            </div>
        </div>
    </div>
    <!-- Lanes Modal -->
    <div id="lanesModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
            <span class="close-modal" onclick="closeLanesModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-road"></i></span>
                <span class="modal-title">Lanes</span>
            </div>
            <div class="modal-desc" id="lanesTotal">All lanes.</div>
            <div class="modal-records" id="lanesRecords" style="overflow-x:auto;max-height:45vh;overflow-y:auto;"></div>
            <div style="display:flex;justify-content:flex-end;align-items:center;margin-top:0.5em;">
                <button class="input-icon-btn" style="font-size:1.3rem;color:#764ba2;background:none;border:none;outline:none;cursor:pointer;" onclick="toggleLanesSearch()" title="Search"><i class="fas fa-search"></i></button>
                <button class="input-icon-btn" style="font-size:1.3rem;color:#28a745;background:none;border:none;outline:none;cursor:pointer;margin-left:0.7em;" onclick="showAddLaneForm()" title="Add Lane"><i class="fas fa-plus"></i></button>
            </div>
            <div id="lanesSearchBox" style="display:none;margin-bottom:0.5em;">
                <input type="text" id="lanesSearchInput" class="form-control" placeholder="Search by name..." oninput="filterLanesList()">
            </div>
            <div id="addLaneFormBox" style="display:none;margin-bottom:0.5em;">
                <form id="addLaneForm" onsubmit="submitAddLane(event)">
                    <input type="text" class="form-control mb-1" id="laneName" placeholder="Lane Name" required>
                    <input type="number" class="form-control mb-1" id="laneLocationId" placeholder="Location ID" required>
                    <div style="display:flex;justify-content:flex-end;gap:0.5em;">
                        <button class="modal-close-btn" type="button" onclick="hideAddLaneForm()">Cancel</button>
                        <button class="modal-close-btn" type="submit" style="background:linear-gradient(90deg,#764ba2 0%,#ffe082 100%);color:#fff;">Add</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeLanesModal()">Close</button>
            </div>
        </div>
    </div>
    <!-- Reader Settings Modal -->
    <div id="readerSettingsModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
            <span class="close-modal" onclick="closeReaderSettingsModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-sliders-h"></i></span>
                <span class="modal-title">Reader Settings</span>
            </div>
            <div class="modal-desc">Manage RF power for all readers</div>
            <div id="readers-container" class="modal-records">
                <!-- Readers will be loaded here -->
            </div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeReaderSettingsModal()">Close</button>
            </div>
        </div>
    </div>
    <!-- Fuel Price Modal -->
    <div id="fuelPriceModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
            <span class="close-modal" onclick="closeFuelPriceModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-gas-pump"></i></span>
                <span class="modal-title">Fuel Prices</span>
            </div>
            <div class="modal-desc">Current petrol prices across India</div>
            <div style="display:flex;justify-content:flex-end;align-items:center;margin-bottom:0.5em;">
                <button class="input-icon-btn" style="font-size:1.3rem;color:#764ba2;background:none;border:none;outline:none;cursor:pointer;" onclick="toggleFuelPriceSearch()" title="Search"><i class="fas fa-search"></i></button>
            </div>
            <div id="fuelPriceSearchBox" class="fuel-price-search" style="display:none;">
                <select id="fuelPriceCitySelect" class="form-control" onchange="filterFuelPrices()">
                    <option value="">All Cities</option>
                </select>
            </div>
            <div id="fuelPriceContainer" class="modal-records" style="overflow-x:auto;max-height:45vh;overflow-y:auto;">
                <!-- Fuel prices will be loaded here -->
            </div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeFuelPriceModal()">Close</button>
            </div>
        </div>
    </div>
    <!-- Vehicle Demographics Modal -->
    <div id="vehicleDemographicsModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
            <span class="close-modal" onclick="closeVehicleDemographicsModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-chart-pie"></i></span>
                <span class="modal-title">Vehicle Demographics</span>
            </div>
            <div class="modal-desc">Vehicle type distribution and demographics analysis</div>
            <div id="demographicsContainer" class="modal-records" style="overflow-x:auto;max-height:45vh;overflow-y:auto;">
                <!-- Demographics data will be loaded here -->
            </div>
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeVehicleDemographicsModal()">Close</button>
            </div>
        </div>
    </div>
    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
            <span class="close-modal" onclick="closeAnalyticsModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-chart-line"></i></span>
                <span class="modal-title">Analytics Dashboard</span>
            </div>
            <!-- Navigation Arrows -->
            <div class="analytics-nav">
                <button class="nav-arrow" onclick="previousAnalyticsSlide()" id="prevArrow" style="display:none;">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="nav-arrow" onclick="nextAnalyticsSlide()" id="nextArrow">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <!-- Slide Indicator -->
            <div class="analytics-slide-indicator">
                <span id="slideIndicator">1 of 5</span>
            </div>
            
            <!-- Analytics Content Container -->
            <div id="analyticsContent" class="analytics-content" style="padding: 0 3rem;">
                <!-- Content will be loaded here -->
            </div>
            
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeAnalyticsModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Analytics Details Modal -->
    <div id="analyticsDetailsModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom analytics-details-modal" style="max-width: 98vw; min-width: 350px; max-height: 90vh;">
            <span class="close-modal" onclick="closeAnalyticsDetailsModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon" id="detailsModalIcon"><i class="fas fa-chart-line"></i></span>
                <span class="modal-title" id="detailsModalTitle">Analytics Details</span>
            </div>
            <div class="modal-desc" id="detailsModalDesc">Detailed analytics information</div>
            
            <div class="analytics-details-content" id="analyticsDetailsContent">
                <!-- Individual analytics details will be loaded here -->
            </div>
            
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeAnalyticsDetailsModal()">Close</button>
            </div>
        </div>
    </div>
    
    <style>
    /* Access Control Styles */
    .access-content {
        text-align: center;
        padding: 1rem 0;
    }
    
    .access-info h4 {
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .access-info p {
        color: #666;
        margin-bottom: 1.5rem;
    }
    
    .contact-list {
        margin-top: 1rem;
    }
    
    .contact-item {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .contact-item i {
        color: #764ba2;
        width: 20px;
    }
    
    .contact-item span {
        font-size: 0.9rem;
        color: #333;
    }
    

    
    /* Reader Settings Styles */
    .reader-card {
        background: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }
    
    .reader-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .reader-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.3rem;
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }
    
    .reader-info {
        flex: 1;
    }
    
    .reader-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 0.3rem;
    }
    
    .reader-details {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.2rem;
    }
    
    .reader-activity {
        font-size: 0.75rem;
        color: #888;
    }
    
    .reader-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.5rem 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #28a745;
    }
    
    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .status-text {
        font-size: 0.9rem;
        font-weight: 600;
        color: #28a745;
    }
    
    .status-text.offline {
        color: #dc3545;
    }
    
    .status-text.idle {
        color: #ffc107;
    }
    
    .power-control {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.2rem;
        border: 1px solid #e9ecef;
    }
    
    .power-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.8rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .power-label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
    }
    
    .power-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: #764ba2;
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .power-input {
        display: flex;
        gap: 0.8rem;
        align-items: center;
    }
    
    .power-input-field {
        flex: 1;
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.6rem;
        font-size: 0.9rem;
        color: #333;
        transition: all 0.3s ease;
    }
    
    .power-input-field:focus {
        outline: none;
        border-color: #764ba2;
        box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
    }
    
    .power-set-btn {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.6rem 1.2rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(118, 75, 162, 0.3);
    }
    
    .power-set-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(118, 75, 162, 0.4);
    }
    
    .power-set-btn:active {
        transform: translateY(0);
    }
    
    .feedback {
        margin-top: 1rem;
        padding: 0.8rem;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        text-align: center;
    }
    
    .feedback.success {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }
    
    .feedback.error {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(253, 126, 20, 0.1) 100%);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    /* Status Badge Styles */
    .status-badge {
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-badge.active {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .status-badge.inactive {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
    }
    
    /* KYC Users Action Buttons */
    .action-buttons {
        display: flex;
        gap: 0.3rem;
        justify-content: center;
        align-items: center;
    }
    
    .action-btn {
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.75rem;
    }
    
    .action-btn.edit-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }
    
    .action-btn.edit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
    }
    
    .action-btn.delete-btn {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
    
    .action-btn.delete-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
    }
    
    /* QR Scanner Styles */
    .qr-scanner-section {
        margin-bottom: 1rem;
        text-align: center;
    }
    
    .qr-scan-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.8rem 1.5rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0 auto;
    }
    
    .qr-scan-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    

    
    .qr-scanner-modal {
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    
    .camera-controls {
        display: flex;
        justify-content: center;
        margin-bottom: 1rem;
    }
    
    .flash-btn {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    
    .flash-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
    }
    
    .camera-container {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .scan-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }
    
    .scan-frame {
        width: 200px;
        height: 200px;
        border: 2px solid #fff;
        border-radius: 10px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }
    
    .scan-result {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
        border: 1px solid rgba(40, 167, 69, 0.2);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .result-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #28a745;
        font-weight: 600;
    }
    
    /* Disabled Feature Styles */
    .feature-btn.disabled {
        opacity: 0.4 !important;
        cursor: not-allowed !important;
        position: relative;
    }
    
    .feature-btn.disabled::after {
        content: '\f023';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        top: -3px;
        right: -3px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .analytics-card.disabled {
        opacity: 0.4 !important;
        cursor: not-allowed !important;
        position: relative;
    }
    
    .analytics-card.disabled::after {
        content: '\f023';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        top: 5px;
        right: 5px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .barrier-card.disabled {
        opacity: 0.4 !important;
        cursor: not-allowed !important;
        position: relative;
    }
    
    .barrier-card.disabled::after {
        content: '\f023';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        top: 5px;
        right: 5px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .modal-custom {
        position: fixed;
        z-index: 2000;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(40, 30, 60, 0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        padding: 1rem;
        box-sizing: border-box;
    }
    .modal-content-custom {
        background: rgba(255,255,255,0.98);
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(80,80,160,0.18);
        padding: 1.7rem 1.2rem 1.1rem 1.2rem;
        min-width: 90vw;
        max-width: 420px;
        max-height: 85vh;
        position: relative;
        animation: modalFadeIn 0.22s;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(30px) scale(0.98); }
        to { opacity: 1; transform: none; }
    }
    .close-modal {
        position: absolute;
        top: 1.1rem;
        right: 1.2rem;
        font-size: 2.1rem;
        color: #764ba2;
        cursor: pointer;
        font-weight: 700;
        opacity: 0.85;
        transition: color 0.18s, opacity 0.18s;
        z-index: 10;
        background: rgba(255,255,255,0.9);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .close-modal:hover { color: #ffe082; opacity: 1; }
    .modal-header-custom {
        display: flex;
        align-items: center;
        gap: 0.7rem;
        margin-bottom: 0.5rem;
        flex-shrink: 0;
    }
    .modal-icon {
        font-size: 1.7rem;
        background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: #764ba2;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-title {
        font-size: 1.18rem;
        font-weight: 700;
        color: #222;
    }
    .modal-desc {
        font-size: 1.01rem;
        color: #444;
        margin-bottom: 0.7rem;
        flex-shrink: 0;
    }
    .modal-records {
        margin-bottom: 0.7rem;
        flex: 1;
        overflow-y: auto;
        overflow-x: auto;
        max-height: 60vh;
    }
    .modal-records::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    .modal-records::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    .modal-records::-webkit-scrollbar-thumb {
        background: #764ba2;
        border-radius: 3px;
    }
    .modal-records::-webkit-scrollbar-thumb:hover {
        background: #ffe082;
    }
    .modal-records table {
        width: 100%;
        min-width: 600px;
        border-collapse: collapse;
        font-size: 0.85rem;
        margin-bottom: 0.2rem;
    }
    .modal-records th, .modal-records td {
        padding: 0.28rem 0.15rem;
        text-align: left;
        border-bottom: 1px solid #f0e6ff;
        font-size: 0.8rem;
        white-space: nowrap;
        min-width: 80px;
    }
    .modal-records th {
        color: #764ba2;
        font-weight: 700;
        background: #f7f7fa;
        font-size: 0.75rem;
        position: sticky;
        top: 0;
        z-index: 5;
    }
    .modal-records tr:last-child td {
        border-bottom: none;
    }
    .modal-records .vehicle-number {
        min-width: 120px;
        font-weight: 600;
        color: #764ba2;
    }
    .modal-records .owner-name {
        min-width: 100px;
        color: #666;
        font-size: 0.75rem;
    }
    .modal-records .lane-name {
        min-width: 80px;
        color: #888;
        font-size: 0.7rem;
    }
    .modal-records .time {
        min-width: 140px;
        color: #555;
        font-size: 0.75rem;
    }
    .modal-records .reason {
        min-width: 100px;
        color: #555;
        font-size: 0.75rem;
    }
    .modal-records .total-events {
        min-width: 60px;
        text-align: center;
        color: #764ba2;
        font-weight: 600;
    }
    .modal-footer-custom {
        display: flex;
        justify-content: flex-end;
        flex-shrink: 0;
        margin-top: 0.5rem;
    }
    .modal-close-btn {
        background: linear-gradient(90deg, #764ba2 0%, #ffe082 100%);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 0.5rem 1.2rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.18s, color 0.18s;
    }
    .modal-close-btn:hover { background: linear-gradient(90deg, #ffe082 0%, #764ba2 100%); color: #764ba2; }
    .modal-cancel-btn {
        background: #f0f0f0;
        color: #666;
        border: none;
        border-radius: 12px;
        padding: 0.5rem 1.2rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.18s;
    }
    .modal-cancel-btn:hover { background: #e0e0e0; }
    .modal-logout-btn {
        background: linear-gradient(90deg, #dc3545 0%, #ff6b6b 100%);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 0.5rem 1.2rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.18s;
    }
    .modal-logout-btn:hover { background: linear-gradient(90deg, #c82333 0%, #ff5252 100%); }
    .modal-records .reader-type {
        min-width: 80px;
        color: #555;
        font-size: 0.75rem;
        text-transform: capitalize;
        font-weight: 600;
    }
    .modal-records .reader-type.entry {
        color: #28a745;
    }
    .modal-records .reader-type.exit {
        color: #dc3545;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Fuel Price Modal Styles */
    .fuel-price-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(80,80,160,0.10);
        padding: 1.2rem;
        margin-bottom: 0.8rem;
        transition: box-shadow 0.18s, transform 0.12s;
        border: 1px solid #e8e8e8;
    }
    .fuel-price-card:hover {
        box-shadow: 0 6px 18px rgba(118,75,162,0.13);
        transform: translateY(2px);
    }
    .fuel-price-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .fuel-price-city {
        font-weight: 600;
        color: #333;
        font-size: 1.1rem;
    }
    .fuel-price-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.2rem;
    }
    .fuel-price-value {
        background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1.1rem;
        min-width: 80px;
        text-align: center;
    }
    .fuel-price-search {
        margin-bottom: 0.5em;
    }
    .fuel-price-search select {
        border: 2px solid #e0d7f7;
        border-radius: 8px;
        padding: 0.5rem;
        font-size: 0.9rem;
        color: #333;
        background: #fff;
    }
    .fuel-price-search select:focus {
        outline: none;
        border-color: #764ba2;
    }
    
    /* Vehicle Demographics Modal Styles */
    .demographics-chart-container {
        background: #fff;
        border-radius: 16px;
        padding: 1.2rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 12px rgba(80,80,160,0.10);
    }
    .demographics-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    .demo-stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e8e8e8;
        text-align: center;
        transition: transform 0.18s;
    }
    .demo-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(118,75,162,0.13);
    }
    .demo-stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.8rem;
        color: white;
        font-size: 1.3rem;
    }
    .demo-stat-label {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 0.3rem;
        font-weight: 500;
    }
    .demo-stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #333;
    }
    .demo-stat-percentage {
        font-size: 0.9rem;
        color: #764ba2;
        font-weight: 600;
        margin-top: 0.2rem;
    }
    .demographics-chart {
        width: 100%;
        height: 200px;
        margin-bottom: 1rem;
    }
    
    /* Analytics Modal Styles */
    .analytics-content {
        min-height: 300px;
        overflow-y: auto;
        max-height: 50vh;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .analytics-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        pointer-events: none;
        z-index: 10;
        padding: 0 1rem;
    }
    
    .nav-arrow {
        background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3);
        transition: all 0.3s ease;
        pointer-events: auto;
    }
    
    .nav-arrow:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(118, 75, 162, 0.4);
    }
    
    .nav-arrow:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .analytics-slide-indicator {
        text-align: center;
        margin: 0.5rem 0;
        font-weight: 600;
        color: #764ba2;
        font-size: 0.9rem;
    }
    
    /* Reports Modal Styles */
    .reports-content {
        min-height: 300px;
        overflow-y: auto;
        max-height: 60vh;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .reports-section {
        margin-bottom: 2rem;
    }
    
    .reports-section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #764ba2;
    }
    
    .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .report-card {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1.2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .report-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(118, 75, 162, 0.2);
        border-color: #764ba2;
    }
    
    .report-card-header {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        margin-bottom: 0.8rem;
    }
    
    .report-card-icon {
        font-size: 1.5rem;
        background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .report-card-title {
        font-weight: 600;
        color: #333;
        font-size: 1rem;
    }
    
    .report-card-desc {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
        margin-bottom: 1rem;
    }
    
    .report-card-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }
    
    .report-action-btn {
        background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
        border: none;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    
    .report-action-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(118, 75, 162, 0.3);
    }
    
    .report-action-btn.secondary {
        background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
    }
    
    .report-action-btn.share {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    /* Share Modal Styles */
    .share-options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .share-options-grid-compact {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin: 1rem 0;
    }
    
    .share-option-btn {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        color: inherit;
    }
    
    .share-option-btn-compact {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.4rem;
        text-decoration: none;
        color: inherit;
        min-width: 80px;
    }
    
    .share-option-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(118, 75, 162, 0.2);
        border-color: #764ba2;
    }
    
    .share-option-btn-compact:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(118, 75, 162, 0.2);
        border-color: #764ba2;
    }
    
    .share-option-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }
    
    .share-option-icon-compact {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        color: white;
    }
    
    .share-option-icon.whatsapp,
    .share-option-icon-compact.whatsapp {
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
    }
    
    .share-option-icon.email,
    .share-option-icon-compact.email {
        background: linear-gradient(135deg, #EA4335 0%, #C62828 100%);
    }
    
    .share-option-icon.telegram {
        background: linear-gradient(135deg, #0088cc 0%, #005580 100%);
    }
    
    .share-option-icon.sms {
        background: linear-gradient(135deg, #FF6B6B 0%, #EE5A52 100%);
    }
    
    .share-option-icon.copy {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }
    
    .share-option-icon.system {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }
    
    .share-option-label {
        font-weight: 600;
        font-size: 0.9rem;
        color: #333;
    }
    
    .share-option-label-compact {
        font-weight: 600;
        font-size: 0.8rem;
        color: #333;
    }
    
    /* Analytics Details Modal Styles */
    .analytics-details-modal {
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .analytics-details-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: auto;
        padding: 0.3rem 0;
        max-height: 70vh;
    }
    
    .analytics-details-content table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.7rem;
        table-layout: auto;
    }
    
    .analytics-details-content th {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        color: white;
        padding: 0.4rem 0.3rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.65rem;
        position: sticky;
        top: 0;
        z-index: 10;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .analytics-details-content td {
        padding: 0.3rem 0.3rem;
        border-bottom: 1px solid #eee;
        font-size: 0.65rem;
        vertical-align: top;
        word-wrap: break-word;
        white-space: normal;
        line-height: 1.2;
    }
    
    .analytics-details-content tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .analytics-details-content tr:hover {
        background-color: #e9ecef;
    }
    
    .analytics-details-content .vehicle-number {
        font-weight: 600;
        color: #764ba2;
        font-size: 0.7rem;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .analytics-details-content .owner-name {
        color: #495057;
        font-size: 0.7rem;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .analytics-details-content .lane-name {
        color: #6c757d;
        font-size: 0.7rem;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .analytics-details-content .time {
        color: #6c757d;
        font-size: 0.65rem;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .analytics-details-content .reader-type {
        font-weight: 600;
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        text-transform: uppercase;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .analytics-details-content .reader-type.entry {
        background: #d4edda;
        color: #155724;
    }
    
    .analytics-details-content .reader-type.exit {
        background: #f8d7da;
        color: #721c24;
    }
    
    .analytics-details-content .total-events {
        font-weight: 600;
        color: #764ba2;
        font-size: 0.7rem;
        word-wrap: break-word;
        white-space: normal;
    }
    
    /* Scrollbar styling */
    .analytics-details-content::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    
    .analytics-details-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .analytics-details-content::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        border-radius: 3px;
    }
    
    .analytics-details-content::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .analytics-chart-container {
        background: #fff;
        border-radius: 16px;
        padding: 1.2rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 12px rgba(80,80,160,0.10);
    }
    .analytics-chart-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .analytics-chart {
        width: 100%;
        height: 250px;
        margin-bottom: 1rem;
    }
    .analytics-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.8rem;
        margin-top: 1rem;
    }
    .analytics-stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 0.8rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e8e8e8;
        text-align: center;
        transition: transform 0.18s;
    }
    .analytics-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(118,75,162,0.13);
    }
    .analytics-stat-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #764ba2 0%, #ffe082 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        color: white;
        font-size: 1rem;
    }
    .analytics-stat-label {
        font-size: 0.7rem;
        color: #666;
        margin-bottom: 0.2rem;
        font-weight: 500;
    }
    .analytics-stat-value {
        font-size: 1rem;
        font-weight: 700;
        color: #333;
    }
    .analytics-stat-percentage {
        font-size: 0.8rem;
        color: #764ba2;
        font-weight: 600;
        margin-top: 0.1rem;
    }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Hardcoded Access Control
    const USER_ROLES = {
        'tenant': {
            name: 'Tenant',
            features: ['vehicle_finder', 'bank_finder', 'fastag_balance', 'fuel_price'],
            analytics: ['occupancy', 'granted', 'denied', 'trend', 'unique', 'fuel']
        },
        'service_engineer': {
            name: 'Service Engineer',
            features: ['locations', 'lanes', 'vehicle_finder', 'bank_finder', 'fastag_balance', 'fuel_price', 'reader_settings', 'barrier_control'],
            analytics: ['occupancy', 'granted', 'denied', 'trend', 'unique', 'fuel', 'barrier_control', 'controller_status']
        },
        'manager': {
            name: 'Manager',
            features: ['locations', 'lanes', 'vehicle_finder', 'bank_finder', 'fastag_balance', 'fuel_price', 'reader_settings', 'barrier_control', 'kyc_users', 'watchlist', 'analytics', 'vehicle_demographics'],
            analytics: ['occupancy', 'granted', 'denied', 'trend', 'unique', 'fuel', 'barrier_control', 'controller_status']
        },
        'superuser': {
            name: 'Superuser',
            features: ['locations', 'lanes', 'vehicle_finder', 'bank_finder', 'fastag_balance', 'fuel_price', 'reader_settings', 'barrier_control', 'kyc_users', 'watchlist', 'analytics', 'vehicle_demographics', 'reports', 'action_modal', 'all'],
            analytics: ['occupancy', 'granted', 'denied', 'trend', 'unique', 'fuel', 'barrier_control', 'controller_status', 'all']
        }
    };

    // Get current user role from session
    function getCurrentUserRole() {
        // Get user info from session
        const user = {{ session.get('user', '{}') | tojson }};
        const kycUserContact = '{{ session.get("user", {}).get("kyc_user_contact", "") }}';
        const loginMethod = '{{ session.get("user", {}).get("login_method", "") }}';
        const userRole = '{{ session.get("user", {}).get("user_role", "tenant") }}' || 'tenant';
        
        console.log('User from session:', user);
        console.log('KYC User Contact:', kycUserContact);
        console.log('Login Method:', loginMethod);
        console.log('User Role from session:', userRole);
        
        // Superuser detection - by phone number (7904030221)
        if (kycUserContact === '7904030221') {
            console.log('Superuser detected by phone number');
            return 'superuser';
        }
        
        // Use the user_role from the database
        if (userRole && userRole !== 'tenant') {
            console.log('User role from database:', userRole);
            return userRole;
        }
        
        // Default role based on login method
        if (loginMethod === 'kyc') {
            return 'tenant'; // KYC users are tenants by default
        }
        
        return userRole || 'tenant';
    }

    // Show access modal
    function showAccessModal() {
        document.getElementById('accessControlModal').style.display = 'flex';
    }

    // Close access modal
    function closeAccessModal() {
        document.getElementById('accessControlModal').style.display = 'none';
    }

    // Check if user has access to feature
    function hasFeatureAccess(feature) {
        const userRole = getCurrentUserRole();
        // Superuser has access to everything
        if (userRole === 'superuser') {
            return true;
        }
        const roleConfig = USER_ROLES[userRole] || USER_ROLES['tenant'];
        return roleConfig.features.includes(feature);
    }

    // Check if user has access to analytics
    function hasAnalyticsAccess(analyticsType) {
        const userRole = getCurrentUserRole();
        // Superuser has access to everything
        if (userRole === 'superuser') {
            return true;
        }
        const roleConfig = USER_ROLES[userRole] || USER_ROLES['tenant'];
        return roleConfig.analytics.includes(analyticsType);
    }

    // Initialize access control
    function initAccessControl() {
        const userRole = getCurrentUserRole();
        console.log('Current user role:', userRole);
        
        // If superuser, don't disable anything
        if (userRole === 'superuser') {
            console.log('Superuser detected - all features enabled');
            return;
        }
        
        // Disable feature buttons based on access
        const featureButtons = {
            'locations': document.querySelector('[onclick="openLocationsModal()"]'),
            'lanes': document.querySelector('[onclick="openLanesModal()"]'),
            'kyc_users': document.querySelector('[onclick="openKycUsersListModal()"]'),
            'watchlist': document.querySelector('[onclick="openWatchlistFromIcon()"]'),
            'analytics': document.querySelector('[onclick="showAnalyticsModal()"]'),
            'vehicle_finder': document.querySelector('[onclick="showVehicleFinderModal()"]'),
            'bank_finder': document.querySelector('[onclick="showBankFinderModal()"]'),
            'fastag_balance': document.querySelector('[onclick="showFastagBalanceModal()"]'),
            'fuel_price': document.querySelector('[onclick="showFuelPriceModal()"]'),
            'reader_settings': document.querySelector('[onclick="showReaderSettingsModal()"]'),
            'barrier_control': document.querySelector('[onclick="showBarrierModal()"]'),
            'vehicle_demographics': document.querySelector('[onclick="showVehicleDemographicsModal()"]')
        };

        Object.keys(featureButtons).forEach(feature => {
            const button = featureButtons[feature];
            if (button && !hasFeatureAccess(feature)) {
                button.classList.add('disabled');
                button.onclick = showAccessModal;
            }
        });

        // Disable analytics cards based on access
        const analyticsCards = {
            'occupancy': document.querySelector('[onclick="showAnalyticsDetails(\'occupancy\')"]'),
            'granted': document.querySelector('[onclick="showAnalyticsDetails(\'granted\')"]'),
            'denied': document.querySelector('[onclick="showAnalyticsDetails(\'denied\')"]'),
            'trend': document.querySelector('[onclick="showAnalyticsDetails(\'trend\')"]'),
            'unique': document.querySelector('[onclick="showAnalyticsDetails(\'unique\')"]'),
            'fuel': document.querySelector('[onclick="showAnalyticsDetails(\'fuel\')"]'),
            'barrier_control': document.querySelector('[onclick="showBarrierModal()"]'),
            'controller_status': document.querySelector('[onclick="showControllerStatusModal()"]')
        };

        Object.keys(analyticsCards).forEach(analyticsType => {
            const card = analyticsCards[analyticsType];
            if (card && !hasAnalyticsAccess(analyticsType)) {
                card.classList.add('disabled');
                card.onclick = showAccessModal;
            }
        });

        // Disable bottom nav buttons
        const bottomNavButtons = {
            'analytics': document.querySelector('[onclick="showAnalyticsModal()"]'),
            'reports': document.querySelector('[onclick="showReportsModal()"]'),
            'action_modal': document.querySelector('[onclick="showActionModal()"]')
        };

        Object.keys(bottomNavButtons).forEach(feature => {
            const button = bottomNavButtons[feature];
            if (button && !hasFeatureAccess(feature)) {
                button.classList.add('disabled');
                button.onclick = showAccessModal;
            }
        });
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initAccessControl();
        loadAnalyticsData();
    });

    // Auto-scroll the feature icon row slowly and smoothly
    const featureScroll = document.querySelector('.feature-scroll');
    let featureScrollInterval = null;
    let featureScrollPaused = false;
    if (featureScroll) {
        let scrollAmount = 0;
        let direction = 1;
        featureScrollInterval = setInterval(() => {
            if (featureScrollPaused) return;
            if (featureScroll.scrollWidth - featureScroll.clientWidth > 0) {
                scrollAmount += direction * 1.2;
                if (scrollAmount >= featureScroll.scrollWidth - featureScroll.clientWidth) {
                    direction = -1;
                } else if (scrollAmount <= 0) {
                    direction = 1;
                }
                featureScroll.scrollTo({ left: scrollAmount, behavior: 'smooth' });
            }
        }, 40);
        // Stop auto-scroll on any feature icon click and add haptic feedback
        document.querySelectorAll('.feature-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Trigger haptic feedback
                triggerHapticFeedback();
                
                // Stop auto-scroll
                featureScrollPaused = true;
                if (featureScrollInterval) {
                    clearInterval(featureScrollInterval);
                    featureScrollInterval = null;
                }
            });
            
            // Add hover effects for better UX
            btn.addEventListener('mouseenter', function() {
                if (!this.classList.contains('disabled')) {
                    this.style.transform = 'scale(1.1)';
                }
            });
            
            btn.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        });
        // Also stop on manual scroll (user interaction)
        featureScroll.addEventListener('mousedown', () => {
            featureScrollPaused = true;
            if (featureScrollInterval) {
                clearInterval(featureScrollInterval);
                featureScrollInterval = null;
            }
        });
        featureScroll.addEventListener('touchstart', () => {
            featureScrollPaused = true;
            if (featureScrollInterval) {
                clearInterval(featureScrollInterval);
                featureScrollInterval = null;
            }
        });
    }

    // Load analytics data
    function loadAnalyticsData() {
        // Current Occupancy
        fetch('/analytics/api/current-occupancy')
            .then(r => r.json())
            .then(data => {
                document.getElementById('card-occupancy').textContent = data.total || 0;
            })
            .catch(() => {
                document.getElementById('card-occupancy').textContent = '--';
            });

        // Today's Granted
        fetch('/analytics/api/today-granted')
            .then(r => r.json())
            .then(data => {
                document.getElementById('card-granted').textContent = data.granted || 0;
            })
            .catch(() => {
                document.getElementById('card-granted').textContent = '--';
            });

        // Denied Today
        fetch('/analytics/api/unique-tags-denied-today')
            .then(r => r.json())
            .then(data => {
                document.getElementById('card-denied').textContent = data.total || 0;
            })
            .catch(() => {
                document.getElementById('card-denied').textContent = '--';
            });

        // Unique Vehicles Today
        fetch('/analytics/api/unique-vehicles-today')
            .then(r => r.json())
            .then(data => {
                document.getElementById('card-unique').textContent = data.unique_vehicles_today || 0;
            })
            .catch(() => {
                document.getElementById('card-unique').textContent = '--';
            });

        // Activity Trend (simplified - show peak hour)
        fetch('/analytics/api/entry-exit-trend')
            .then(r => r.json())
            .then(data => {
                if (data.entry_exit_trend && data.entry_exit_trend.length > 0) {
                    // Find peak hour
                    let peakHour = '14:00';
                    let maxActivity = 0;
                    data.entry_exit_trend.forEach(hour => {
                        const total = hour[1] + hour[2];
                        if (total > maxActivity) {
                            maxActivity = total;
                            peakHour = hour[0] + ':00';
                        }
                    });
                    document.getElementById('card-trend').textContent = peakHour;
                } else {
                    document.getElementById('card-trend').textContent = '14:00';
                }
            })
            .catch(() => {
                document.getElementById('card-trend').textContent = '14:00';
            });

        // Top Fuel Type
        fetch('/analytics/api/vehicle-demographics')
            .then(r => r.json())
            .then(data => {
                if (data.fuel_types && data.fuel_types.length > 0) {
                    const topFuel = data.fuel_types[0].type;
                    document.getElementById('card-fuel').textContent = topFuel;
                } else {
                    document.getElementById('card-fuel').textContent = 'Petrol';
                }
            })
            .catch(() => {
                document.getElementById('card-fuel').textContent = 'Petrol';
            });
    }

    // Show analytics details modal
    function showAnalyticsDetails(type) {
        const modal = document.getElementById('analyticsDetailsModal');
        const icon = document.getElementById('detailsModalIcon');
        const title = document.getElementById('detailsModalTitle');
        const desc = document.getElementById('detailsModalDesc');
        const content = document.getElementById('analyticsDetailsContent');
        modal.style.display = 'flex';
        let iconHtml = '', titleText = '', descText = '', apiUrl = '', tableHtml = '';
        // Set icon, title, desc, and API endpoint for each type
        switch(type) {
            case 'occupancy':
                iconHtml = '<i class="fas fa-users"></i>';
                titleText = 'Current Occupancy Details';
                descText = 'Shows vehicles currently inside the parking facility.';
                apiUrl = '/analytics/api/current-occupancy-records';
                break;
            case 'granted':
                iconHtml = '<i class="fas fa-check-circle"></i>';
                titleText = "Today's Granted Access";
                descText = 'Number of successful vehicle entries today.';
                apiUrl = '/analytics/api/today-granted-records';
                break;
            case 'denied':
                iconHtml = '<i class="fas fa-times-circle"></i>';
                titleText = "Today's Denied Access";
                descText = 'Number of denied vehicle entries today.';
                apiUrl = '/analytics/api/denied-today-records';
                break;
            case 'trend':
                iconHtml = '<i class="fas fa-chart-line"></i>';
                titleText = 'Activity Trend';
                descText = 'Peak activity hour based on entry/exit patterns.';
                apiUrl = '/analytics/api/entry-exit-trend';
                break;
            case 'unique':
                iconHtml = '<i class="fas fa-car"></i>';
                titleText = 'Unique Vehicles Today';
                descText = 'Total number of different vehicles that accessed today.';
                apiUrl = '/analytics/api/unique-vehicles-today-records';
                break;
            case 'fuel':
                iconHtml = '<i class="fas fa-gas-pump"></i>';
                titleText = 'Top Fuel Type';
                descText = 'Most common fuel type among registered vehicles.';
                apiUrl = '/analytics/api/vehicle-demographics';
                break;
            case 'recent-activity':
                iconHtml = '<i class="fas fa-list-alt"></i>';
                titleText = 'Recent Activity (All Events)';
                descText = 'All recent access events from the system.';
                apiUrl = '/analytics/api/recent-activity';
                break;
            case 'recent-entries':
                iconHtml = '<i class="fas fa-sign-in-alt"></i>';
                titleText = 'Recent Entries';
                descText = 'Recent entry events from entry readers.';
                apiUrl = '/analytics/api/recent-entries';
                break;
            case 'recent-exits':
                iconHtml = '<i class="fas fa-sign-out-alt"></i>';
                titleText = 'Recent Exits';
                descText = 'Recent exit events from exit readers.';
                apiUrl = '/analytics/api/recent-exits';
                break;
            case 'recent-granted-tags':
                iconHtml = '<i class="fas fa-check-circle"></i>';
                titleText = 'Recent Granted Tags';
                descText = 'Recently granted access tags.';
                apiUrl = '/analytics/api/recent-granted-tags';
                break;
            case 'top-granted-tags':
                iconHtml = '<i class="fas fa-trophy"></i>';
                titleText = 'Top Granted Tags';
                descText = 'Most frequently granted tags.';
                apiUrl = '/analytics/api/top-granted-tags';
                break;
            case 'most-denied-tags':
                iconHtml = '<i class="fas fa-ban"></i>';
                titleText = 'Most Denied Tags';
                descText = 'Most frequently denied tags.';
                apiUrl = '/analytics/api/most-denied-tags';
                break;
            case 'denied-fastag-activity':
                iconHtml = '<i class="fas fa-exclamation-triangle"></i>';
                titleText = 'Denied FASTag Activity';
                descText = 'FASTag denial events and analysis.';
                apiUrl = '/analytics/api/denied-fastag-activity-feed';
                break;
        }
        icon.innerHTML = iconHtml;
        title.textContent = titleText;
        desc.textContent = descText;
        content.innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Loading...</div>';
        // Fetch and render records
        fetch(apiUrl)
            .then(r => r.json())
            .then(data => {
                // Render table/list based on type
                if(type === 'occupancy' && data.records && data.records.length) {
                    tableHtml = '<table><tr><th>Vehicle</th><th>Name</th><th>Entry Time</th></tr>' +
                        data.records.slice(0,50).map(r => 
                            `<tr><td class="vehicle-number">${r.vehicle_number}</td><td class="owner-name">${r.owner_name}</td><td class="time">${r.entry_time}</td></tr>`
                        ).join('') + '</table>';
                } else if(type === 'granted' && data.records && data.records.length) {
                    tableHtml = '<table><tr><th>Vehicle</th><th>Name</th><th>Type</th><th>Time</th></tr>' +
                        data.records.slice(0,50).map(r => 
                            `<tr><td class="vehicle-number">${r.vehicle_number}</td><td class="owner-name">${r.owner_name}</td><td class="reader-type ${r.reader_type}">${r.reader_type}</td><td class="time">${r.time}</td></tr>`
                        ).join('') + '</table>';
                } else if(type === 'denied' && data.records && data.records.length) {
                    tableHtml = '<table><tr><th>Vehicle</th><th>Name</th><th>Type</th><th>Time</th></tr>' +
                        data.records.slice(0,50).map(r => 
                            `<tr><td class="vehicle-number">${r.vehicle_number}</td><td class="owner-name">${r.owner_name}</td><td class="reader-type ${r.reader_type}">${r.reader_type}</td><td class="time">${r.time}</td></tr>`
                        ).join('') + '</table>';
                } else if(type === 'trend' && data.entry_exit_trend && data.entry_exit_trend.length) {
                    tableHtml = '<table><tr><th>Hour</th><th>Entries</th><th>Exits</th></tr>' +
                        data.entry_exit_trend.slice(0,12).map(r => `<tr><td>${r[0]}:00</td><td>${r[1]}</td><td>${r[2]}</td></tr>`).join('') + '</table>';
                } else if(type === 'unique' && data.records && data.records.length) {
                    tableHtml = '<table><tr><th>Vehicle</th><th>Name</th><th>Events</th><th>First Seen</th></tr>' +
                        data.records.slice(0,50).map(r => 
                            `<tr><td class="vehicle-number">${r.vehicle_number}</td><td class="owner-name">${r.owner_name}</td><td class="total-events">${r.total_events}</td><td class="time">${r.first_seen}</td></tr>`
                        ).join('') + '</table>';
                } else if(type === 'fuel' && data.fuel_types && data.fuel_types.length) {
                    tableHtml = '<table><tr><th>Type</th><th>Count</th><th>%</th></tr>' +
                        data.fuel_types.map(r => `<tr><td>${r.type}</td><td>${r.count}</td><td>${r.percentage}</td></tr>`).join('') + '</table>';
                } else if(type === 'recent-activity' && data.recent_activity && data.recent_activity.length) {
                    tableHtml = '<table><tr><th>Time</th><th>Vehicle</th><th>Result</th><th>Lane</th><th>Type</th></tr>' +
                        data.recent_activity.slice(0,50).map(r => 
                            `<tr><td class="time">${r.time}</td><td class="vehicle-number">${r.vehicle_number || 'N/A'}</td><td class="access-result ${r.access_result}">${r.access_result}</td><td class="lane-name">${r.lane_name}</td><td class="lane-type">${r.lane_type}</td></tr>`
                        ).join('') + '</table>';
                } else if(type === 'recent-entries' && data.recent_entries && data.recent_entries.length) {
                    tableHtml = '<table><tr><th>Time</th><th>Vehicle</th><th>Owner</th><th>Lane</th><th>Result</th></tr>' +
                        data.recent_entries.slice(0,50).map(r => 
                            `<tr><td class="time">${r.time}</td><td class="vehicle-number">${r.vehicle_number || 'N/A'}</td><td class="owner-name">${r.owner_name || 'N/A'}</td><td class="lane-name">${r.lane_name}</td><td class="access-result ${r.access_result}">${r.access_result}</td></tr>`
                        ).join('') + '</table>';
                } else if(type === 'recent-exits' && data.recent_exits && data.recent_exits.length) {
                    tableHtml = '<table><tr><th>Time</th><th>Vehicle</th><th>Owner</th><th>Lane</th><th>Result</th></tr>' +
                        data.recent_exits.slice(0,50).map(r => 
                            `<tr><td class="time">${r.time}</td><td class="vehicle-number">${r.vehicle_number || 'N/A'}</td><td class="owner-name">${r.owner_name || 'N/A'}</td><td class="lane-name">${r.lane_name}</td><td class="access-result ${r.access_result}">${r.access_result}</td></tr>`
                        ).join('') + '</table>';
                } else if(type === 'recent-granted-tags' && data.recent_granted_tags && data.recent_granted_tags.length) {
                    tableHtml = '<table><tr><th>Time</th><th>Vehicle</th><th>Owner</th><th>Lane</th><th>Type</th></tr>' +
                        data.recent_granted_tags.slice(0,50).map(r => 
                            `<tr><td class="time">${r.time}</td><td class="vehicle-number">${r.vehicle_number || 'N/A'}</td><td class="owner-name">${r.owner_name || 'N/A'}</td><td class="lane-name">${r.lane_name}</td><td class="lane-type">${r.lane_type}</td></tr>`
                        ).join('') + '</table>';
                } else if(type === 'top-granted-tags' && data.top_granted_tags && data.top_granted_tags.length) {
                    tableHtml = '<table><tr><th>Vehicle</th><th>Owner</th><th>Model</th><th>Granted Count</th></tr>' +
                        data.top_granted_tags.slice(0,50).map(r => 
                            `<tr><td class="vehicle-number">${r.vehicle_number || 'N/A'}</td><td class="owner-name">${r.owner_name || 'N/A'}</td><td class="model-name">${r.model_name || 'N/A'}</td><td class="count">${r.granted_count}</td></tr>`
                        ).join('') + '</table>';
                } else if(type === 'most-denied-tags' && data.most_denied_tags && data.most_denied_tags.length) {
                    tableHtml = '<table><tr><th>Vehicle</th><th>Owner</th><th>Model</th><th>Denied Count</th><th>Last Denied</th></tr>' +
                        data.most_denied_tags.slice(0,50).map(r => 
                            `<tr><td class="vehicle-number">${r.vehicle_number || 'N/A'}</td><td class="owner-name">${r.owner_name || 'N/A'}</td><td class="model-name">${r.model_name || 'N/A'}</td><td class="count">${r.denied_count}</td><td class="time">${r.last_denied_time || 'N/A'}</td></tr>`
                        ).join('') + '</table>';
                } else if(type === 'denied-fastag-activity' && data.results && data.results.length) {
                    tableHtml = '<table><tr><th>Time</th><th>Vehicle</th><th>Owner</th><th>Model</th><th>Reason</th></tr>' +
                        data.results.slice(0,50).map(r => 
                            `<tr><td class="time">${r.timestamp || 'N/A'}</td><td class="vehicle-number">${r.vehicle_number || 'N/A'}</td><td class="owner-name">${r.owner_name || 'N/A'}</td><td class="model-name">${r.model_name || 'N/A'}</td><td class="reason">${r.reason || 'N/A'}</td></tr>`
                        ).join('') + '</table>';
                } else {
                    tableHtml = '<div style="text-align:center;color:#aaa;padding:0.7rem;">No records found.</div>';
                }
                content.innerHTML = tableHtml;
            })
            .catch(() => {
                content.innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Failed to load records.</div>';
            });
    }
    
    function closeAnalyticsDetailsModal() {
        document.getElementById('analyticsDetailsModal').style.display = 'none';
        // Check if we came from action modal and return there
        if (window.cameFromActionModal) {
            showActionModal();
            window.cameFromActionModal = false;
        }
    }
    function closeAnalyticsModal() {
        document.getElementById('analyticsModal').style.display = 'none';
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadAnalyticsData();
        
        // Refresh data every 30 seconds
        setInterval(loadAnalyticsData, 30000);
    });

    // Handle back button to prevent accidental logout
    let backButtonPressed = false;
    
    window.addEventListener('popstate', function(event) {
        if (!backButtonPressed) {
            backButtonPressed = true;
            // Push current state to prevent immediate logout
            history.pushState(null, null, window.location.href);
            
            // Show logout confirmation
            setTimeout(() => {
                showLogoutModal();
                backButtonPressed = false;
            }, 100);
        }
    });
    
    // Prevent back button on page load
    history.pushState(null, null, window.location.href);
    
    // Logout modal functions
    function showLogoutModal() {
        document.getElementById('logoutModal').style.display = 'flex';
    }
    
    function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
    }
    
    function confirmLogout() {
        // Clear session and redirect to login
        fetch('/pwa-logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => {
            if (response.ok) {
                // Clear any local storage or session storage if needed
                localStorage.clear();
                sessionStorage.clear();
                // Redirect to login
                window.location.href = '/pwa-login';
            } else {
                // Fallback logout
                window.location.href = '/pwa-login';
            }
        }).catch(() => {
            // Fallback logout
            window.location.href = '/pwa-login';
        });
    }
    
    // Close logout modal when clicking outside
    document.getElementById('logoutModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLogoutModal();
        }
    });

    // Action modal functions
    function showActionModal() {
        document.getElementById('actionModal').style.display = 'flex';
    }
    
    function closeActionModal() {
        document.getElementById('actionModal').style.display = 'none';
    }
    
    function showRecentActivity() {
        document.getElementById('actionModal').style.display = 'none';
        window.cameFromActionModal = true;
        showAnalyticsDetails('recent-activity');
    }
    
    function showRecentEntries() {
        document.getElementById('actionModal').style.display = 'none';
        window.cameFromActionModal = true;
        showAnalyticsDetails('recent-entries');
    }
    
    function showRecentExits() {
        document.getElementById('actionModal').style.display = 'none';
        window.cameFromActionModal = true;
        showAnalyticsDetails('recent-exits');
    }
    
    function showRecentGrantedTags() {
        document.getElementById('actionModal').style.display = 'none';
        window.cameFromActionModal = true;
        showAnalyticsDetails('recent-granted-tags');
    }
    
    function showTopGrantedTags() {
        document.getElementById('actionModal').style.display = 'none';
        window.cameFromActionModal = true;
        showAnalyticsDetails('top-granted-tags');
    }
    
    function showMostDeniedTags() {
        document.getElementById('actionModal').style.display = 'none';
        window.cameFromActionModal = true;
        showAnalyticsDetails('most-denied-tags');
    }
    
    function showDeniedFastagActivity() {
        document.getElementById('actionModal').style.display = 'none';
        window.cameFromActionModal = true;
        showAnalyticsDetails('denied-fastag-activity');
    }
    
    // Close action modal when clicking outside
    document.getElementById('actionModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeActionModal();
        }
    });

    // Reader Settings modal functions
    function showReaderSettingsModal() {
        document.getElementById('readerSettingsModal').style.display = 'flex';
        loadReadersData();
    }
    
    function closeReaderSettingsModal() {
        document.getElementById('readerSettingsModal').style.display = 'none';
    }
    
    function updateReaderStats(total = 0, online = 0, offline = 0) {
        // If no parameters provided, count from existing cards
        if (total === 0) {
            const cards = document.querySelectorAll('.reader-card');
            total = cards.length;
            online = document.querySelectorAll('.status-text:not(.offline)').length;
            offline = document.querySelectorAll('.status-text.offline').length;
        }
        
        document.getElementById('total-readers').textContent = total;
        document.getElementById('online-readers').textContent = online;
        document.getElementById('offline-readers').textContent = offline;
    }
    
    function loadReadersData() {
        const container = document.getElementById('readers-container');
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: white;"><span class="loading"></span> Loading readers...</div>';
        
        // Use the working separate page approach - fetch the full page and extract content
        fetch('/reader-settings')
            .then(response => response.text())
            .then(html => {
                // Parse the HTML and extract the readers container
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const readersContainer = doc.getElementById('readers-container');
                
                if (readersContainer && readersContainer.innerHTML.trim() !== '') {
                    container.innerHTML = readersContainer.innerHTML;
                    // Initialize all readers after loading
                    const readers = container.querySelectorAll('.reader-card');
                    readers.forEach(reader => {
                        const readerId = reader.getAttribute('data-reader-id');
                        getReaderPower(readerId);
                    });
                } else {
                    // If no readers found in the response, fetch them directly from the API
                    fetch('/api/readers')
                        .then(response => response.json())
                        .then(data => {
                            if (data.readers && data.readers.length > 0) {
                                let html = '';
                                let onlineCount = 0;
                                let offlineCount = 0;
                                
                                data.readers.forEach(reader => {
                                    // Determine status color and class based on backend status
                                    let statusColor = '#dc3545'; // offline
                                    let statusClass = 'offline';
                                    
                                    if (reader.status === 'online') {
                                        statusColor = '#28a745';
                                        statusClass = '';
                                        onlineCount++;
                                    } else if (reader.status === 'idle') {
                                        statusColor = '#ffc107';
                                        statusClass = 'idle';
                                        onlineCount++;
                                    } else {
                                        offlineCount++;
                                    }
                                    
                                    html += `
                                        <div class="reader-card" data-reader-id="${reader.id}">
                                            <div class="reader-header">
                                                <div class="reader-icon">
                                                    <i class="fas fa-broadcast-tower"></i>
                                                </div>
                                                <div class="reader-info">
                                                    <div class="reader-name">Reader ${reader.id}</div>
                                                    <div class="reader-details">${reader.type || 'Unknown'} • ${reader.lane_name || 'Unknown'} • ${reader.location_name || 'Unknown'}</div>
                                                    <div class="reader-activity">${reader.last_event} • ${reader.events_24h} events (24h)</div>
                                                </div>
                                            </div>
                                            
                                            <div class="reader-status">
                                                <span class="status-dot" id="status-${reader.id}" style="background: ${statusColor};"></span>
                                                <span class="status-text ${statusClass}" id="status-text-${reader.id}">${reader.status.charAt(0).toUpperCase() + reader.status.slice(1)}</span>
                                            </div>
                                            
                                            <div class="power-control">
                                                <div class="power-display">
                                                    <div class="power-label">Current RF Power</div>
                                                    <div class="power-value" id="power-${reader.id}">--</div>
                                                </div>
                                                <div class="power-input">
                                                    <input type="number" 
                                                           id="power-input-${reader.id}" 
                                                           min="1" 
                                                           max="30" 
                                                           placeholder="1-30"
                                                           class="power-input-field">
                                                    <button class="power-set-btn" 
                                                            onclick="setReaderPower(${reader.id})"
                                                            id="set-btn-${reader.id}">
                                                        Set
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div id="feedback-${reader.id}" class="feedback" style="display: none;"></div>
                                        </div>
                                    `;
                                });
                                container.innerHTML = html;
                                
                                // Initialize all readers
                                data.readers.forEach(reader => {
                                    getReaderPower(reader.id);
                                });
                            } else {
                                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-broadcast-tower" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i><div>No readers configured</div></div>';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching readers:', error);
                            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading readers</div></div>';
                        });
                }
            })
            .catch(error => {
                console.error('Error loading readers:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading readers</div></div>';
            });
    }
    
    function getReaderPower(readerId) {
        const statusDot = document.getElementById(`status-${readerId}`);
        const statusText = document.getElementById(`status-text-${readerId}`);
        const powerValue = document.getElementById(`power-${readerId}`);
        const setBtn = document.getElementById(`set-btn-${readerId}`);
        
        if (!statusDot || !statusText || !powerValue || !setBtn) return;
        
        // Show loading state
        statusText.innerHTML = '<span class="loading"></span> Checking...';
        setBtn.disabled = true;
        
        // Always try to get RF power regardless of status
        fetch(`/api/rfid/rfpower?reader=${readerId}`)
            .then(response => response.json())
            .then(data => {
                if (data.rf_power !== undefined) {
                    powerValue.textContent = data.rf_power;
                    // Enable power setting regardless of activity status
                    setBtn.disabled = false;
                    
                    // Update status to show RF power is accessible
                    statusDot.style.background = '#28a745';
                    statusText.textContent = 'Online';
                    statusText.className = 'status-text';
                } else {
                    powerValue.textContent = '--';
                    setBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error fetching power:', error);
                powerValue.textContent = '--';
                setBtn.disabled = true;
                // Don't change the status display - keep the backend-determined status
            });
    }
    
    function setReaderPower(readerId) {
        const powerInput = document.getElementById(`power-input-${readerId}`);
        const setBtn = document.getElementById(`set-btn-${readerId}`);
        const feedback = document.getElementById(`feedback-${readerId}`);
        
        if (!powerInput || !setBtn || !feedback) return;
        
        const newPower = parseInt(powerInput.value);
        
        if (!newPower || newPower < 1 || newPower > 30) {
            showFeedback(readerId, 'Please enter a valid power value (1-30)', 'error');
            return;
        }
        
        // Show loading state
        setBtn.innerHTML = '<span class="loading"></span>';
        setBtn.disabled = true;
        hideFeedback(readerId);
        
        fetch(`/api/rfid/rfpower`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reader_id: readerId, rf_power: newPower })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showFeedback(readerId, data.message, 'success');
                document.getElementById(`power-${readerId}`).textContent = data.rf_power;
                powerInput.value = '';
            } else if (data.status === 'warning') {
                showFeedback(readerId, data.message, 'warning');
                if (data.rf_power) {
                    document.getElementById(`power-${readerId}`).textContent = data.rf_power;
                }
            } else {
                showFeedback(readerId, data.error || 'Failed to set power', 'error');
            }
        })
        .catch(error => {
            console.error('Error setting power:', error);
            showFeedback(readerId, 'Network error. Please try again.', 'error');
        })
        .finally(() => {
            setBtn.innerHTML = 'Set';
            setBtn.disabled = false;
        });
    }
    
    function showFeedback(readerId, message, type) {
        const feedback = document.getElementById(`feedback-${readerId}`);
        if (!feedback) return;
        
        feedback.textContent = message;
        feedback.className = `feedback ${type}`;
        feedback.style.display = 'block';
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            hideFeedback(readerId);
        }, 5000);
    }
    
    function hideFeedback(readerId) {
        const feedback = document.getElementById(`feedback-${readerId}`);
        if (feedback) {
            feedback.style.display = 'none';
        }
    }
    
    // Close reader settings modal when clicking outside
    document.getElementById('readerSettingsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReaderSettingsModal();
        }
    });

    // Fuel Price modal functions
    function showFuelPriceModal() {
        document.getElementById('fuelPriceModal').style.display = 'flex';
        loadFuelPrices();
    }
    
    function closeFuelPriceModal() {
        document.getElementById('fuelPriceModal').style.display = 'none';
    }
    
    function loadFuelPrices() {
        const container = document.getElementById('fuelPriceContainer');
        const citySelect = document.getElementById('fuelPriceCitySelect');
        
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><span class="loading"></span> Loading fuel prices...</div>';
        
        fetch('/pwa-dashboard/api/fuel-price')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.prices) {
                    // Populate city dropdown
                    citySelect.innerHTML = '<option value="">All Cities</option>';
                    data.cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                    
                    // Display prices
                    displayFuelPrices(data.prices);
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Unable to fetch fuel prices</div></div>';
                }
            })
            .catch(error => {
                console.error('Error fetching fuel prices:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading fuel prices</div></div>';
            });
    }
    
    function displayFuelPrices(prices) {
        const container = document.getElementById('fuelPriceContainer');
        
        if (prices.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-gas-pump" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i><div>No fuel prices available</div></div>';
            return;
        }
        
        let html = '<div style="max-height: 45vh; overflow-y: auto;">';
        html += '<div style="display: grid; gap: 0.8rem;">';
        
        prices.forEach(price => {
            html += `
                <div class="fuel-price-card">
                    <div class="fuel-price-header">
                        <div>
                            <div class="fuel-price-city">${price.city}</div>
                            <div class="fuel-price-label">Petrol Price</div>
                        </div>
                        <div class="fuel-price-value">
                            ${price.price}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div></div>';
        container.innerHTML = html;
    }
    
    function toggleFuelPriceSearch() {
        const searchBox = document.getElementById('fuelPriceSearchBox');
        const searchBtn = document.querySelector('[onclick="toggleFuelPriceSearch()"]');
        
        if (searchBox.style.display === 'none') {
            searchBox.style.display = 'block';
            searchBtn.innerHTML = '<i class="fas fa-times"></i>';
            searchBtn.title = 'Close Search';
        } else {
            searchBox.style.display = 'none';
            searchBtn.innerHTML = '<i class="fas fa-search"></i>';
            searchBtn.title = 'Search';
        }
    }
    
    function filterFuelPrices() {
        const citySelect = document.getElementById('fuelPriceCitySelect');
        const selectedCity = citySelect.value;
        
        if (!selectedCity) {
            // Reload all prices
            loadFuelPrices();
        } else {
            // Filter by selected city
            fetch(`/pwa-dashboard/api/fuel-price?city=${encodeURIComponent(selectedCity)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.prices) {
                        displayFuelPrices(data.prices);
                    }
                })
                .catch(error => {
                    console.error('Error filtering fuel prices:', error);
                });
        }
    }
    
    // Close fuel price modal when clicking outside
    document.getElementById('fuelPriceModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeFuelPriceModal();
        }
    });

    // Vehicle Demographics modal functions
    function showVehicleDemographicsModal() {
        document.getElementById('vehicleDemographicsModal').style.display = 'flex';
        loadVehicleDemographics();
    }
    
    function closeVehicleDemographicsModal() {
        document.getElementById('vehicleDemographicsModal').style.display = 'none';
    }
    
    function loadVehicleDemographics() {
        const container = document.getElementById('demographicsContainer');
        
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><span class="loading"></span> Loading demographics...</div>';
        
        fetch('/analytics/api/vehicle-demographics')
            .then(response => response.json())
            .then(data => {
                if (data.fuel_types && data.top_models) {
                    displayVehicleDemographics(data);
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-chart-pie" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i><div>No demographics data available</div></div>';
                }
            })
            .catch(error => {
                console.error('Error fetching demographics:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading demographics</div></div>';
            });
    }
    
    function displayVehicleDemographics(data) {
        const container = document.getElementById('demographicsContainer');
        
        let html = '';
        
        // Chart container
        html += '<div class="demographics-chart-container">';
        html += '<div style="font-weight: 600; color: #333; margin-bottom: 1rem; font-size: 1.1rem;">Fuel Type Distribution</div>';
        html += '<div class="demographics-chart">';
        html += '<canvas id="demographicsChart"></canvas>';
        html += '</div>';
        html += '</div>';
        
        // Stats grid
        html += '<div class="demographics-stats-grid">';
        
        // Top fuel type
        const topFuel = data.fuel_types[0] || { type: 'Unknown', percentage: 0 };
        html += `
            <div class="demo-stat-card">
                <div class="demo-stat-icon">
                    <i class="fas fa-gas-pump"></i>
                </div>
                <div class="demo-stat-label">Top Fuel Type</div>
                <div class="demo-stat-value">${topFuel.type}</div>
                <div class="demo-stat-percentage">${topFuel.percentage}%</div>
            </div>
        `;
        
        // Top model
        const topModel = data.top_models[0] || { model: 'Unknown', percentage: 0 };
        html += `
            <div class="demo-stat-card">
                <div class="demo-stat-icon">
                    <i class="fas fa-car"></i>
                </div>
                <div class="demo-stat-label">Top Model</div>
                <div class="demo-stat-value">${topModel.model}</div>
                <div class="demo-stat-percentage">${topModel.percentage}%</div>
            </div>
        `;
        
        // Year range
        const yearAnalysis = data.year_analysis || { range: 'Unknown', count: 0 };
        html += `
            <div class="demo-stat-card">
                <div class="demo-stat-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="demo-stat-label">Year Range</div>
                <div class="demo-stat-value">${yearAnalysis.range}</div>
                <div class="demo-stat-percentage">${yearAnalysis.count} vehicles</div>
            </div>
        `;
        
        // Total vehicles
        const totalVehicles = data.fuel_types.reduce((sum, fuel) => sum + fuel.count, 0);
        html += `
            <div class="demo-stat-card">
                <div class="demo-stat-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="demo-stat-label">Total Vehicles</div>
                <div class="demo-stat-value">${totalVehicles}</div>
                <div class="demo-stat-percentage">in database</div>
            </div>
        `;
        
        html += '</div>';
        
        container.innerHTML = html;
        
        // Create the chart after the HTML is inserted
        createDemographicsChart(data.fuel_types);
    }
    
    function createDemographicsChart(fuelTypes) {
        const canvas = document.getElementById('demographicsChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Prepare chart data
        const labels = fuelTypes.map(f => f.type);
        const values = fuelTypes.map(f => f.percentage);
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 2,
                    borderColor: '#FFFFFF'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 8,
                            usePointStyle: true,
                            font: { size: 10 },
                            boxWidth: 8
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed}%`;
                            }
                        }
                    }
                }
            }
        });
    }
    
        // Close vehicle demographics modal when clicking outside
    document.getElementById('vehicleDemographicsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeVehicleDemographicsModal();
        }
    });

    // Analytics Modal Functions
    // Analytics Modal Variables
    let currentAnalyticsSlide = 0;
    const analyticsSlides = [
        { name: 'vehicle-demographics', title: 'Vehicle Demographics' },
        { name: 'fastag-vs-nonfastag', title: 'FASTag vs Non-FASTag (Today)' },
        { name: 'overstayed-vehicles', title: 'OVERSTAYED VEHICLES' },
        { name: 'unique-vehicles', title: 'UNIQUE VEHICLES TODAY' },
        { name: 'entry-exit-trend', title: 'Entry/Exit Trend (Today)' },
        { name: 'reader-health', title: 'Reader Health Dashboard' },
        { name: 'peak-predictions', title: 'Peak Time Predictions' }
    ];
    
    function showAnalyticsModal() {
        const modal = document.getElementById('analyticsModal');
        if (!modal) {
            return;
        }
        modal.style.display = 'flex';
        currentAnalyticsSlide = 0;
        loadAnalyticsSlide(0);
        updateNavigation();
    }
    
    function closeAnalyticsModal() {
        document.getElementById('analyticsModal').style.display = 'none';
    }
    
    function nextAnalyticsSlide() {
        if (currentAnalyticsSlide < analyticsSlides.length - 1) {
            currentAnalyticsSlide++;
            loadAnalyticsSlide(currentAnalyticsSlide);
            updateNavigation();
        }
    }
    
    function previousAnalyticsSlide() {
        if (currentAnalyticsSlide > 0) {
            currentAnalyticsSlide--;
            loadAnalyticsSlide(currentAnalyticsSlide);
            updateNavigation();
        }
    }
    
    function updateNavigation() {
        const prevArrow = document.getElementById('prevArrow');
        const nextArrow = document.getElementById('nextArrow');
        const slideIndicator = document.getElementById('slideIndicator');
        
        prevArrow.style.display = currentAnalyticsSlide > 0 ? 'flex' : 'none';
        nextArrow.style.display = currentAnalyticsSlide < analyticsSlides.length - 1 ? 'flex' : 'none';
        slideIndicator.textContent = `${currentAnalyticsSlide + 1} of ${analyticsSlides.length}`;
    }
    
    function loadAnalyticsSlide(slideIndex) {
        const container = document.getElementById('analyticsContent');
        const slide = analyticsSlides[slideIndex];
        
        if (!container || !slide) {
            return;
        }
        
        // Show loading
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><span class="loading"></span> Loading ' + slide.title + '...</div>';
        
        switch (slide.name) {
            case 'vehicle-demographics':
                loadVehicleDemographicsSlide();
                break;
            case 'fastag-vs-nonfastag':
                loadFastagVsNonfastagSlide();
                break;
            case 'overstayed-vehicles':
                loadOverstayedVehiclesSlide();
                break;
            case 'unique-vehicles':
                loadUniqueVehiclesSlide();
                break;
            case 'entry-exit-trend':
                loadEntryExitTrendSlide();
                break;
            case 'reader-health':
                loadReaderHealthSlide();
                break;
            case 'peak-predictions':
                loadPeakPredictionsSlide();
                break;
        }
    }
    
    function loadVehicleDemographicsSlide() {
        const container = document.getElementById('analyticsContent');
        
        fetch('/analytics/api/vehicle-demographics')
            .then(response => response.json())
            .then(data => {
                if (data.fuel_types && data.top_models) {
                    displayVehicleDemographicsForAnalytics(data);
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-chart-pie" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i><div>No demographics data available</div></div>';
                }
            })
            .catch(error => {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading demographics</div></div>';
            });
    }
    
    function loadFastagVsNonfastagSlide() {
        const container = document.getElementById('analyticsContent');
        
        fetch('/analytics/api/fastag-vs-nonfastag')
            .then(response => response.json())
            .then(data => {
                let html = '<div class="analytics-chart-container">';
                html += '<div class="analytics-chart-title"><i class="fas fa-chart-pie"></i>FASTag vs Non-FASTag (Today)</div>';
                html += '<div class="analytics-chart"><canvas id="fastagVsNonfastagChart"></canvas></div>';
                html += '</div>';
                
                html += '<div class="analytics-stats-grid">';
                const fastagCount = data.fastag || 0;
                const nonfastagCount = data.nonfastag || 0;
                const total = fastagCount + nonfastagCount;
                const fastagPercentage = total > 0 ? Math.round((fastagCount / total) * 100) : 0;
                const nonfastagPercentage = total > 0 ? Math.round((nonfastagCount / total) * 100) : 0;
                
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-tag"></i></div>
                        <div class="analytics-stat-label">FASTag</div>
                        <div class="analytics-stat-value">${fastagCount}</div>
                        <div class="analytics-stat-percentage">${fastagPercentage}%</div>
                    </div>
                `;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-times-circle"></i></div>
                        <div class="analytics-stat-label">Non-FASTag</div>
                        <div class="analytics-stat-value">${nonfastagCount}</div>
                        <div class="analytics-stat-percentage">${nonfastagPercentage}%</div>
                    </div>
                `;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-percentage"></i></div>
                        <div class="analytics-stat-label">Total</div>
                        <div class="analytics-stat-value">${total}</div>
                        <div class="analytics-stat-percentage">vehicles</div>
                    </div>
                `;
                html += '</div>';
                
                container.innerHTML = html;
                createFastagVsNonfastagChart(data);
            })
            .catch(error => {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading FASTag data</div></div>';
            });
    }
    
    function loadOverstayedVehiclesSlide() {
        const container = document.getElementById('analyticsContent');
        
        fetch('/analytics/api/overstayed-vehicles')
            .then(response => response.json())
            .then(data => {
                let html = '<div class="analytics-chart-container">';
                html += '<div class="analytics-chart-title"><i class="fas fa-exclamation-triangle"></i>OVERSTAYED VEHICLES</div>';
                html += '<div class="analytics-chart"><canvas id="overstayedVehiclesChart"></canvas></div>';
                html += '</div>';
                
                html += '<div class="analytics-stats-grid">';
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="analytics-stat-label">Avg Duration</div>
                        <div class="analytics-stat-value">${data.avg_duration || '2.5h'}</div>
                        <div class="analytics-stat-percentage">average</div>
                    </div>
                `;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-arrow-up"></i></div>
                        <div class="analytics-stat-label">Trend</div>
                        <div class="analytics-stat-value">+${data.trend || '12'}%</div>
                        <div class="analytics-stat-percentage">increase</div>
                    </div>
                `;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-car"></i></div>
                        <div class="analytics-stat-label">Total</div>
                        <div class="analytics-stat-value">${data.total || 73}</div>
                        <div class="analytics-stat-percentage">vehicles</div>
                    </div>
                `;
                html += '</div>';
                
                container.innerHTML = html;
                createOverstayedVehiclesChart(data);
            })
            .catch(error => {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading overstayed vehicles data</div></div>';
            });
    }
    
    function loadUniqueVehiclesSlide() {
        const container = document.getElementById('analyticsContent');
        
        fetch('/analytics/api/unique-vehicles-today')
            .then(response => response.json())
            .then(data => {
                let html = '<div class="analytics-chart-container">';
                html += '<div class="analytics-chart-title"><i class="fas fa-car"></i>UNIQUE VEHICLES TODAY</div>';
                html += '<div class="analytics-chart"><canvas id="uniqueVehiclesChart"></canvas></div>';
                html += '</div>';
                
                html += '<div class="analytics-stats-grid">';
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-tag"></i></div>
                        <div class="analytics-stat-label">FASTag</div>
                        <div class="analytics-stat-value">${data.fastag_count || 27}</div>
                        <div class="analytics-stat-percentage">vehicles</div>
                    </div>
                `;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="analytics-stat-label">Peak Hour</div>
                        <div class="analytics-stat-value">${data.peak_hour || '14:00'}</div>
                        <div class="analytics-stat-percentage">busiest time</div>
                    </div>
                `;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-car"></i></div>
                        <div class="analytics-stat-label">Total</div>
                        <div class="analytics-stat-value">${data.total || 39}</div>
                        <div class="analytics-stat-percentage">unique vehicles</div>
                    </div>
                `;
                html += '</div>';
                
                container.innerHTML = html;
                createUniqueVehiclesChart(data);
            })
            .catch(error => {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading unique vehicles data</div></div>';
            });
    }
    
    function loadEntryExitTrendSlide() {
        const container = document.getElementById('analyticsContent');
        
        fetch('/analytics/api/entry-exit-trend')
            .then(response => response.json())
            .then(data => {
                let html = '<div class="analytics-chart-container">';
                html += '<div class="analytics-chart-title"><i class="fas fa-chart-line"></i>Entry/Exit Trend (Today)</div>';
                html += '<div class="analytics-chart"><canvas id="entryExitTrendChart"></canvas></div>';
                html += '</div>';
                
                html += '<div class="analytics-stats-grid">';
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-sign-in-alt"></i></div>
                        <div class="analytics-stat-label">Total Entries</div>
                        <div class="analytics-stat-value">${data.total_entries || 0}</div>
                        <div class="analytics-stat-percentage">today</div>
                    </div>
                `;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-sign-out-alt"></i></div>
                        <div class="analytics-stat-label">Total Exits</div>
                        <div class="analytics-stat-value">${data.total_exits || 0}</div>
                        <div class="analytics-stat-percentage">today</div>
                    </div>
                `;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-percentage"></i></div>
                        <div class="analytics-stat-label">Peak Time</div>
                        <div class="analytics-stat-value">${data.peak_time || '02:00'}</div>
                        <div class="analytics-stat-percentage">busiest hour</div>
                    </div>
                `;
                html += '</div>';
                
                container.innerHTML = html;
                createEntryExitTrendChart(data);
            })
            .catch(error => {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading entry/exit trend data</div></div>';
            });
    }
    
    function loadReaderHealthSlide() {
        const container = document.getElementById('analyticsContent');
        
        // Use the same API that works well in reader settings
        fetch('/api/readers')
            .then(response => response.json())
            .then(data => {
                if (!data.success || !data.readers || data.readers.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-heart" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i><div>No reader health data available</div></div>';
                    return;
                }
                
                let html = '<div class="analytics-chart-container">';
                html += '<div class="analytics-chart-title"><i class="fas fa-heart"></i>Reader Health Dashboard</div>';
                html += '<div class="analytics-chart"><canvas id="readerHealthChart"></canvas></div>';
                html += '</div>';
                
                html += '<div class="analytics-stats-grid">';
                
                // Calculate stats from real reader data
                const onlineReaders = data.readers.filter(r => r.status === 'online').length;
                const idleReaders = data.readers.filter(r => r.status === 'idle').length;
                const offlineReaders = data.readers.filter(r => r.status === 'offline').length;
                const totalReaders = data.readers.length;
                
                // Online Readers
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-circle" style="color: #28a745;"></i></div>
                        <div class="analytics-stat-label">Online Readers</div>
                        <div class="analytics-stat-value">${onlineReaders}</div>
                        <div class="analytics-stat-percentage">of ${totalReaders}</div>
                    </div>
                `;
                
                // Events Last 24h
                const totalEvents24h = data.readers.reduce((sum, r) => sum + (r.events_24h || 0), 0);
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-chart-line" style="color: #007bff;"></i></div>
                        <div class="analytics-stat-label">Events (24h)</div>
                        <div class="analytics-stat-value">${totalEvents24h}</div>
                        <div class="analytics-stat-percentage">total</div>
                    </div>
                `;
                
                // Health Score
                const healthScore = totalReaders > 0 ? Math.round((onlineReaders / totalReaders) * 100) : 0;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-heart"></i></div>
                        <div class="analytics-stat-label">Health Score</div>
                        <div class="analytics-stat-value">${healthScore}%</div>
                        <div class="analytics-stat-percentage">online rate</div>
                    </div>
                `;
                
                html += '</div>';
                
                container.innerHTML = html;
                createReaderHealthChart(data.readers);
            })
            .catch(error => {
                console.error('Error loading reader health:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading reader health data</div></div>';
            });
    }
    
    function loadPeakPredictionsSlide() {
        const container = document.getElementById('analyticsContent');
        
        fetch('/analytics/api/peak-predictions')
            .then(response => response.json())
            .then(data => {
                let html = '<div class="analytics-chart-container">';
                html += '<div class="analytics-chart-title"><i class="fas fa-brain"></i>Peak Time Predictions</div>';
                html += '<div class="analytics-chart"><canvas id="peakPredictionsChart"></canvas></div>';
                html += '</div>';
                
                html += '<div class="analytics-stats-grid">';
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-arrow-up"></i></div>
                        <div class="analytics-stat-label">Next Peak</div>
                        <div class="analytics-stat-value">${data.next_peak || '04:00-06:00'}</div>
                        <div class="analytics-stat-percentage">predicted</div>
                    </div>
                `;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="analytics-stat-label">Expected</div>
                        <div class="analytics-stat-value">${data.expected_range || '77-87'}</div>
                        <div class="analytics-stat-percentage">vehicles</div>
                    </div>
                `;
                html += `
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon"><i class="fas fa-brain"></i></div>
                        <div class="analytics-stat-label">Confidence</div>
                        <div class="analytics-stat-value">${data.confidence || '95'}%</div>
                        <div class="analytics-stat-percentage">accuracy</div>
                    </div>
                `;
                html += '</div>';
                
                container.innerHTML = html;
                createPeakPredictionsChart(data);
            })
            .catch(error => {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading peak predictions data</div></div>';
            });
    }
    
    function displayVehicleDemographicsForAnalytics(data) {
        const container = document.getElementById('analyticsContent');
        
        let html = '';
        
        // Chart container
        html += '<div class="analytics-chart-container">';
        html += '<div class="analytics-chart-title"><i class="fas fa-chart-pie"></i>Fuel Type Distribution</div>';
        html += '<div class="analytics-chart"><canvas id="analyticsDemographicsChart"></canvas></div>';
        html += '</div>';
        
        // Stats grid
        html += '<div class="analytics-stats-grid">';
        
        // Top fuel type
        const topFuel = data.fuel_types[0] || { type: 'Unknown', percentage: 0 };
        html += `
            <div class="analytics-stat-card">
                <div class="analytics-stat-icon"><i class="fas fa-gas-pump"></i></div>
                <div class="analytics-stat-label">Top Fuel Type</div>
                <div class="analytics-stat-value">${topFuel.type}</div>
                <div class="analytics-stat-percentage">${topFuel.percentage}%</div>
            </div>
        `;
        
        // Top model
        const topModel = data.top_models[0] || { model: 'Unknown', percentage: 0 };
        html += `
            <div class="analytics-stat-card">
                <div class="analytics-stat-icon"><i class="fas fa-car"></i></div>
                <div class="analytics-stat-label">Top Model</div>
                <div class="analytics-stat-value">${topModel.model}</div>
                <div class="analytics-stat-percentage">${topModel.percentage}%</div>
            </div>
        `;
        
        // Year range
        const yearAnalysis = data.year_analysis || { range: 'Unknown', count: 0 };
        html += `
            <div class="analytics-stat-card">
                <div class="analytics-stat-icon"><i class="fas fa-calendar-alt"></i></div>
                <div class="analytics-stat-label">Year Range</div>
                <div class="analytics-stat-value">${yearAnalysis.range}</div>
                <div class="analytics-stat-percentage">${yearAnalysis.count} vehicles</div>
            </div>
        `;
        
        // Total vehicles
        const totalVehicles = data.fuel_types.reduce((sum, fuel) => sum + fuel.count, 0);
        html += `
            <div class="analytics-stat-card">
                <div class="analytics-stat-icon"><i class="fas fa-database"></i></div>
                <div class="analytics-stat-label">Total Vehicles</div>
                <div class="analytics-stat-value">${totalVehicles}</div>
                <div class="analytics-stat-percentage">in database</div>
            </div>
        `;
        
        html += '</div>';
        
        container.innerHTML = html;
        
        // Create the chart after the HTML is inserted
        createAnalyticsDemographicsChart(data.fuel_types);
    }
    
    function createAnalyticsDemographicsChart(fuelTypes) {
        const canvas = document.getElementById('analyticsDemographicsChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Prepare chart data
        const labels = fuelTypes.map(f => f.type);
        const values = fuelTypes.map(f => f.percentage);
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 2,
                    borderColor: '#FFFFFF'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 8,
                            usePointStyle: true,
                            font: { size: 10 },
                            boxWidth: 8
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed}%`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    function createFastagVsNonfastagChart(data) {
        const canvas = document.getElementById('fastagVsNonfastagChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['FASTag', 'Non-FASTag'],
                datasets: [{
                    data: [data.fastag || 0, data.nonfastag || 0],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 2,
                    borderColor: '#FFFFFF'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 8,
                            usePointStyle: true,
                            font: { size: 12 },
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff'
                    }
                }
            }
        });
    }
    
    function createOverstayedVehiclesChart(data) {
        const canvas = document.getElementById('overstayedVehiclesChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Generate sample trend data
        const labels = ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'];
        const trendData = [65, 68, 71, 73, 70, 73];
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Overstayed Vehicles',
                    data: trendData,
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4,
                    pointBackgroundColor: '#ffc107',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { maxTicksLimit: 6 }
                    },
                    x: {
                        ticks: { maxTicksLimit: 6 }
                    }
                }
            }
        });
    }
    
    function createUniqueVehiclesChart(data) {
        const canvas = document.getElementById('uniqueVehiclesChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Generate sample trend data
        const labels = ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'];
        const trendData = [25, 28, 32, 35, 39, 39];
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Unique Vehicles',
                    data: trendData,
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4,
                    pointBackgroundColor: '#ffc107',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { maxTicksLimit: 6 }
                    },
                    x: {
                        ticks: { maxTicksLimit: 6 }
                    }
                }
            }
        });
    }
    
    function createEntryExitTrendChart(data) {
        const canvas = document.getElementById('entryExitTrendChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Generate sample data based on the image
        const labels = ['00:00', '01:00', '02:00', '03:00', '04:00'];
        const entryData = [2, 5, 12, 8, 3];
        const exitData = [0, 0, 0, 0, 0];
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Entries',
                    data: entryData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    pointBackgroundColor: '#28a745',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }, {
                    label: 'Exits',
                    data: exitData,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    pointBackgroundColor: '#007bff',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            padding: 10
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { maxTicksLimit: 6 }
                    },
                    x: {
                        ticks: { maxTicksLimit: 5 }
                    }
                }
            }
        });
    }
    
    function createReaderHealthChart(readers) {
        const canvas = document.getElementById('readerHealthChart');
        if (!canvas || !readers || readers.length === 0) return;
        
        const ctx = canvas.getContext('2d');
        
        // Create real data from reader information
        const labels = readers.map(r => `Reader ${r.id} (${r.type})`);
        const statusData = readers.map(r => {
            switch(r.status) {
                case 'online': return 100;
                case 'idle': return 50;
                case 'offline': return 0;
                default: return 0;
            }
        });
        const eventData = readers.map(r => r.events_24h || 0);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Status Score',
                    data: statusData,
                    backgroundColor: statusData.map(score => {
                        if (score === 100) return '#28a745'; // Online - Green
                        if (score === 50) return '#ffc107';  // Idle - Yellow
                        return '#dc3545'; // Offline - Red
                    }),
                    borderColor: statusData.map(score => {
                        if (score === 100) return '#28a745';
                        if (score === 50) return '#ffc107';
                        return '#dc3545';
                    }),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const reader = readers[context.dataIndex];
                                return [
                                    `Status: ${reader.status}`,
                                    `Events (24h): ${reader.events_24h}`,
                                    `Last Event: ${reader.last_event}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { 
                            maxTicksLimit: 6,
                            callback: function(value) {
                                if (value === 100) return 'Online';
                                if (value === 50) return 'Idle';
                                if (value === 0) return 'Offline';
                                return value;
                            }
                        }
                    },
                    x: {
                        ticks: { maxTicksLimit: 4 }
                    }
                }
            }
        });
    }
    
    function createPeakPredictionsChart(data) {
        const canvas = document.getElementById('peakPredictionsChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Generate sample data based on the image
        const labels = ['00', '03', '06', '09', '12', '15', '18', '22'];
        const predictionData = [20, 15, 85, 45, 90, 95, 60, 30];
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Predicted Activity',
                    data: predictionData,
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.2)',
                    tension: 0.4,
                    pointBackgroundColor: '#764ba2',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { maxTicksLimit: 6 }
                    },
                    x: {
                        ticks: { maxTicksLimit: 8 }
                    }
                }
            }
        });
    }
    
    function loadHourlyActivity() {
        const container = document.getElementById('analyticsContent');
        
        if (!container) {
            return;
        }
        
        // Show loading
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><span class="loading"></span> Loading hourly activity...</div>';
        
        fetch('/analytics/api/hourly-activity')
            .then(response => response.json())
            .then(data => {
                let html = '<div class="analytics-chart-container">';
                html += '<div class="analytics-chart-title"><i class="fas fa-clock"></i>Hourly Activity (Last 24 Hours)</div>';
                html += '<div class="analytics-chart"><canvas id="hourlyActivityChart"></canvas></div>';
                html += '<div class="analytics-stats-grid">';
                
                if (data.hourly_data && data.hourly_data.length > 0) {
                    const totalGranted = data.hourly_data.reduce((sum, item) => sum + (item[2] || 0), 0);
                    const totalDenied = data.hourly_data.reduce((sum, item) => sum + (item[3] || 0), 0);
                    
                    html += `
                        <div class="analytics-stat-card">
                            <div class="analytics-stat-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="analytics-stat-label">Granted</div>
                            <div class="analytics-stat-value">${totalGranted}</div>
                            <div class="analytics-stat-percentage">total</div>
                        </div>
                    `;
                    
                    html += `
                        <div class="analytics-stat-card">
                            <div class="analytics-stat-icon"><i class="fas fa-times-circle"></i></div>
                            <div class="analytics-stat-label">Denied</div>
                            <div class="analytics-stat-value">${totalDenied}</div>
                            <div class="analytics-stat-percentage">total</div>
                        </div>
                    `;
                    
                    html += `
                        <div class="analytics-stat-card">
                            <div class="analytics-stat-icon"><i class="fas fa-percentage"></i></div>
                            <div class="analytics-stat-label">Success Rate</div>
                            <div class="analytics-stat-value">${totalGranted + totalDenied > 0 ? Math.round((totalGranted / (totalGranted + totalDenied)) * 100) : 0}%</div>
                            <div class="analytics-stat-percentage">granted</div>
                        </div>
                    `;
                } else {
                    html += '<div class="analytics-stat-card"><div class="analytics-stat-value">No data available</div></div>';
                }
                
                html += '</div></div>';
                container.innerHTML = html;
                
                // Create line chart
                createHourlyActivityChart(data);
            })
            .catch(error => {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i><div>Error loading hourly activity data</div></div>';
            });
    }
    
    function createHourlyActivityChart(data) {
        const canvas = document.getElementById('hourlyActivityChart');
        if (!canvas) {
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        if (data.hourly_data && data.hourly_data.length > 0) {
            const labels = data.hourly_data.map(item => item[0] + ':00');
            const grantedData = data.hourly_data.map(item => item[2]);
            const deniedData = data.hourly_data.map(item => item[3]);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Granted',
                        data: grantedData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Denied',
                        data: deniedData,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { maxTicksLimit: 6 }
                        },
                        x: {
                            ticks: { maxTicksLimit: 12 }
                        }
                    }
                }
            });
        }
    }
    
    // Close analytics modal when clicking outside
    document.getElementById('analyticsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAnalyticsModal();
        }
    });
    
    // Reports Modal Functions
    function showReportsModal() {
        const modal = document.getElementById('reportsModal');
        if (!modal) {
            return;
        }
        modal.style.display = 'flex';
        loadReportsList();
    }
    
    function closeReportsModal() {
        document.getElementById('reportsModal').style.display = 'none';
    }
    
    function closeReportGeneratorModal() {
        document.getElementById('reportGeneratorModal').style.display = 'none';
    }
    
    function loadReportsList() {
        const container = document.getElementById('reportsContent');
        
        if (!container) {
            return;
        }
        
        // Show loading
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><span class="loading"></span> Loading reports...</div>';
        
        // Define all reports
        const reports = {
            'vehicle_reports': {
                title: 'Vehicle Reports',
                reports: [
                    {
                        id: 'entry_reports',
                        title: 'Entry Reports',
                        icon: 'fas fa-sign-in-alt',
                        description: 'Detailed entry logs with user information and timestamps.',
                        type: 'entry_reports'
                    },
                    {
                        id: 'exit_reports',
                        title: 'Exit Reports',
                        icon: 'fas fa-sign-out-alt',
                        description: 'Comprehensive exit logs with departure details.',
                        type: 'exit_reports'
                    },
                    {
                        id: 'non_exited_vehicles',
                        title: 'Non-Exited Vehicles',
                        icon: 'fas fa-car',
                        description: 'Vehicles that entered but haven\'t exited yet.',
                        type: 'non_exited_vehicles'
                    },
                    {
                        id: 'vehicle_specific',
                        title: 'Vehicle-Specific Report',
                        icon: 'fas fa-search',
                        description: 'Detailed activity for a specific vehicle number.',
                        type: 'vehicle_specific'
                    }
                ]
            },
            'time_based_reports': {
                title: 'Time-Based Reports',
                reports: [
                    {
                        id: 'peak_hours_analysis',
                        title: 'Peak Hours Analysis',
                        icon: 'fas fa-chart-line',
                        description: 'Busiest entry/exit times and traffic patterns.',
                        type: 'peak_hours_analysis'
                    },
                    {
                        id: 'daily_traffic_patterns',
                        title: 'Daily Traffic Patterns',
                        icon: 'fas fa-clock',
                        description: 'Hour-by-hour activity breakdown by date.',
                        type: 'daily_traffic_patterns'
                    },
                    {
                        id: 'weekly_trends',
                        title: 'Weekly Trends',
                        icon: 'fas fa-calendar-week',
                        description: 'Long-term usage patterns and weekly analysis.',
                        type: 'weekly_trends'
                    }
                ]
            },
            'facility_management_reports': {
                title: 'Facility Management Reports',
                reports: [
                    {
                        id: 'lane_performance',
                        title: 'Lane Performance',
                        icon: 'fas fa-road',
                        description: 'Which lanes are most/least used with metrics.',
                        type: 'lane_performance'
                    },
                    {
                        id: 'equipment_health',
                        title: 'Equipment Health',
                        icon: 'fas fa-heartbeat',
                        description: 'Reader status, maintenance, and system health.',
                        type: 'equipment_health'
                    },
                    {
                        id: 'denied_access_analysis',
                        title: 'Denied Access Analysis',
                        icon: 'fas fa-shield-alt',
                        description: 'Security insights and access failure reasons.',
                        type: 'denied_access_analysis'
                    }
                ]
            }
        };
        
        let html = '';
        
        // Generate HTML for each section
        Object.keys(reports).forEach(sectionKey => {
            const section = reports[sectionKey];
            html += `<div class="reports-section">`;
            html += `<div class="reports-section-title">${section.title}</div>`;
            html += `<div class="reports-grid">`;
            
            section.reports.forEach(report => {
                html += `
                    <div class="report-card" onclick="openReportGenerator('${report.type}', '${report.title}')">
                        <div class="report-card-header">
                            <div class="report-card-icon">
                                <i class="${report.icon}"></i>
                            </div>
                            <div class="report-card-title">${report.title}</div>
                        </div>
                        <div class="report-card-desc">${report.description}</div>
                        <div class="report-card-actions">
                            <button class="report-action-btn" onclick="event.stopPropagation(); openReportGenerator('${report.type}', '${report.title}')">
                                <i class="fas fa-download"></i> Generate
                            </button>
                                                       <button class="report-action-btn secondary" onclick="event.stopPropagation(); shareReportWithDateRange('${report.type}', '${report.title}', '', '')">
                               <i class="fas fa-share"></i> Share
                           </button>
                        </div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
        });
        
        container.innerHTML = html;
    }
    
    function openReportGenerator(reportType, reportTitle) {
        document.getElementById('reportType').value = reportType;
        document.getElementById('reportTypeDisplay').textContent = reportTitle;
        document.getElementById('reportGeneratorTitle').textContent = `Generate ${reportTitle}`;
        document.getElementById('reportGeneratorDesc').textContent = `Select date range for ${reportTitle}`;
        
        // Set default dates (last 7 days)
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        document.getElementById('reportStartDate').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
        
        document.getElementById('reportGeneratorModal').style.display = 'flex';
    }
    
    function generateReport(event) {
        event.preventDefault();
        
        const reportType = document.getElementById('reportType').value;
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        
        if (!reportType || !startDate || !endDate) {
            alert('Please fill in all fields');
            return;
        }
        
        // Show loading
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        submitBtn.disabled = true;
        
        // Generate report URL
        const reportUrl = `/analytics/api/export-data?report_type=${reportType}&start_date=${startDate}&end_date=${endDate}&format=excel`;
        
        // Create download link
        const link = document.createElement('a');
        link.href = reportUrl;
        link.download = `${reportType}_${startDate}_to_${endDate}.xlsx`;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        // Close modal
        closeReportGeneratorModal();
        
        // Show success message
        alert('Report generated successfully! Check your downloads.');
    }
    
    // Global variables for sharing
    let currentShareReportType = '';
    let currentShareReportTitle = '';
    let currentShareReportData = null;
    
    function shareReport(reportType, reportTitle) {
        currentShareReportType = reportType;
        currentShareReportTitle = reportTitle;
        
        // Update modal description
        document.getElementById('shareReportDesc').textContent = `Share ${reportTitle}`;
        
        // Show share modal
        document.getElementById('shareReportModal').style.display = 'flex';
    }
    
    // Global variables for file sharing with date range
    let currentShareStartDate = '';
    let currentShareEndDate = '';
    
    function shareReportWithDateRange(reportType, reportTitle, startDate, endDate) {
        currentShareReportType = reportType;
        currentShareReportTitle = reportTitle;
        currentShareStartDate = startDate;
        currentShareEndDate = endDate;
        
        // Update modal description
        document.getElementById('shareReportDesc').textContent = `Share ${reportTitle} (${startDate} to ${endDate})`;
        
        // Show share modal
        document.getElementById('shareReportModal').style.display = 'flex';
    }
    
    function closeShareReportModal() {
        document.getElementById('shareReportModal').style.display = 'none';
    }
    
    function shareViaWhatsApp() {
        // Generate and download the file first
        generateAndShareFile('whatsapp');
    }
    
    function shareViaEmail() {
        // Generate and download the file first
        generateAndShareFile('email');
    }
    

    
    function generateAndShareFile(shareMethod) {
        // Show loading
        showShareSuccess('Generating report file...');
        
        // Use provided date range or default to last 7 days
        let startDate, endDate;
        if (currentShareStartDate && currentShareEndDate) {
            startDate = currentShareStartDate;
            endDate = currentShareEndDate;
        } else {
            const today = new Date();
            endDate = today.toISOString().split('T')[0];
            startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        }
        
        const reportUrl = `/analytics/api/export-data?report_type=${currentShareReportType}&start_date=${startDate}&end_date=${endDate}&format=excel`;
        
        // Fetch the file as blob and share directly
        fetch(reportUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to generate report');
                }
                return response.blob();
            })
            .then(blob => {
                // Create file object
                const filename = `${currentShareReportType}_${startDate}_to_${endDate}.xlsx`;
                const file = new File([blob], filename, { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                
                // Share the actual file
                shareFileDirectly(shareMethod, file);
            })
            .catch(error => {
                console.error('Error generating report:', error);
                showShareSuccess('Error generating report. Please try again.');
            });
    }
    
    function shareFileDirectly(shareMethod, file) {
        const message = `FASTag Parking Report: ${currentShareReportTitle}\n\nFile: ${file.name}\nGenerated on: ${new Date().toLocaleDateString()}`;
        
        switch(shareMethod) {
            case 'whatsapp':
                shareFileViaWhatsApp(file, message);
                break;
                
            case 'email':
                shareFileViaEmail(file, message);
                break;
        }
        
        closeShareReportModal();
    }
    
    function shareFileViaWhatsApp(file, message) {
        // Create a temporary download link for WhatsApp
        const url = URL.createObjectURL(file);
        
        // Try to use WhatsApp Web API with file
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        
        // Also trigger download so user can manually attach
        const link = document.createElement('a');
        link.href = url;
        link.download = file.name;
        link.click();
        
        showShareSuccess('WhatsApp opened! Please attach the downloaded file manually.');
    }
    
    function shareFileViaEmail(file, message) {
        // Create mailto link with file attachment info
        const subject = `FASTag Parking Report - ${currentShareReportTitle}`;
        const body = `${message}\n\nFile: ${file.name}\n\nNote: The Excel file has been downloaded to your device. Please attach it manually.`;
        const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(mailtoUrl, '_blank');
        
        // Also trigger download
        const url = URL.createObjectURL(file);
        const link = document.createElement('a');
        link.href = url;
        link.download = file.name;
        link.click();
        
        showShareSuccess('Email opened! Please attach the downloaded file manually.');
    }
    

    
    function showShareSuccess(message) {
        // Create a temporary success message
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
            z-index: 9999;
            font-weight: 600;
        `;
        successDiv.textContent = message;
        document.body.appendChild(successDiv);
        
        // Remove after 3 seconds
        setTimeout(() => {
            document.body.removeChild(successDiv);
        }, 3000);
    }
    
    // Close reports modal when clicking outside
    var reportsModal = document.getElementById('reportsModal');
    if (reportsModal) {
        reportsModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeReportsModal();
            }
        });
    }
    // Close report generator modal when clicking outside
    var reportGeneratorModal = document.getElementById('reportGeneratorModal');
    if (reportGeneratorModal) {
        reportGeneratorModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeReportGeneratorModal();
            }
        });
    }
    // Close share report modal when clicking outside
    var shareReportModal = document.getElementById('shareReportModal');
    if (shareReportModal) {
        shareReportModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeShareReportModal();
            }
        });
    }

    function showBarrierModal() {
        document.getElementById('barrierModal').style.display = 'flex';
        refreshRelayStatusPWA();
    }
    function closeBarrierModal() {
        document.getElementById('barrierModal').style.display = 'none';
    }
    function setRelayIconPWA(relayNum, status) {
        var dot = document.getElementById('relay' + relayNum + '-dot');
        if (!dot) return;
        dot.className = 'barrier-relay-dot';
        if (status === 'ON') {
            dot.classList.add('on');
            dot.title = 'ON';
        } else if (status === 'OFF') {
            dot.classList.add('off');
            dot.title = 'OFF';
        } else {
            dot.classList.add('unknown');
            dot.title = 'Unknown';
        }
    }
    function refreshRelayStatusPWA() {
        fetch('/api/relay-status')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.status) {
                    for (let i = 1; i <= 3; i++) {
                        setRelayIconPWA(i, data.status['relay' + i]);
                    }
                } else {
                    for (let i = 1; i <= 3; i++) {
                        setRelayIconPWA(i, 'UNKNOWN');
                    }
                }
            })
            .catch(() => {
                for (let i = 1; i <= 3; i++) {
                    setRelayIconPWA(i, 'UNKNOWN');
                }
            });
    }
    function toggleRelayPWA(relayNumber) {
        // Get current status to determine what action to take
        fetch('/api/relay-status')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.status) {
                    const currentStatus = data.status['relay' + relayNumber];
                    const newAction = currentStatus === 'ON' ? 'off' : 'on';
                    fetch(`/api/relay/${relayNumber}/${newAction}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            setRelayIconPWA(relayNumber, newAction.toUpperCase());
                            setTimeout(refreshRelayStatusPWA, 2500); // Auto-refresh after 2.5s
                        } else {
                            alert(`Failed to turn ${newAction} relay ${relayNumber}: ${result.error}`);
                        }
                    })
                    .catch(error => {
                        alert('Error controlling relay ' + relayNumber);
                    });
                } else {
                    alert('Unable to get current relay status');
                }
            })
            .catch(error => {
                alert('Error getting relay status');
            });
    }

    function showControllerStatusModal() {
        document.getElementById('controllerStatusModal').style.display = 'flex';
        // Clear the records area to show only the option cards
        document.getElementById('controllerStatusRecords').innerHTML = '';
    }
    function closeControllerStatusModal() {
        document.getElementById('controllerStatusModal').style.display = 'none';
    }
    
    function closeSystemHealthModal() {
        document.getElementById('systemHealthModal').style.display = 'none';
    }
    
    function closeNetworkInfoModal() {
        document.getElementById('networkInfoModal').style.display = 'none';
    }
    
    function closeDatabaseBackupModal() {
        document.getElementById('databaseBackupModal').style.display = 'none';
    }
    
    function closeSSHTerminalModal() {
        document.getElementById('sshTerminalModal').style.display = 'none';
        // Disconnect SSH if connected
        if (window.sshConnected) {
            disconnectSSH();
        }
    }
    
    // Controller Status Functions
    function showControllerHealth() {
        // Show the modal first
        document.getElementById('systemHealthModal').style.display = 'flex';
        document.getElementById('systemHealthContent').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Loading system health...</div>';
        
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                if (!data.success || !data.info_str) {
                    document.getElementById('systemHealthContent').innerHTML = '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to load system health.</div>';
                    return;
                }
                // Parse and display health info - show all health-related data
                const healthInfo = data.info_str.split('|').filter(line => 
                    line.includes('Temp') || line.includes('Volt') || line.includes('Throttled') || 
                    line.includes('Uptime') || line.includes('RAM') || line.includes('Disk') ||
                    line.includes('CPU') || line.includes('Memory')
                );
                document.getElementById('systemHealthContent').innerHTML =
                    '<div style="font-size:1.08em;line-height:1.7;">' + healthInfo.join('<br>') + '</div>';
            })
            .catch(() => {
                document.getElementById('systemHealthContent').innerHTML = '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to load system health.</div>';
            });
    }
    
    function showControllerIPInfo() {
        // Show the modal first
        document.getElementById('networkInfoModal').style.display = 'flex';
        document.getElementById('networkInfoContent').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Loading network information...</div>';
        
        fetch('/api/network-info')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    let html = '<div style="font-size:1.08em;line-height:1.7;">';
                    if (data.interfaces) {
                        data.interfaces.forEach(iface => {
                            html += `<div style="margin-bottom:1rem;padding:0.8rem;background:#f8f9fa;border-radius:8px;border-left:4px solid #667eea;">`;
                            html += `<strong style="color:#667eea;">${iface.name}</strong><br>`;
                            html += `IP: <code>${iface.ip || 'N/A'}</code><br>`;
                            html += `MAC: <code>${iface.mac || 'N/A'}</code><br>`;
                            html += `Status: <span style="color:${iface.status === 'UP' ? '#28a745' : '#dc3545'}">${iface.status || 'UNKNOWN'}</span>`;
                            html += '</div>';
                        });
                    } else {
                        html += '<div style="text-align:center;color:#dc3545;">No network interfaces found.</div>';
                    }
                    html += '</div>';
                    document.getElementById('networkInfoContent').innerHTML = html;
                } else {
                    document.getElementById('networkInfoContent').innerHTML = '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to load network information.</div>';
                }
            })
            .catch(() => {
                document.getElementById('networkInfoContent').innerHTML = '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to load network information.</div>';
            });
    }
    
    function showControllerBackup() {
        // Show the modal first
        document.getElementById('databaseBackupModal').style.display = 'flex';
        document.getElementById('databaseBackupContent').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Loading database information...</div>';
        
        fetch('/api/database-info')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    let html = '<div style="font-size:1.08em;line-height:1.7;">';
                    html += `<div style="margin-bottom:1rem;padding:0.8rem;background:#f8f9fa;border-radius:8px;border-left:4px solid #ffc107;">`;
                    html += `<strong style="color:#ffc107;">Database Information</strong><br>`;
                    html += `File: <code>${data.db_file || 'N/A'}</code><br>`;
                    html += `Size: <code>${data.db_size || 'N/A'}</code><br>`;
                    html += `Last Modified: <code>${data.last_modified || 'N/A'}</code>`;
                    html += '</div>';
                    html += `<div style="text-align:center;margin-top:1rem;">`;
                    html += `<button onclick="downloadDatabase()" style="background:linear-gradient(90deg,#ffc107 0%,#fd7e14 100%);color:white;border:none;padding:0.8rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;">`;
                    html += `<i class="fas fa-download"></i> Download Backup</button>`;
                    html += '</div>';
                    html += '</div>';
                    document.getElementById('databaseBackupContent').innerHTML = html;
                } else {
                    document.getElementById('databaseBackupContent').innerHTML = '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to load database information.</div>';
                }
            })
            .catch(() => {
                document.getElementById('databaseBackupContent').innerHTML = '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to load database information.</div>';
            });
    }
    
    function downloadDatabase() {
        // Create a download link for the database file
        const link = document.createElement('a');
        link.href = '/api/download-database';
        link.download = 'fastag_backup_' + new Date().toISOString().slice(0, 10) + '.db';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success message
        document.getElementById('databaseBackupContent').innerHTML += 
            '<div style="text-align:center;color:#28a745;margin-top:1rem;font-weight:600;">Database backup download started!</div>';
    }
    

    
    // Restart Functions with Styled Confirmation
    let currentRestartAction = null;
    
    function restartController() {
        console.log('restartController called');
        showRestartConfirmModal('controller', 'Restart Controller', 'Are you sure you want to restart the controller? This will reboot the entire system.', 'fas fa-power-off', 'dc3545');
    }
    
    function restartApplication() {
        console.log('restartApplication called');
        showRestartConfirmModal('application', 'Restart Application', 'Are you sure you want to restart the Fastag application? This will restart the web service.', 'fas fa-sync-alt', '6f42c1');
    }
    
    function restartReaders() {
        console.log('restartReaders called');
        showRestartConfirmModal('readers', 'Restart RFID Readers', 'Are you sure you want to restart the RFID readers? This will restart the RFID service.', 'fas fa-wifi', 'fd7e14');
    }
    
    function showRestartConfirmModal(action, title, description, icon, color) {
        console.log('showRestartConfirmModal called with action:', action);
        
        // Validate action parameter
        if (!action || !['controller', 'application', 'readers'].includes(action)) {
            console.error('Invalid action provided to showRestartConfirmModal:', action);
            return;
        }
        
        // Set the action globally
        window.currentRestartAction = action;
        
        // Update modal content
        document.getElementById('restartConfirmTitle').textContent = title;
        document.getElementById('restartConfirmDesc').textContent = description;
        document.getElementById('restartConfirmIcon').innerHTML = `<i class="${icon}"></i>`;
        document.getElementById('restartConfirmIcon').style.color = `#${color}`;
        
        // Show modal
        document.getElementById('restartConfirmModal').style.display = 'flex';
        
        console.log('Modal shown, currentRestartAction set to:', window.currentRestartAction);
    }
    
    function closeRestartConfirmModal() {
        document.getElementById('restartConfirmModal').style.display = 'none';
        // Don't clear the action immediately, let it be cleared after execution
        console.log('Modal closed, currentRestartAction remains:', window.currentRestartAction);
    }
    
    function executeRestartAction() {
        console.log('executeRestartAction called, currentRestartAction:', window.currentRestartAction);
        
        // Validate action
        if (!window.currentRestartAction) {
            console.error('No restart action set');
            document.getElementById('controllerStatusRecords').innerHTML = 
                '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Error: No restart action selected.</div>';
            return;
        }
        
        // Validate action value
        if (!['controller', 'application', 'readers'].includes(window.currentRestartAction)) {
            console.error('Invalid restart action:', window.currentRestartAction);
            document.getElementById('controllerStatusRecords').innerHTML = 
                '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Error: Invalid restart action.</div>';
            return;
        }
        
        // Store action locally before clearing
        const actionToExecute = window.currentRestartAction;
        
        // Close modal and clear action
        closeRestartConfirmModal();
        window.currentRestartAction = null;
        
        // Show loading message
        document.getElementById('controllerStatusRecords').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Restarting...</div>';
        
        // Execute based on action
        console.log('Executing restart action:', actionToExecute);
        
        if (actionToExecute === 'controller') {
            restartControllerSystem();
        } else if (actionToExecute === 'application') {
            restartApplicationSystem();
        } else if (actionToExecute === 'readers') {
            restartReadersSystem();
        } else {
            console.error('Unexpected action in executeRestartAction:', actionToExecute);
            document.getElementById('controllerStatusRecords').innerHTML = 
                '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Error: Unexpected restart action.</div>';
        }
    }
    

    
    function restartControllerSystem() {
        console.log('restartControllerSystem called');
        fetch('/api/restart-controller', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            console.log('Controller restart response:', data);
            if (data.success) {
                document.getElementById('controllerStatusRecords').innerHTML = 
                    '<div style="text-align:center;color:#28a745;padding:0.7rem;font-weight:600;">Controller restart initiated! System will reboot shortly.</div>';
            } else {
                document.getElementById('controllerStatusRecords').innerHTML = 
                    '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to restart controller: ' + (data.error || 'Unknown error') + '</div>';
            }
        })
        .catch((error) => {
            console.error('Controller restart error:', error);
            document.getElementById('controllerStatusRecords').innerHTML = 
                '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to restart controller.</div>';
        });
    }
    
    function restartApplicationSystem() {
        console.log('restartApplicationSystem called');
        fetch('/api/restart-application', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            console.log('Application restart response:', data);
            if (data.success) {
                document.getElementById('controllerStatusRecords').innerHTML = 
                    '<div style="text-align:center;color:#28a745;padding:0.7rem;font-weight:600;">Application restart initiated! Service will restart shortly.</div>';
            } else {
                document.getElementById('controllerStatusRecords').innerHTML = 
                    '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to restart application: ' + (data.error || 'Unknown error') + '</div>';
            }
        })
        .catch((error) => {
            console.error('Application restart error:', error);
            document.getElementById('controllerStatusRecords').innerHTML = 
                '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to restart application.</div>';
        });
    }
    
    function restartReadersSystem() {
        console.log('restartReadersSystem called');
        fetch('/api/restart-readers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            console.log('Readers restart response:', data);
            if (data.success) {
                document.getElementById('controllerStatusRecords').innerHTML = 
                    '<div style="text-align:center;color:#28a745;padding:0.7rem;font-weight:600;">RFID readers restart initiated! Service will restart shortly.</div>';
            } else {
                document.getElementById('controllerStatusRecords').innerHTML = 
                    '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to restart readers: ' + (data.error || 'Unknown error') + '</div>';
            }
        })
        .catch((error) => {
            console.error('Readers restart error:', error);
            document.getElementById('controllerStatusRecords').innerHTML = 
                '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to restart readers.</div>';
        });
    }

    function openAllBarriers() {
        fetch('/api/barrier-control', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'open',
                relay_numbers: [1, 2, 3]
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Update all relay status to ON
                for (let i = 1; i <= 3; i++) {
                    setRelayIconPWA(i, 'ON');
                }
                setTimeout(refreshRelayStatusPWA, 2500); // Auto-refresh after 2.5s
                alert('All barriers opened successfully!');
            } else {
                alert('Failed to open all barriers: ' + (result.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error opening all barriers: ' + error);
        });
    }



    function openAddKycUserModal() {
        document.getElementById('addKycUserModal').style.display = 'flex';
        // Clear form when opening
        clearKycForm();
    }

    function showVehicleFinderModal() {
        document.getElementById('vehicleFinderModal').style.display = 'flex';
        document.getElementById('vehicleResults').style.display = 'none';
        document.getElementById('vehicleSearchError').style.display = 'none';
        document.getElementById('vehicleSearchForm').reset();
    }

    function closeVehicleFinderModal() {
        document.getElementById('vehicleFinderModal').style.display = 'none';
    }

    function searchVehicle(event) {
        event.preventDefault();
        const regNo = document.getElementById('vehicleRegNo').value.trim().toUpperCase();
        
        if (!regNo) {
            showVehicleError('Please enter a vehicle registration number.');
            return;
        }
        
        // Validate format
        const regNoPattern = /^[A-Z]{2}[0-9]{1,2}[A-Z]{1,2}[0-9]{4}$/;
        if (!regNoPattern.test(regNo)) {
            showVehicleError('Please enter a valid vehicle registration number (e.g., KA03KD1578).');
            return;
        }
        
        // Show loading
        hideVehicleError();
        document.getElementById('vehicleResultsContent').innerHTML = '<div style="text-align:center;color:#aaa;padding:1rem;">Searching...</div>';
        document.getElementById('vehicleResults').style.display = 'block';
        
        // Make API call
        fetch(`/api/vehicle/${regNo}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showVehicleError('Vehicle information not found for this registration number.');
                    document.getElementById('vehicleResults').style.display = 'none';
                    return;
                }
                
                if (!data.registration_number) {
                    showVehicleError('Vehicle information not found for this registration number.');
                    document.getElementById('vehicleResults').style.display = 'none';
                    return;
                }
                
                displayVehicleResults(data);
            })
            .catch(error => {
                showVehicleError('Unable to fetch vehicle information. Please try again later.');
                document.getElementById('vehicleResults').style.display = 'none';
                console.error('Error:', error);
            });
    }

    function displayVehicleResults(data) {
        const resultsContent = document.getElementById('vehicleResultsContent');
        
        let html = `
            <div style="background:#f8f9fa;border-radius:8px;padding:1rem;margin-bottom:0.5rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                    <span style="font-weight:600;color:#666;">Registration Number</span>
                    <span style="font-weight:700;color:#764ba2;font-size:1.1rem;">${data.registration_number}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                    <span style="font-weight:600;color:#666;">Owner Name</span>
                    <span style="font-weight:600;color:#333;">${data.owner_name || 'N/A'}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                    <span style="font-weight:600;color:#666;">Vehicle Type</span>
                    <span style="background:linear-gradient(135deg,#764ba2 0%,#667eea 100%);color:white;padding:0.3rem 0.8rem;border-radius:15px;font-size:0.8rem;font-weight:600;">${(data.vehicle_type_v2 || '').replace('_', ' ').toUpperCase()}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                    <span style="font-weight:600;color:#666;">Make</span>
                    <span style="font-weight:600;color:#333;">${data.db_make_name || 'N/A'}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                    <span style="font-weight:600;color:#666;">Model</span>
                    <span style="font-weight:600;color:#333;">${data.db_model_name || 'N/A'}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-weight:600;color:#666;">Fuel Type</span>
                    <span style="background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white;padding:0.3rem 0.8rem;border-radius:15px;font-size:0.8rem;font-weight:600;">${data.fuel_type || 'N/A'}</span>
                </div>
        `;
        
        if (data.model_name) {
            html += `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid #e9ecef;">
                    <span style="font-weight:600;color:#666;">Full Model Name</span>
                    <span style="font-weight:600;color:#333;">${data.model_name}</span>
                </div>
            `;
        }
        
        if (data.previous_policy_expiry_detail) {
            html += `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem;">
                    <span style="font-weight:600;color:#666;">Policy Expiry</span>
                    <span style="font-weight:600;color:#333;">${data.previous_policy_expiry_detail.substring(0, 10)}</span>
                </div>
            `;
        }
        
        html += '</div>';
        resultsContent.innerHTML = html;
    }

    function showVehicleError(message) {
        document.getElementById('vehicleSearchError').textContent = message;
        document.getElementById('vehicleSearchError').style.display = 'block';
    }

    function hideVehicleError() {
        document.getElementById('vehicleSearchError').style.display = 'none';
    }

    function showBankFinderModal() {
        document.getElementById('bankFinderModal').style.display = 'flex';
        document.getElementById('bankResults').style.display = 'none';
        document.getElementById('bankSearchError').style.display = 'none';
        document.getElementById('bankSearchForm').reset();
        updateBankHelpText();
    }

    function closeBankFinderModal() {
        document.getElementById('bankFinderModal').style.display = 'none';
    }

    function updateBankHelpText() {
        const searchType = document.getElementById('bankSearchType').value;
        const helpText = document.getElementById('bankHelpText');
        const placeholder = document.getElementById('bankSearchValue');
        
        if (searchType === 'VRN') {
            helpText.textContent = 'Format: TN66AT2938 (Vehicle Registration Number)';
            placeholder.placeholder = 'Enter VRN (e.g., TN66AT2938)';
        } else {
            helpText.textContent = 'Format: 24-character TagID (hexadecimal)';
            placeholder.placeholder = 'Enter 24-character TagID';
        }
    }

    function searchBank(event) {
        event.preventDefault();
        const searchType = document.getElementById('bankSearchType').value;
        const searchValue = document.getElementById('bankSearchValue').value.trim().toUpperCase();
        
        if (!searchValue) {
            showBankError('Please enter a search value.');
            return;
        }
        
        // Validate format based on search type
        if (searchType === 'VRN') {
            const vrnPattern = /^[A-Z]{2}[0-9]{1,2}[A-Z]{1,2}[0-9]{4}$/;
            if (!vrnPattern.test(searchValue)) {
                showBankError('Please enter a valid vehicle registration number (e.g., TN66AT2938).');
                return;
            }
        } else if (searchType === 'TagID') {
            const tagIdPattern = /^[A-F0-9]{24}$/;
            if (!tagIdPattern.test(searchValue)) {
                showBankError('Please enter a valid 24-character TagID (hexadecimal).');
                return;
            }
        }
        
        // Show loading
        hideBankError();
        document.getElementById('bankResultsContent').innerHTML = '<div style="text-align:center;color:#aaa;padding:1rem;">Searching...</div>';
        document.getElementById('bankResults').style.display = 'block';
        
        // Make API call
        fetch(`/api/bank/${searchType}/${encodeURIComponent(searchValue)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showBankError('Unable to fetch bank information. Please try again later.');
                    document.getElementById('bankResults').style.display = 'none';
                    return;
                }
                
                if (data.ErrorMessage !== 'NONE' || !data.npcitagDetails || data.npcitagDetails.length === 0) {
                    showBankError('No bank information found for this search value.');
                    document.getElementById('bankResults').style.display = 'none';
                    return;
                }
                
                displayBankResults(data.npcitagDetails);
            })
            .catch(error => {
                showBankError('Unable to fetch bank information. Please try again later.');
                document.getElementById('bankResults').style.display = 'none';
                console.error('Error:', error);
            });
    }

    function displayBankResults(tags) {
        const resultsContent = document.getElementById('bankResultsContent');
        let html = '';
        
        tags.forEach((tag, index) => {
            html += `
                <div style="background:#f8f9fa;border-radius:8px;padding:1rem;margin-bottom:0.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <span style="font-weight:600;color:#666;">Bank Name</span>
                        <span style="font-weight:700;color:#764ba2;font-size:1.1rem;">${tag.BankId || 'N/A'}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <span style="font-weight:600;color:#666;">Vehicle Registration</span>
                        <span style="font-weight:600;color:#333;">${tag.VRN || 'N/A'}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <span style="font-weight:600;color:#666;">Tag ID</span>
                        <span style="font-family:monospace;font-weight:600;color:#333;">${tag.TagID || 'N/A'}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <span style="font-weight:600;color:#666;">Tag Status</span>
                        <span style="background:${tag.TagStatus === 'A' ? 'linear-gradient(135deg,#28a745 0%,#20c997 100%)' : 'linear-gradient(135deg,#dc3545 0%,#fd7e14 100%)'};color:white;padding:0.3rem 0.8rem;border-radius:15px;font-size:0.8rem;font-weight:600;">${tag.TagStatus === 'A' ? 'ACTIVE' : 'INACTIVE'}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <span style="font-weight:600;color:#666;">Issue Date</span>
                        <span style="font-weight:600;color:#333;">${tag.IssueDate || 'N/A'}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <span style="font-weight:600;color:#666;">Vehicle Class</span>
                        <span style="background:linear-gradient(135deg,#764ba2 0%,#667eea 100%);color:white;padding:0.3rem 0.8rem;border-radius:15px;font-size:0.8rem;font-weight:600;">${tag.VehicleClass || 'N/A'}</span>
                    </div>
            `;
            
            if (tag.TID) {
                html += `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid #e9ecef;">
                        <span style="font-weight:600;color:#666;">TID</span>
                        <span style="font-family:monospace;font-weight:600;color:#333;">${tag.TID}</span>
                    </div>
                `;
            }
            
            html += '</div>';
        });
        
        resultsContent.innerHTML = html;
    }

    function showBankError(message) {
        document.getElementById('bankSearchError').textContent = message;
        document.getElementById('bankSearchError').style.display = 'block';
    }

    function hideBankError() {
        document.getElementById('bankSearchError').style.display = 'none';
    }

    function showFastagBalanceModal() {
        document.getElementById('fastagBalanceModal').style.display = 'flex';
        document.getElementById('fastagBalanceResults').style.display = 'none';
        document.getElementById('fastagBalanceError').style.display = 'none';
        document.getElementById('fastagBalanceForm').reset();
    }

    function closeFastagBalanceModal() {
        document.getElementById('fastagBalanceModal').style.display = 'none';
    }

    function checkFastagBalance(event) {
        event.preventDefault();
        const regNo = document.getElementById('fastagRegNo').value.trim().toUpperCase();
        const selectedBank = document.getElementById('fastagBankSelect').value;
        
        if (!regNo) {
            showFastagBalanceError('Please enter a vehicle registration number.');
            return;
        }
        
        if (!selectedBank) {
            showFastagBalanceError('Please select a bank.');
            return;
        }
        
        // Validate VRN format
        const vrnPattern = /^[A-Z]{2}[0-9]{1,2}[A-Z]{1,2}[0-9]{4}$/;
        if (!vrnPattern.test(regNo)) {
            showFastagBalanceError('Please enter a valid vehicle registration number (e.g., KA04MJ6369).');
            return;
        }
        
        // Show loading
        hideFastagBalanceError();
        document.getElementById('fastagBalanceResultsContent').innerHTML = '<div style="text-align:center;color:#aaa;padding:1rem;">Checking balance...</div>';
        document.getElementById('fastagBalanceResults').style.display = 'block';
        
        // Make API call
        const formData = new FormData();
        formData.append('reg_no', regNo);
        formData.append('selected_bank', selectedBank);
        
        fetch('/fastag_balance', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            // Parse the HTML response to extract data
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Check for error
            const errorElement = doc.querySelector('.alert-danger');
            if (errorElement) {
                const errorText = errorElement.textContent.trim();
                showFastagBalanceError(errorText);
                document.getElementById('fastagBalanceResults').style.display = 'none';
                return;
            }
            
            // Check for success
            const fastagResult = doc.querySelector('.fastag-result');
            if (fastagResult) {
                displayFastagBalanceResults(fastagResult.innerHTML);
            } else {
                showFastagBalanceError('No FASTag information found for this vehicle and bank combination.');
                document.getElementById('fastagBalanceResults').style.display = 'none';
            }
        })
        .catch(error => {
            showFastagBalanceError('Unable to check FASTag balance. Please try again later.');
            document.getElementById('fastagBalanceResults').style.display = 'none';
            console.error('Error:', error);
        });
    }

    function displayFastagBalanceResults(htmlContent) {
        const resultsContent = document.getElementById('fastagBalanceResultsContent');
        
        // Create a temporary div to parse the HTML content
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;
        
        // Extract balance information
        const balanceElement = tempDiv.querySelector('.badge');
        const accountIdElement = tempDiv.querySelector('.text-muted');
        const categoryElement = tempDiv.querySelector('.badge[style*="background: #4b2e83"]');
        const bankNameElement = tempDiv.querySelector('.card-body .text-muted');
        
        let html = `
            <div style="background:#f8f9fa;border-radius:8px;padding:1rem;margin-bottom:0.5rem;">
                <div style="text-align:center;margin-bottom:1rem;">
                    <span style="font-weight:700;color:#764ba2;font-size:1.2rem;">FASTag Balance Information</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                    <span style="font-weight:600;color:#666;">Current Balance</span>
                    <span style="font-weight:700;color:#28a745;font-size:1.3rem;">₹${balanceElement ? balanceElement.textContent.replace('₹', '') : 'N/A'}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                    <span style="font-weight:600;color:#666;">Account ID</span>
                    <span style="font-weight:600;color:#333;">${accountIdElement ? accountIdElement.textContent : 'N/A'}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                    <span style="font-weight:600;color:#666;">Category</span>
                    <span style="background:linear-gradient(135deg,#4b2e83 0%,#764ba2 100%);color:white;padding:0.3rem 0.8rem;border-radius:15px;font-size:0.8rem;font-weight:600;">${categoryElement ? categoryElement.textContent : 'N/A'}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-weight:600;color:#666;">Bank Name</span>
                    <span style="font-weight:600;color:#333;">${bankNameElement ? bankNameElement.textContent : 'N/A'}</span>
                </div>
            </div>
        `;
        
        resultsContent.innerHTML = html;
    }

    function showFastagBalanceError(message) {
        document.getElementById('fastagBalanceError').textContent = message;
        document.getElementById('fastagBalanceError').style.display = 'block';
    }

    function hideFastagBalanceError() {
        document.getElementById('fastagBalanceError').style.display = 'none';
    }
    function closeAddKycUserModal() {
        document.getElementById('addKycUserModal').style.display = 'none';
    }
    function lookupVehicleByFastag() {
        const fastagId = document.getElementById('kycFastagId').value.trim();
        if (!fastagId) return;
        fetch(`/api/kyc/fetch-vehicle/${encodeURIComponent(fastagId)}`)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.vehicle_number) {
                    document.getElementById('kycVehicleNumber').value = data.vehicle_number;
                } else {
                    showKycUserError(data.error || 'Vehicle not found for this FASTag ID');
                }
            })
            .catch(() => showKycUserError('Failed to fetch vehicle number'));
    }
    function lookupFastagByVehicle() {
        const vehicleNumber = document.getElementById('kycVehicleNumber').value.trim();
        if (!vehicleNumber) return;
        fetch(`/api/kyc/fetch-fastag/${encodeURIComponent(vehicleNumber)}`)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.tags && data.tags.length > 0) {
                    document.getElementById('kycFastagId').value = data.tags[0].tag_id;
                } else {
                    showKycUserError(data.error || 'FASTag not found for this vehicle number');
                }
            })
            .catch(() => showKycUserError('Failed to fetch FASTag ID'));
    }
    function showKycUserError(msg) {
        const el = document.getElementById('kycUserError');
        el.textContent = msg;
        el.style.display = 'block';
    }
    function submitAddKycUser(e) {
        e.preventDefault();
        document.getElementById('kycUserError').style.display = 'none';
        const form = document.getElementById('addKycUserForm');
        const data = {
            name: form.name.value.trim(),
            fastag_id: form.fastag_id.value.trim(),
            vehicle_number: form.vehicle_number.value.trim(),
            contact_number: form.contact_number.value.trim(),
            address: form.address.value.trim()
        };
        fetch('/api/kyc_users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                closeAddKycUserModal();
            } else {
                showKycUserError(data.error || 'Failed to add user');
            }
        })
        .catch(() => showKycUserError('Failed to add user'));
    }
    // Haptic feedback function
    function triggerHapticFeedback() {
        if ('vibrate' in navigator) {
            navigator.vibrate(10); // Short vibration for haptic feedback
        }
    }
    
    // Bottom navigation button handlers with haptic feedback
    document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            triggerHapticFeedback();
            
            // Handle specific button clicks
            if (this.innerText.trim() === 'Vehicles') {
                openKycUsersListModal();
            } else if (this.innerText.trim() === 'Analytics') {
                showAnalyticsModal();
            } else if (this.innerText.trim() === 'Reports') {
                showReportsModal();
            } else if (this.innerText.trim() === 'Action') {
                showActionModal();
            }
        });
        
        // Add hover effect for better UX
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
    function openKycUsersListModal() {
        document.getElementById('kycUsersListModal').style.display = 'flex';
        loadKycUsersList();
    }
    function closeKycUsersListModal() {
        document.getElementById('kycUsersListModal').style.display = 'none';
    }
    
    function loadKycUsersList() {
        document.getElementById('kycUsersListRecords').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Loading...</div>';
        fetch('/api/kyc_users')
            .then(r => r.json())
            .then(data => {
                let users = data.users || [];
                window._kycUsersList = users;
                document.getElementById('kycUsersListTotal').innerHTML = `All registered KYC users. <b>Total: ${users.length}</b>`;
                renderKycUsersList(users);
            })
            .catch(() => {
                document.getElementById('kycUsersListRecords').innerHTML = '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to load KYC users.</div>';
            });
    }
    
    function renderKycUsersList(users) {
        if (users.length === 0) {
            document.getElementById('kycUsersListRecords').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">No KYC users found.</div>';
            return;
        }
        
        let tableHtml = '<table style="min-width:600px;"><tr>' +
            '<th style="min-width:140px;">Name</th><th style="min-width:160px;">FASTag ID</th><th style="min-width:120px;">Vehicle</th><th style="min-width:120px;">Contact</th><th style="min-width:180px;">Address</th><th style="min-width:100px;">Role</th><th style="min-width:120px;text-align:center;">Actions</th></tr>' +
            users.map(u => `<tr>` +
                `<td style="padding: 0.5rem 0.3rem;">${u.name || 'N/A'}</td>` +
                `<td style="padding: 0.5rem 0.3rem;font-size:0.85rem;">${u.fastag_id || 'N/A'}</td>` +
                `<td style="padding: 0.5rem 0.3rem;">${u.vehicle_number || 'N/A'}</td>` +
                `<td style="padding: 0.5rem 0.3rem;">${u.contact_number || 'N/A'}</td>` +
                `<td style="padding: 0.5rem 0.3rem;font-size:0.85rem;">${u.address || 'N/A'}</td>` +
                `<td style="padding: 0.5rem 0.3rem;">${u.user_role || 'tenant'}</td>` +
                `<td style="text-align:center;padding: 0.5rem 0.3rem;"><div class="action-buttons">` +
                    `<button class="action-btn edit-btn" title="Edit" onclick="editKycUser(${u.id})"><i class="fas fa-edit"></i></button>` +
                    `<button class="action-btn delete-btn" title="Delete" onclick="deleteKycUser(${u.id})"><i class="fas fa-trash"></i></button>` +
                `</div></td>` +
            `</tr>`).join('') + '</table>';
        document.getElementById('kycUsersListRecords').innerHTML = tableHtml;
    }
    
    function toggleKycUserSearch() {
        const box = document.getElementById('kycUserSearchBox');
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
        if (box.style.display === 'block') {
            document.getElementById('kycUserSearchInput').focus();
        } else {
            filterKycUsersList('');
        }
    }
    
    function filterKycUsersList(query = '') {
        const input = document.getElementById('kycUserSearchInput');
        query = query || input.value.toLowerCase();
        const users = window._kycUsersList || [];
        
        if (!query) {
            renderKycUsersList(users);
            return;
        }
        
        const filtered = users.filter(u =>
            (u.name && u.name.toLowerCase().includes(query)) ||
            (u.vehicle_number && u.vehicle_number.toLowerCase().includes(query)) ||
            (u.fastag_id && u.fastag_id.toLowerCase().includes(query)) ||
            (u.contact_number && u.contact_number.includes(query))
        );
        
        if (filtered.length === 0) {
            document.getElementById('kycUsersListRecords').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">No users found matching your search.</div>';
        } else {
        renderKycUsersList(filtered);
        }
    }
    
    function editKycUser(id) {
        // For simplicity, open the add form prefilled for editing
        fetch(`/api/kyc_users/${id}`)
            .then(r => r.json())
            .then(data => {
                if (data.user) {
                    const user = data.user;
                    // Don't close the current modal, just open the edit modal on top
                    document.getElementById('addKycUserModal').style.display = 'flex';
                    document.getElementById('addKycUserModal').style.zIndex = '9999';
                    document.getElementById('addKycUserForm').name.value = user.name || '';
                    document.getElementById('addKycUserForm').fastag_id.value = user.fastag_id || '';
                    document.getElementById('addKycUserForm').vehicle_number.value = user.vehicle_number || '';
                    document.getElementById('addKycUserForm').contact_number.value = user.contact_number || '';
                    document.getElementById('addKycUserForm').address.value = user.address || '';
                    document.getElementById('addKycUserForm').onsubmit = function(e) {
                        e.preventDefault();
                        submitEditKycUser(id);
                    };
                }
            })
            .catch(() => alert('Failed to load user details'));
    }
    
    function submitEditKycUser(id) {
        const form = document.getElementById('addKycUserForm');
        const data = {
            name: form.name.value.trim(),
            fastag_id: form.fastag_id.value.trim(),
            vehicle_number: form.vehicle_number.value.trim(),
            contact_number: form.contact_number.value.trim(),
            address: form.address.value.trim()
        };
        fetch(`/api/kyc_users/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                closeAddKycUserModal();
                // Reset the z-index after closing
                document.getElementById('addKycUserModal').style.zIndex = '';
                loadKycUsersList();
            } else {
                alert(data.error || 'Failed to update user');
            }
        })
        .catch(() => alert('Failed to update user'));
    }
    
    function deleteKycUser(id) {
        if (!confirm('Delete this KYC user?')) return;
        fetch(`/api/kyc_users/${id}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) loadKycUsersList();
                else alert(data.error || 'Failed to delete user');
            })
            .catch(() => alert('Failed to delete user'));
    }
    
    // Locations Modal logic
    function openLocationsModal() {
        document.getElementById('locationsModal').style.display = 'flex';
        loadLocationsList();
    }
    
    function closeLocationsModal() {
        document.getElementById('locationsModal').style.display = 'none';
    }
    
    function loadLocationsList() {
        document.getElementById('locationsRecords').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Loading...</div>';
        fetch('/api/locations')
            .then(r => r.json())
            .then(data => {
                let locations = data.locations || [];
                window._locationsList = locations;
                document.getElementById('locationsTotal').innerHTML = `All locations. <b>Total: ${locations.length}</b>`;
                renderLocationsList(locations);
            })
            .catch(() => {
                document.getElementById('locationsRecords').innerHTML = '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to load locations.</div>';
            });
    }
    
    function renderLocationsList(locations) {
        if (locations.length === 0) {
            document.getElementById('locationsRecords').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">No locations found.</div>';
            return;
        }
        
        let tableHtml = '<table style="min-width:500px;"><tr>' +
            '<th>Name</th><th>Address</th><th>Edit</th><th>Delete</th></tr>' +
            locations.map(l => `<tr>` +
                `<td>${l.name}</td>` +
                `<td>${l.address}</td>` +
                `<td><button class="action-btn edit-btn" title="Edit" onclick="editLocation(${l.id})"><i class="fas fa-edit"></i></button></td>` +
                `<td><button class="action-btn delete-btn" title="Delete" onclick="deleteLocation(${l.id})"><i class="fas fa-trash"></i></button></td>` +
            `</tr>`).join('') + '</table>';
        document.getElementById('locationsRecords').innerHTML = tableHtml;
    }
    
    function toggleLocationsSearch() {
        const box = document.getElementById('locationsSearchBox');
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
        if (box.style.display === 'block') {
            document.getElementById('locationsSearchInput').focus();
        } else {
            filterLocationsList('');
        }
    }
    
    function filterLocationsList(query = '') {
        const input = document.getElementById('locationsSearchInput');
        query = query || input.value.toLowerCase();
        const locations = window._locationsList || [];
        
        if (!query) {
            renderLocationsList(locations);
            return;
        }
        
        const filtered = locations.filter(l =>
            (l.name && l.name.toLowerCase().includes(query)) ||
            (l.address && l.address.toLowerCase().includes(query))
        );
        
        if (filtered.length === 0) {
            document.getElementById('locationsRecords').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">No locations found matching your search.</div>';
        } else {
        renderLocationsList(filtered);
        }
    }
    function editLocation(id) {
        // For simplicity, open the add form prefilled for editing
        fetch(`/api/locations`)
            .then(r => r.json())
            .then(data => {
                const loc = (data.locations || []).find(l => l.id === id);
                if (loc) {
                    showAddLocationForm();
                    document.getElementById('locationName').value = loc.name;
                    document.getElementById('locationAddress').value = loc.address;
                    document.getElementById('addLocationForm').onsubmit = function(e) {
                        e.preventDefault();
                        submitEditLocation(id);
                    };
                }
            });
    }
    function submitEditLocation(id) {
        const name = document.getElementById('locationName').value.trim();
        const address = document.getElementById('locationAddress').value.trim();
        fetch(`/api/locations/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, address })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                hideAddLocationForm();
                loadLocationsList();
            } else {
                alert(data.error || 'Failed to update location');
            }
        })
        .catch(() => alert('Failed to update location'));
    }
    function deleteLocation(id) {
        if (!confirm('Delete this location?')) return;
        fetch(`/api/locations/${id}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) loadLocationsList();
                else alert(data.error || 'Failed to delete location');
            })
            .catch(() => alert('Failed to delete location'));
    }
    
    function showAddLocationForm() {
        document.getElementById('addLocationFormBox').style.display = 'block';
        document.getElementById('locationName').value = '';
        document.getElementById('locationAddress').value = '';
        document.getElementById('addLocationForm').onsubmit = function(e) {
            e.preventDefault();
            submitAddLocation(e);
        };
    }
    
    function hideAddLocationForm() {
        document.getElementById('addLocationFormBox').style.display = 'none';
    }
    
    function submitAddLocation(e) {
        e.preventDefault();
        const name = document.getElementById('locationName').value.trim();
        const address = document.getElementById('locationAddress').value.trim();
        
        fetch('/api/locations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, address })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                hideAddLocationForm();
                loadLocationsList();
            } else {
                alert(data.error || 'Failed to add location');
            }
        })
        .catch(() => alert('Failed to add location'));
    }
    
    // Push Notification Users Functions
    function openPushNotificationUsersModal() {
        document.getElementById('pushNotificationUsersModal').style.display = 'flex';
        loadPushNotificationUsersList();
    }
    
    function closePushNotificationUsersModal() {
        document.getElementById('pushNotificationUsersModal').style.display = 'none';
    }
    
    function loadPushNotificationUsersList() {
        document.getElementById('pushNotificationUsersRecords').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Loading...</div>';
        
        // Fetch FCM tokens from the database
        fetch('/api/fcm-tokens')
            .then(r => r.json())
            .then(data => {
                let users = data.tokens || [];
                window._pushNotificationUsersList = users;
                document.getElementById('pushNotificationUsersTotal').innerHTML = `All push notification users. <b>Total: ${users.length}</b>`;
                renderPushNotificationUsersList(users);
            })
            .catch(() => {
                document.getElementById('pushNotificationUsersRecords').innerHTML = '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to load push notification users.</div>';
            });
    }
    
    function renderPushNotificationUsersList(users) {
        if (users.length === 0) {
            document.getElementById('pushNotificationUsersRecords').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">No push notification users found.</div>';
            return;
        }
        
        let tableHtml = '<table style="min-width:600px;"><tr>' +
            '<th style="min-width:150px;">Name</th>' +
            '<th style="min-width:150px;">Contact</th>' +
            '<th style="min-width:120px;">Device Type</th>' +
            '<th style="min-width:80px;text-align:center;">Status</th></tr>' +
            users.map(u => `<tr>` +
                `<td style="padding: 0.5rem 0.3rem;word-wrap:break-word;">${u.name || 'N/A'}</td>` +
                `<td style="padding: 0.5rem 0.3rem;">${u.contact || 'N/A'}</td>` +
                `<td style="padding: 0.5rem 0.3rem;">${u.device_type || 'Unknown'}</td>` +
                `<td style="text-align:center;padding: 0.5rem 0.3rem;">${u.status === 'active' ? '<i class="fas fa-check-circle" style="color: #28a745; font-size: 1.2rem;"></i>' : '<i class="fas fa-times-circle" style="color: #dc3545; font-size: 1.2rem;"></i>'}</td>` +
            `</tr>`).join('') + '</table>';
        document.getElementById('pushNotificationUsersRecords').innerHTML = tableHtml;
    }
    
    function togglePushNotificationUsersSearch() {
        const box = document.getElementById('pushNotificationUsersSearchBox');
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
        if (box.style.display === 'block') {
            document.getElementById('pushNotificationUsersSearchInput').focus();
        } else {
            filterPushNotificationUsers('');
        }
    }
    
    function filterPushNotificationUsers() {
        const val = document.getElementById('pushNotificationUsersSearchInput').value.trim().toLowerCase();
        const users = window._pushNotificationUsersList || [];
        if (!val) {
            renderPushNotificationUsersList(users);
            document.getElementById('pushNotificationUsersTotal').innerHTML = `All push notification users. <b>Total: ${users.length}</b>`;
            return;
        }
        const filtered = users.filter(u =>
            (u.name && u.name.toLowerCase().includes(val)) ||
            (u.contact && u.contact.toLowerCase().includes(val)) ||
            (u.fcm_token && u.fcm_token.toLowerCase().includes(val))
        );
        renderPushNotificationUsersList(filtered);
        document.getElementById('pushNotificationUsersTotal').innerHTML = `Search results: <b>${filtered.length}</b> / ${users.length}`;
    }
    
    // QR Scanner Functions
    let qrStream = null;
    let qrVideoTrack = null;
    let flashEnabled = false;
    
    function openQRScanner() {
        document.getElementById('qrScannerModal').style.display = 'flex';
        startCamera();
    }
    
    function closeQRScanner() {
        document.getElementById('qrScannerModal').style.display = 'none';
        stopCamera();
    }
    
    async function startCamera() {
        try {
            const constraints = {
                video: {
                    facingMode: 'environment', // Use back camera
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            qrStream = await navigator.mediaDevices.getUserMedia(constraints);
            const video = document.getElementById('qrVideo');
            video.srcObject = qrStream;
            
            // Get video track for flash control
            qrVideoTrack = qrStream.getVideoTracks()[0];
            
            // Start QR code detection
            detectQRCode();
            
        } catch (error) {
            console.error('Error accessing camera:', error);
            alert('Unable to access camera. Please check permissions.');
        }
    }
    
    function stopCamera() {
        if (qrStream) {
            qrStream.getTracks().forEach(track => track.stop());
            qrStream = null;
            qrVideoTrack = null;
        }
    }
    
    function toggleFlash() {
        if (!qrVideoTrack) return;
        
        try {
            const capabilities = qrVideoTrack.getCapabilities();
            if (capabilities.torch) {
                flashEnabled = !flashEnabled;
                qrVideoTrack.applyConstraints({
                    advanced: [{ torch: flashEnabled }]
                });
                
                const flashBtn = document.getElementById('flashBtn');
                const icon = flashBtn.querySelector('i');
                const text = flashBtn.querySelector('span');
                
                if (flashEnabled) {
                    icon.className = 'fas fa-lightbulb';
                    text.textContent = 'Flash On';
                } else {
                    icon.className = 'far fa-lightbulb';
                    text.textContent = 'Flash Off';
                }
            }
        } catch (error) {
            console.error('Flash not supported:', error);
        }
    }
    
    function detectQRCode() {
        const video = document.getElementById('qrVideo');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        function scan() {
            if (video.videoWidth === 0) {
                requestAnimationFrame(scan);
                return;
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            // Use jsQR library to detect QR codes
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            
            if (code) {
                console.log("QR Code detected:", code.data);
                processQRCode(code.data);
                return; // Stop scanning once QR is found
            }
            
            requestAnimationFrame(scan);
        }
        
        scan();
    }
    
    function processQRCode(qrData) {
        try {
            // Extract FASTag ID from UPI QR format
            const fastagIdMatch = qrData.match(/&pa=netc\.([^@]+)@/);
            if (fastagIdMatch && fastagIdMatch[1]) {
                const fastagId = fastagIdMatch[1];
                
                // Fill the FASTag ID field
                document.getElementById('kycFastagId').value = fastagId;
                
                // Show success message
                document.getElementById('scanResult').style.display = 'block';
                
                // Auto-fetch vehicle number
                lookupVehicleByFastag();
                
                // Close scanner after 2 seconds
                setTimeout(() => {
                    closeQRScanner();
                }, 2000);
                
            } else {
                alert('Invalid QR code format. Please scan a valid FASTag QR code.');
            }
        } catch (error) {
            console.error('Error processing QR code:', error);
            alert('Error processing QR code. Please try again.');
        }
    }
    
    function clearKycForm() {
        // Clear all form fields
        document.getElementById('kycName').value = '';
        document.getElementById('kycFastagId').value = '';
        document.getElementById('kycVehicleNumber').value = '';
        document.getElementById('kycContactNumber').value = '';
        document.getElementById('kycAddress').value = '';
        
        // Hide any error messages
        const errorDiv = document.getElementById('kycUserError');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
        
        // Show success message
        showNotification('Form cleared successfully!', 'success');
    }
    
    // Modify the existing showAddKycUserModal function to clear form on open
    function showAddKycUserModal() {
        document.getElementById('addKycUserModal').style.display = 'flex';
        // Clear form when opening
        clearKycForm();
    }
    // Lanes Modal logic
    function openLanesModal() {
        document.getElementById('lanesModal').style.display = 'flex';
        loadLanesList();
    }
    function closeLanesModal() {
        document.getElementById('lanesModal').style.display = 'none';
    }
    function loadLanesList() {
        document.getElementById('lanesRecords').innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Loading...</div>';
        fetch('/api/lanes')
            .then(r => r.json())
            .then(data => {
                let lanes = data.lanes || [];
                window._lanesList = lanes;
                document.getElementById('lanesTotal').innerHTML = `All lanes. <b>Total: ${lanes.length}</b>`;
                renderLanesList(lanes);
            })
            .catch(() => {
                document.getElementById('lanesRecords').innerHTML = '<div style="text-align:center;color:#dc3545;padding:0.7rem;">Failed to load lanes.</div>';
            });
    }
    function renderLanesList(lanes) {
        let tableHtml = '<table style="min-width:500px;"><tr>' +
            '<th>Name</th><th>Location ID</th><th>Edit</th><th>Delete</th></tr>' +
            lanes.map(l => `<tr>` +
                `<td>${l.lane_name}</td>` +
                `<td>${l.location_id}</td>` +
                `<td><button class=\"input-icon-btn kyc-edit-btn\" title=\"Edit\" onclick=\"editLane(${l.id})\"><i class=\"fas fa-edit\"></i></button></td>` +
                `<td><button class=\"input-icon-btn kyc-delete-btn\" title=\"Delete\" onclick=\"deleteLane(${l.id})\"><i class=\"fas fa-trash\"></i></button></td>` +
            `</tr>`).join('') + '</table>';
        document.getElementById('lanesRecords').innerHTML = tableHtml;
    }
    function toggleLanesSearch() {
        const box = document.getElementById('lanesSearchBox');
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
        if (box.style.display === 'block') {
            document.getElementById('lanesSearchInput').focus();
        } else {
            filterLanesList('');
        }
    }
    function filterLanesList() {
        const val = document.getElementById('lanesSearchInput').value.trim().toLowerCase();
        const lanes = window._lanesList || [];
        if (!val) {
            renderLanesList(lanes);
            document.getElementById('lanesTotal').innerHTML = `All lanes. <b>Total: ${lanes.length}</b>`;
            return;
        }
        const filtered = lanes.filter(l =>
            (l.lane_name && l.lane_name.toLowerCase().includes(val))
        );
        renderLanesList(filtered);
        document.getElementById('lanesTotal').innerHTML = `Search results: <b>${filtered.length}</b> / ${lanes.length}`;
    }
    function showAddLaneForm() {
        document.getElementById('addLaneFormBox').style.display = 'block';
    }
    function hideAddLaneForm() {
        document.getElementById('addLaneFormBox').style.display = 'none';
    }
    function submitAddLane(e) {
        e.preventDefault();
        const lane_name = document.getElementById('laneName').value.trim();
        const location_id = document.getElementById('laneLocationId').value.trim();
        fetch('/api/lanes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lane_name, location_id })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                hideAddLaneForm();
                loadLanesList();
            } else {
                alert(data.error || 'Failed to add lane');
            }
        })
        .catch(() => alert('Failed to add lane'));
    }
    function editLane(id) {
        // For simplicity, open the add form prefilled for editing
        fetch(`/api/lanes`)
            .then(r => r.json())
            .then(data => {
                const lane = (data.lanes || []).find(l => l.id === id);
                if (lane) {
                    showAddLaneForm();
                    document.getElementById('laneName').value = lane.lane_name;
                    document.getElementById('laneLocationId').value = lane.location_id;
                    document.getElementById('addLaneForm').onsubmit = function(e) {
                        e.preventDefault();
                        submitEditLane(id);
                    };
                }
            });
    }
    function submitEditLane(id) {
        const lane_name = document.getElementById('laneName').value.trim();
        const location_id = document.getElementById('laneLocationId').value.trim();
        fetch(`/api/lanes/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lane_name, location_id })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                hideAddLaneForm();
                loadLanesList();
            } else {
                alert(data.error || 'Failed to update lane');
            }
        })
        .catch(() => alert('Failed to update lane'));
    }
    function deleteLane(id) {
        if (!confirm('Delete this lane?')) return;
        fetch(`/api/lanes/${id}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) loadLanesList();
                else alert(data.error || 'Failed to delete lane');
            })
            .catch(() => alert('Failed to delete lane'));
    }

    const vapidPublicKey = "BBhJJqcUv78-jqu4hjXSrEYwg9uFY3CkB7Ma72FIAIgeh6jUn5ymBiUSTqLAKc0yEs5k_MMi04xi4pTtFR_Ur0Q";
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');
      const rawData = window.atob(base64);
      return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }
    if ('serviceWorker' in navigator && 'PushManager' in window) {
      navigator.serviceWorker.ready.then(function(reg) {
        reg.pushManager.getSubscription().then(function(sub) {
          if (!sub) {
            reg.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
            }).then(function(subscription) {
              fetch('/api/save-subscription', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(subscription)
              });
            });
          } else {
            fetch('/api/save-subscription', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(sub)
            });
          }
        });
      });
    }

    function subscribeForPushNotifications() {
      alert('Step 1: Start');
      const vapidPublicKey = "BBhJJqcUv78-jqu4hjXSrEYwg9uFY3CkB7Ma72FIAIgeh6jUn5ymBiUSTqLAKc0yEs5k_MMi04xi4pTtFR_Ur0Q";
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
          .replace(/-/g, '+')
          .replace(/_/g, '/');
        const rawData = window.atob(base64);
        return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
      }
      if ('serviceWorker' in navigator && 'PushManager' in window) {
        alert('Step 2: Service worker and PushManager available');
        navigator.serviceWorker.ready.then(function(reg) {
          alert('Step 3: Service worker ready');
          reg.pushManager.getSubscription().then(function(sub) {
            alert('Step 4: Got subscription object');
            if (!sub) {
              alert('Step 5: Not subscribed, subscribing now');
              reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
              }).then(function(subscription) {
                alert('Step 6: Subscribed, sending to backend');
                fetch('/api/save-subscription', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(subscription)
                }).then(() => {
                  alert('Step 7: Subscription sent to backend!');
                  showPushStatusMsg('Push notifications enabled!');
                  document.getElementById('enablePushContainer').style.display = 'none';
                }).catch(() => {
                  alert('Step 8: Failed to save subscription.');
                  showPushStatusMsg('Failed to save subscription.');
                });
              }).catch(function(err) {
                alert('Step 9: Permission denied or error: ' + err.message);
                showPushStatusMsg('Permission denied or error: ' + err.message);
              });
            } else {
              alert('Step 10: Already subscribed, sending to backend');
              fetch('/api/save-subscription', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sub)
              }).then(() => {
                alert('Step 11: Existing subscription sent to backend!');
                showPushStatusMsg('Push notifications already enabled.');
                document.getElementById('enablePushContainer').style.display = 'none';
              });
            }
          }).catch(function(err) {
            alert('Step 12: Error getting subscription: ' + err.message);
          });
        }).catch(function(err) {
          alert('Step 13: Service worker not ready: ' + err.message);
        });
      } else {
        alert('Step 14: Push notifications not supported in this browser.');
        showPushStatusMsg('Push notifications not supported in this browser.');
      }
    }
    function showPushStatusMsg(msg) {
      var el = document.getElementById('pushStatusMsg');
      if (el) {
        el.textContent = msg;
        el.style.display = 'block';
      }
    }
    
    // On load, check if already subscribed and hide button if so
    if ('serviceWorker' in navigator && 'PushManager' in window) {
      navigator.serviceWorker.ready.then(function(reg) {
        reg.pushManager.getSubscription().then(function(sub) {
          if (sub) {
            showPushStatusMsg('Push notifications already enabled.');
            document.getElementById('enablePushContainer').style.display = 'none';
          }
        });
      });
    }
    document.addEventListener('DOMContentLoaded', function() {
      var btn = document.getElementById('enablePushBtn');
      if (btn) {
        btn.onclick = subscribeUserToPush;
      }
    });

    // Watchlist Modal
    function openWatchlistModal() {
      document.getElementById('watchlistModal').style.display = 'flex';
      loadWatchlistData();
    }
    function closeWatchlistModal() {
      document.getElementById('watchlistModal').style.display = 'none';
    }
    function loadWatchlistData() {
      document.getElementById('watchlistKycTbody').innerHTML = '<tr><td colspan="8" style="text-align:center;color:#aaa;">Loading...</td></tr>';
      document.getElementById('watchlistNonuserTbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#aaa;">Loading...</td></tr>';
      fetch('/api/watchlist/list')
        .then(res => res.json())
        .then(data => renderWatchlistTables(data.results));
    }
    function renderWatchlistTables(data) {
      const kyc = data.filter(u => u.type === 'Registered');
      const nonuser = data.filter(u => u.type === 'Non-User');
      // KYC Table
      const kycTbody = document.getElementById('watchlistKycTbody');
      if (!kyc.length) {
        kycTbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#aaa;">No registered KYC users on the watchlist.</td></tr>';
      } else {
        kycTbody.innerHTML = kyc.map(user => `
          <tr data-id="${user.id}">
            <td>${user.name || '<span style=\'color:#aaa;\'>-</span>'}</td>
            <td>${user.fastag_id}</td>
            <td>${user.vehicle_number || '<span style=\'color:#aaa;\'>-</span>'}</td>
            <td>${user.contact_number || '<span style=\'color:#aaa;\'>-</span>'}</td>
            <td>${user.address || '<span style=\'color:#aaa;\'>-</span>'}</td>
            <td>${user.reason || '<span style=\'color:#aaa;\'>-</span>'}</td>
            <td>${toIST(user.added_at)}</td>
            <td>
              <button class="input-icon-btn kyc-edit-btn" title="View History" onclick="openWatchlistActivityModal(${user.id})"><i class="fas fa-history"></i></button>
              <button class="input-icon-btn kyc-edit-btn" title="Edit Reason" onclick="openEditWatchlistReasonModal(${user.id}, '${user.reason ? user.reason.replace(/'/g, '\\&#39;') : ''}')"><i class="fas fa-edit"></i></button>
              <button class="input-icon-btn kyc-delete-btn" title="Delete" onclick="deleteWatchlistUser(${user.id})"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
      }
      // Non-User Table
      const nonuserTbody = document.getElementById('watchlistNonuserTbody');
      if (!nonuser.length) {
        nonuserTbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#aaa;">No non-user vehicles on the watchlist.</td></tr>';
      } else {
        nonuserTbody.innerHTML = nonuser.map(user => `
          <tr data-id="${user.id}">
            <td>${user.fastag_id}</td>
            <td>${user.reason || '<span style=\'color:#aaa;\'>-</span>'}</td>
            <td>${toIST(user.added_at)}</td>
            <td>
              <button class="input-icon-btn kyc-edit-btn" title="Edit Reason" onclick="openEditWatchlistReasonModal(${user.id}, '${user.reason ? user.reason.replace(/'/g, '\\&#39;') : ''}')"><i class="fas fa-edit"></i></button>
              <button class="input-icon-btn kyc-delete-btn" title="Delete" onclick="deleteWatchlistUser(${user.id})"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
      }
    }
    function showAddWatchlistModal(type) {
      document.getElementById('addWatchlistModal').style.display = 'flex';
      document.getElementById('addWatchlistKycRow').style.display = type === 'kyc' ? 'block' : 'none';
      document.getElementById('addWatchlistNonuserRow').style.display = type === 'nonuser' ? 'block' : 'none';
      document.getElementById('addWatchlistModalTitle').textContent = type === 'kyc' ? 'Add KYC User to Watchlist' : 'Add Non-User to Watchlist';
    }
    function closeAddWatchlistModal() {
      document.getElementById('addWatchlistModal').style.display = 'none';
    }
    function submitAddWatchlist(e) {
      e.preventDefault();
      const isKyc = document.getElementById('addWatchlistKycRow').style.display === 'block';
      const fastag_id = isKyc ? document.getElementById('addWatchlistKycFastag').value : document.getElementById('addWatchlistNonuserFastag').value;
      const reason = document.getElementById('addWatchlistReason').value;
      fetch('/api/watchlist/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(isKyc ? { fastag_id, reason } : { fastag_id, reason })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          closeAddWatchlistModal();
          loadWatchlistData();
        } else {
          alert('Failed to add to watchlist: ' + (data.error || 'Unknown error'));
        }
      });
    }
    function openEditWatchlistReasonModal(id, reason) {
      document.getElementById('editWatchlistReasonModal').style.display = 'flex';
      document.getElementById('editWatchlistReasonId').value = id;
      document.getElementById('editWatchlistReasonInput').value = reason;
    }
    function closeEditWatchlistReasonModal() {
      document.getElementById('editWatchlistReasonModal').style.display = 'none';
    }
    function submitEditWatchlistReason(e) {
      e.preventDefault();
      const id = document.getElementById('editWatchlistReasonId').value;
      const reason = document.getElementById('editWatchlistReasonInput').value;
      fetch(`/api/watchlist/edit/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          closeEditWatchlistReasonModal();
          loadWatchlistData();
        } else {
          alert('Failed to update reason.');
        }
      });
    }
    function deleteWatchlistUser(id) {
      if (!confirm('Delete this user/vehicle from the watchlist?')) return;
      fetch(`/api/watchlist/delete/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          if (data.success) loadWatchlistData();
          else alert('Failed to delete.');
        });
    }
    function toIST(utcString) {
      if (!utcString) return '-';
      let utcDate;
      if (utcString.includes('T')) {
        utcDate = new Date(utcString.endsWith('Z') ? utcString : utcString + 'Z');
      } else {
        utcDate = new Date(utcString.replace(' ', 'T') + 'Z');
      }
      if (isNaN(utcDate.getTime())) return utcString;
      return utcDate.toLocaleString('en-GB', { timeZone: 'Asia/Kolkata' }).replace(',', '');
    }
    // Eye icon click handler
    function openWatchlistFromIcon() {
      openWatchlistModal();
    }
    // Watchlist KYC User Autocomplete
    const kycSearchInput = document.getElementById('addWatchlistKycSearch');
    const kycSuggestions = document.getElementById('addWatchlistKycSuggestions');
    const kycFastagInput = document.getElementById('addWatchlistKycFastag');
    let kycSearchTimer = null;
    if (kycSearchInput) {
      kycSearchInput.addEventListener('input', function() {
        const q = this.value.trim();
        kycSuggestions.innerHTML = '';
        kycFastagInput.value = '';
        if (q.length < 2) return;
        clearTimeout(kycSearchTimer);
        kycSearchTimer = setTimeout(() => {
          fetch(`/analytics/api/search-kyc-users?q=${encodeURIComponent(q)}`)
            .then(res => res.json())
            .then(data => {
              if (!data.results.length) {
                kycSuggestions.innerHTML = '<div class="list-group-item text-muted">No matches found</div>';
                return;
              }
              kycSuggestions.innerHTML = data.results.map(u =>
                `<button type="button" class="list-group-item list-group-item-action" data-id="${u.fastag_id}" data-name="${u.name}" data-veh="${u.vehicle_number}">
                    ${u.fastag_id} | ${u.name} | ${u.vehicle_number}
                </button>`
              ).join('');
            });
        }, 200);
      });
      kycSuggestions.addEventListener('click', function(e) {
        if (e.target && e.target.matches('button[data-id]')) {
          kycFastagInput.value = e.target.getAttribute('data-id');
          kycSearchInput.value = `${e.target.getAttribute('data-name')} | ${e.target.getAttribute('data-veh')}`;
          kycSuggestions.innerHTML = '';
        }
      });
      kycSearchInput.addEventListener('blur', function() {
        setTimeout(() => { kycSuggestions.innerHTML = ''; }, 200);
      });
    }
    // Activity History Modal for Watchlist
    function openWatchlistActivityModal(id) {
      document.getElementById('watchlistActivityModal').style.display = 'flex';
      const content = document.getElementById('watchlistActivityContent');
      content.innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">Loading...</div>';
      fetch(`/api/watchlist/activity/${id}`)
        .then(res => res.json())
        .then(data => {
          if (!data.results || !data.results.length) {
            content.innerHTML = '<div style="text-align:center;color:#aaa;padding:0.7rem;">No activity found for this user/vehicle.</div>';
            return;
          }
          const rows = data.results.map(log => `
            <tr>
              <td>${toIST(log.timestamp)}</td>
              <td>${log.lane_name || log.lane_id}</td>
              <td>${log.lane_type ? log.lane_type.charAt(0).toUpperCase() + log.lane_type.slice(1) : '-'}</td>
              <td>${log.access_result}</td>
              <td>${log.reason || '-'}</td>
            </tr>
          `).join('');
          content.innerHTML = `
            <table style="width:100%;min-width:400px;font-size:0.9em;">
              <thead><tr><th>Timestamp (IST)</th><th>Lane</th><th>Type</th><th>Result</th><th>Reason</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          `;
        });
    }
    function closeWatchlistActivityModal() {
      document.getElementById('watchlistActivityModal').style.display = 'none';
    }
    </script>
    <!-- Watchlist Modal -->
    <div id="watchlistModal" class="modal-custom" style="display:none;">
      <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
        <span class="close-modal" onclick="closeWatchlistModal()">&times;</span>
        <div class="modal-header-custom">
          <span class="modal-icon"><i class="fas fa-eye"></i></span>
          <span class="modal-title">Watchlist</span>
        </div>
        <div class="modal-desc">Registered KYC Users and Non-User Vehicles on the watchlist.</div>
        <div style="display:flex;gap:1em;margin-bottom:0.7em;">
          <button class="modal-close-btn" onclick="showAddWatchlistModal('kyc')"><i class="fas fa-user-plus"></i> Add KYC User</button>
          <button class="modal-close-btn" onclick="showAddWatchlistModal('nonuser')"><i class="fas fa-car"></i> Add Non-User</button>
        </div>
        <div style="overflow-x:auto;max-height:30vh;overflow-y:auto;margin-bottom:0.7em;">
          <div style="font-weight:600;color:#764ba2;margin-bottom:0.3em;">Registered KYC Users</div>
          <table style="min-width:700px;font-size:0.93em;">
            <thead><tr><th>Name</th><th>FASTag ID</th><th>Vehicle</th><th>Contact</th><th>Address</th><th>Reason</th><th>Added</th><th>Actions</th></tr></thead>
            <tbody id="watchlistKycTbody"><tr><td colspan="8" style="text-align:center;color:#aaa;">Loading...</td></tr></tbody>
          </table>
        </div>
        <div style="overflow-x:auto;max-height:30vh;overflow-y:auto;">
          <div style="font-weight:600;color:#764ba2;margin-bottom:0.3em;">Non-User Vehicles</div>
          <table style="min-width:500px;font-size:0.93em;">
            <thead><tr><th>FASTag ID</th><th>Reason</th><th>Added</th><th>Actions</th></tr></thead>
            <tbody id="watchlistNonuserTbody"><tr><td colspan="4" style="text-align:center;color:#aaa;">Loading...</td></tr></tbody>
          </table>
        </div>
        <div class="modal-footer-custom" style="justify-content: flex-end;">
          <button class="modal-close-btn" onclick="closeWatchlistModal()">Close</button>
        </div>
      </div>
    </div>
    <!-- Add/Edit Watchlist Modal (reused for both types) -->
    <div id="addWatchlistModal" class="modal-custom" style="display:none;">
      <div class="modal-content-custom" style="max-width: 350px;">
        <span class="close-modal" onclick="closeAddWatchlistModal()">&times;</span>
        <div class="modal-header-custom">
          <span class="modal-icon"><i class="fas fa-user-plus"></i></span>
          <span class="modal-title" id="addWatchlistModalTitle">Add to Watchlist</span>
        </div>
        <form id="addWatchlistForm" onsubmit="submitAddWatchlist(event)">
          <div class="mb-2" id="addWatchlistKycRow" style="display:none;position:relative;">
            <label class="form-label">Search KYC User (name or vehicle number)</label>
            <input type="text" class="form-control" id="addWatchlistKycSearch" autocomplete="off" placeholder="Type name or vehicle number...">
            <div id="addWatchlistKycSuggestions" class="list-group position-absolute w-100" style="z-index: 1051;"></div>
            <input type="hidden" id="addWatchlistKycFastag" required>
          </div>
          <div class="mb-2" id="addWatchlistNonuserRow" style="display:none;">
            <label class="form-label">FASTag ID (Non-User)</label>
            <input type="text" class="form-control" id="addWatchlistNonuserFastag" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Reason</label>
            <input type="text" class="form-control" id="addWatchlistReason">
          </div>
          <div class="modal-footer-custom" style="justify-content: flex-end;">
            <button class="modal-close-btn" type="button" onclick="closeAddWatchlistModal()">Cancel</button>
            <button class="modal-close-btn" type="submit" style="background:linear-gradient(90deg,#764ba2 0%,#ffe082 100%);color:#fff;">Add</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Reports Modal -->
    <div id="reportsModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
            <span class="close-modal" onclick="closeReportsModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-file-alt"></i></span>
                <span class="modal-title">Reports & Exports</span>
            </div>
            <div class="modal-desc">Generate and download detailed reports</div>
            
            <!-- Reports Content -->
            <div id="reportsContent" class="reports-content">
                <!-- Reports will be loaded here -->
            </div>
            
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeReportsModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Report Generator Modal -->
    <div id="reportGeneratorModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 500px;">
            <span class="close-modal" onclick="closeReportGeneratorModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-download"></i></span>
                <span class="modal-title" id="reportGeneratorTitle">Generate Report</span>
            </div>
            <div class="modal-desc" id="reportGeneratorDesc">Select date range and generate report</div>
            
            <form id="reportGeneratorForm" onsubmit="generateReport(event)">
                <div class="mb-2">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="reportStartDate" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="reportEndDate" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Report Type</label>
                    <input type="hidden" id="reportType" required>
                    <div class="form-control" style="background: #f8f9fa; color: #495057; padding: 0.5rem; border-radius: 0.375rem;" id="reportTypeDisplay"></div>
                </div>
                
                <div class="modal-footer-custom" style="justify-content: space-between; gap: 0.5rem;">
                    <button class="modal-close-btn" type="button" onclick="closeReportGeneratorModal()">Cancel</button>
                    <button class="modal-close-btn" type="submit" style="background:linear-gradient(90deg,#764ba2 0%,#ffe082 100%);color:#fff;">Generate Report</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Share Report Modal -->
    <div id="shareReportModal" class="modal-custom" style="display:none;">
        <div class="modal-content-custom" style="max-width: 300px;">
            <span class="close-modal" onclick="closeShareReportModal()">&times;</span>
            <div class="modal-header-custom">
                <span class="modal-icon"><i class="fas fa-share-alt"></i></span>
                <span class="modal-title">Share Report</span>
            </div>
            <div class="modal-desc" id="shareReportDesc">Choose how to share this report</div>
            
            <div class="share-options-grid-compact">
                <button class="share-option-btn-compact" onclick="shareViaWhatsApp()">
                    <div class="share-option-icon-compact whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    <div class="share-option-label-compact">WhatsApp</div>
                </button>
                
                <button class="share-option-btn-compact" onclick="shareViaEmail()">
                    <div class="share-option-icon-compact email">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="share-option-label-compact">Email</div>
                </button>
            </div>
            
            <div class="modal-footer-custom" style="justify-content: flex-end;">
                <button class="modal-close-btn" onclick="closeShareReportModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Reason Modal -->
    <div id="editWatchlistReasonModal" class="modal-custom" style="display:none;">
      <div class="modal-content-custom" style="max-width: 350px;">
        <span class="close-modal" onclick="closeEditWatchlistReasonModal()">&times;</span>
        <div class="modal-header-custom">
          <span class="modal-icon"><i class="fas fa-edit"></i></span>
          <span class="modal-title">Edit Reason</span>
        </div>
        <form id="editWatchlistReasonForm" onsubmit="submitEditWatchlistReason(event)">
          <input type="hidden" id="editWatchlistReasonId">
          <div class="mb-2">
            <label class="form-label">Reason</label>
            <input type="text" class="form-control" id="editWatchlistReasonInput" required>
          </div>
          <div class="modal-footer-custom" style="justify-content: flex-end;">
            <button class="modal-close-btn" type="button" onclick="closeEditWatchlistReasonModal()">Cancel</button>
            <button class="modal-close-btn" type="submit" style="background:linear-gradient(90deg,#764ba2 0%,#ffe082 100%);color:#fff;">Save</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Activity History Modal for Watchlist -->
    <div id="watchlistActivityModal" class="modal-custom" style="display:none;">
      <div class="modal-content-custom" style="max-width: 98vw; min-width: 340px;">
        <span class="close-modal" onclick="closeWatchlistActivityModal()">&times;</span>
        <div class="modal-header-custom">
          <span class="modal-icon"><i class="fas fa-history"></i></span>
          <span class="modal-title">Activity History</span>
        </div>
        <div class="modal-desc">Recent access activity for this user/vehicle.</div>
        <div class="modal-records" id="watchlistActivityContent" style="min-height:80px;max-height:50vh;overflow:auto;"></div>
        <div class="modal-footer-custom" style="justify-content: flex-end;">
          <button class="modal-close-btn" onclick="closeWatchlistActivityModal()">Close</button>
        </div>
      </div>
    </div>
    <!-- Push Notification Enable Button -->
    <button id="enablePushBtn" title="Enable Push Notifications" style="position:fixed;top:1.2rem;right:1.2rem;z-index:3000;background:linear-gradient(135deg,#764ba2 0%,#ffe082 100%);color:#fff;padding:0.6rem 0.7rem;border:none;border-radius:50%;box-shadow:0 2px 8px rgba(80,80,160,0.10);font-size:1.3rem;display:flex;align-items:center;justify-content:center;cursor:pointer;"><i class="fas fa-bell"></i></button>

    <!-- Push Notification Success Modal -->
    <div id="pushSuccessModal" class="modal-custom" style="display:none;z-index:4000;">
      <div class="modal-content-custom" style="max-width: 320px; text-align: center;">
        <span class="close-modal" onclick="closePushSuccessModal()">&times;</span>
        <div class="modal-header-custom" style="justify-content: center;">
          <span class="modal-icon"><i class="fas fa-bell"></i></span>
          <span class="modal-title">Push Enabled!</span>
        </div>
        <div class="modal-desc">Push notifications are now enabled for this device.</div>
        <div class="modal-footer-custom" style="justify-content: center;">
          <button class="modal-close-btn" onclick="closePushSuccessModal()">OK</button>
        </div>
      </div>
    </div>

    <!-- Push Notification Received Modal -->
    <div id="pushReceivedModal" class="modal-custom" style="display:none;z-index:4000;">
      <div class="modal-content-custom" style="max-width: 340px; text-align: center;">
        <span class="close-modal" onclick="closePushReceivedModal()">&times;</span>
        <div class="modal-header-custom" style="justify-content: center;">
          <span class="modal-icon"><i class="fas fa-bell"></i></span>
          <span class="modal-title" id="pushReceivedTitle">Notification</span>
        </div>
        <div class="modal-desc" id="pushReceivedBody">You have a new notification.</div>
        <div class="modal-footer-custom" style="justify-content: center;">
          <button class="modal-close-btn" onclick="closePushReceivedModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- Push Notification Error Modal -->
    <div id="pushErrorModal" class="modal-custom" style="display:none;z-index:4000;">
      <div class="modal-content-custom" style="max-width: 400px; text-align: center;">
        <span class="close-modal" onclick="closePushErrorModal()">&times;</span>
        <div class="modal-header-custom" style="justify-content: center;">
          <span class="modal-icon" style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i></span>
          <span class="modal-title" style="color: #dc3545;">Error</span>
        </div>
        <div class="modal-desc" id="pushErrorBody">An error occurred while enabling push notifications.</div>
        <div class="modal-footer-custom" style="justify-content: center;">
          <button class="modal-close-btn" onclick="closePushErrorModal()" style="background: #dc3545; color: white;">OK</button>
        </div>
      </div>
    </div>

    <script>
    function showPushSuccessModal() {
      document.getElementById('pushSuccessModal').style.display = 'flex';
    }
    function closePushSuccessModal() {
      document.getElementById('pushSuccessModal').style.display = 'none';
    }
    function showPushReceivedModal(title, body) {
      document.getElementById('pushReceivedTitle').textContent = title || 'Notification';
      document.getElementById('pushReceivedBody').textContent = body || 'You have a new notification.';
      document.getElementById('pushReceivedModal').style.display = 'flex';
    }
    function closePushReceivedModal() {
      document.getElementById('pushReceivedModal').style.display = 'none';
    }
    function showPushErrorModal(message) {
      document.getElementById('pushErrorBody').textContent = message || 'An error occurred while enabling push notifications.';
      document.getElementById('pushErrorModal').style.display = 'flex';
    }
    function closePushErrorModal() {
      document.getElementById('pushErrorModal').style.display = 'none';
    }

    // Replace enablePushBtn click handler
    const enablePushBtn = document.getElementById('enablePushBtn');
    if (enablePushBtn) {
      enablePushBtn.onclick = async function() {
        try {
          await subscribeUserToPush();
          showPushSuccessModal();
        } catch (e) {
          showPushErrorModal('Error enabling push notifications: ' + (e && e.message ? e.message : e));
        }
      };
    }


    </script>
    <!-- END PUSH NOTIFICATION -->
    <!-- Add Firebase SDKs for FCM -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
    <script>
    // TODO: Replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "AIzaSyCHHIovN0SCj7DTuCni2NY1IsCSIRRgFnE",
      authDomain: "pwapush-4e4e4.firebaseapp.com",
      projectId: "pwapush-4e4e4",
      storageBucket: "pwapush-4e4e4.firebasestorage.app",
      messagingSenderId: "876451632085",
      appId: "1:876451632085:web:bf98d777d19e45bb00e35c",
      measurementId: "G-P6EVG2YPTR"
    };
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    async function subscribeUserToPush() {
      try {
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          showPushErrorModal('You must allow notifications to enable push notifications!');
          return;
        }
        // Get FCM token
        const fcmToken = await messaging.getToken({ vapidKey: undefined });
        if (!fcmToken) {
          showPushErrorModal('Failed to get FCM token. Please try again.');
          return;
        }
        // Send token to backend
        const response = await fetch('/pwa-dashboard/api/save-fcm-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: fcmToken })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          const errorMessage = errorData.error || errorData.details || `Server error (${response.status})`;
          showPushErrorModal('Failed to save FCM token: ' + errorMessage);
          return;
        }
        
        const result = await response.json();
        if (result.success) {
          showPushSuccessModal();
        } else {
          showPushErrorModal(result.error || 'Failed to enable push notifications');
        }
      } catch (error) {
        showPushErrorModal('Error enabling push notifications: ' + error.message);
      }
    }

    document.getElementById('enablePushBtn').onclick = subscribeUserToPush;

    // Handle foreground messages
    messaging.onMessage(function(payload) {
      const title = payload.notification && payload.notification.title ? payload.notification.title : 'Onebee Parking';
      const body = payload.notification && payload.notification.body ? payload.notification.body : '';
      showPushReceivedModal(title, body);
    });
    </script>
    <!-- Firebase Messaging service worker registration moved to cleanup script -->
    <script>
    // Aggressively unregister all service workers except firebase-messaging-sw.js to prevent duplicate notifications
    if ('serviceWorker' in navigator) {
      // First, unregister all existing service workers
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        console.log('Found', registrations.length, 'service workers');
        registrations.forEach(function(registration) {
          console.log('Checking service worker:', registration.active ? registration.active.scriptURL : 'inactive');
          // Unregister all except the root firebase-messaging-sw.js
          if (!registration.active || !registration.active.scriptURL.includes('firebase-messaging-sw.js') || registration.active.scriptURL.includes('/static/')) {
            console.log('Unregistering service worker:', registration.active ? registration.active.scriptURL : 'inactive');
            registration.unregister().then(function() {
              console.log('Service worker unregistered successfully');
            }).catch(function(error) {
              console.error('Failed to unregister service worker:', error);
            });
          }
        });
      });
      
      // Then, ensure only the correct firebase-messaging-sw.js is registered
      setTimeout(function() {
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
          .then(function(reg) {
            console.log('Firebase Messaging Service Worker registered at root:', reg);
          })
          .catch(function(err) {
            console.error('Service Worker registration failed:', err);
          });
      }, 1000);
    }
    </script>
</body>
</html> 