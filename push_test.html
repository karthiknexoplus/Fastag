<!DOCTYPE html>
<html>
<head>
  <title>PWA Push Test</title>
</head>
<body>
  <h2>PWA Push Test</h2>
  <button id="enablePushBtn">Enable Notifications</button>
  <div id="status"></div>
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw_test.js').then(function(reg) {
        document.getElementById('status').innerText = 'Service worker registered!';
      }).catch(function(err) {
        document.getElementById('status').innerText = 'SW registration failed: ' + err;
      });
    } else {
      document.getElementById('status').innerText = 'Service worker not supported!';
    }

    // Push subscription logic
    document.getElementById('enablePushBtn').onclick = function() {
      const vapidPublicKey = "BBhJJqcUv78-jqu4hjXSrEYwg9uFY3CkB7Ma72FIAIgeh6jUn5ymBiUSTqLAKc0yEs5k_MMi04xi4pTtFR_Ur0Q";
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
          .replace(/-/g, '+')
          .replace(/_/g, '/');
        const rawData = window.atob(base64);
        return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
      }
      if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker.ready.then(function(reg) {
          reg.pushManager.getSubscription().then(function(sub) {
            if (!sub) {
              reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
              }).then(function(subscription) {
                document.getElementById('status').innerText = 'Subscribed! ' + JSON.stringify(subscription);
                fetch('/api/save-subscription', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(subscription)
                });
              }).catch(function(err) {
                document.getElementById('status').innerText = 'Subscription error: ' + err.message;
              });
            } else {
              document.getElementById('status').innerText = 'Already subscribed!';
              fetch('/api/save-subscription', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sub)
              });
            }
          });
        });
      } else {
        document.getElementById('status').innerText = 'Push not supported!';
      }
    };
  </script>
</body>
</html> 